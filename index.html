<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RecargApp</title>

  <!-- PWA -->
  <link rel="manifest" href="/RecargApp/manifest.json">
  <meta name="theme-color" content="#0b1223" />

  <!-- iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="/RecargApp/icons/icon-192x192.png">

  <style>
    :root{
      --bg:#0f172a;--card:#111827;--muted:#94a3b8;--ok:#16a34a;--warn:#f59e0b;--err:#ef4444;--ink:#e5e7eb;--accent:#38bdf8;
      --line:#1f2937;--btn:#0b1223;--brand:#1463d6;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui, Segoe UI, Roboto, Helvetica, Arial}
    a{color:inherit}
    /* Header */
    header{position:sticky;top:0;z-index:5;background:#0b1223;border-bottom:1px solid var(--line)}
    .bar{max-width:1150px;margin:0 auto;padding:10px 12px;display:grid;grid-template-columns:120px 1fr 220px;gap:8px;align-items:center}
    .brand{display:flex;align-items:center;gap:10px;justify-content:flex-start}
    .brand img{width:28px;height:28px;border-radius:6px;object-fit:cover}
    .titleWrap{display:flex;justify-content:center}
    .title{margin:0;font-size:22px;letter-spacing:.4px}
    .actions{display:flex;justify-content:flex-end;gap:8px;align-items:center}
    .role{font-size:12px;color:var(--muted)}
    .btn{background:var(--btn);border:1px solid var(--line);color:#d1d5db;border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#1f6feb,#1463d6);border:0;color:#fff}
    .btn.warn{background:linear-gradient(180deg,#f59e0b,#d97706);border:0;color:#fff}
    .btn.danger{background:linear-gradient(180deg,#ef4444,#dc2626);border:0;color:#fff}
    .tabs{max-width:1150px;margin:0 auto 8px;display:flex;gap:6px;justify-content:center;flex-wrap:wrap;padding:0 12px}
    .tab{background:var(--btn);border:1px solid var(--line);color:var(--muted);padding:6px 10px;border-radius:10px;cursor:pointer}
    .tab.active{color:#fff;border-color:#2563eb;background:linear-gradient(180deg,#1f6feb,#1463d6)}
    main{padding:10px;max-width:1150px;margin:0 auto}
    .section{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:12px}
    h2{margin:0 0 8px;font-size:13px;color:var(--muted);letter-spacing:.12em;text-transform:uppercase}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .spacer{flex:1}
    input,select,textarea{background:var(--btn);border:1px solid var(--line);color:var(--ink);border-radius:8px;padding:6px}
    textarea{resize:vertical;min-height:30px;max-height:120px}
    .tableWrap{width:100%;overflow-x:auto}
    table{width:100%;border-collapse:collapse;table-layout:fixed;min-width:780px}
    th,td{padding:8px;border-bottom:1px solid var(--line);text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    th{color:var(--accent)}
    /* pildoras estado */
    .pill{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border-radius:999px;border:1px solid #334155;white-space:nowrap;font-size:12px}
    .pill.warn{background:#2a1b05;color:#fbbf24;border-color:#533c0d}
    .pill.err{background:#3b0a0a;color:#fca5a5;border-color:#6b1a1a}
    .pill.ok{background:#052e1a;color:#86efac;border-color:#0d3e28}
    .pill.info{background:#0b1223;color:#cbd5e1;border-color:#334155}
    .clickable{cursor:pointer}
    .muted{color:var(--muted)}
    .note{font-size:12px;color:#9ca3af}
    /* footer */
    footer{color:#aaa;font-size:.8em;text-align:center;margin:14px 0}
    /* m車vil */
    @media (max-width:720px){
      .bar{grid-template-columns:42px 1fr 120px}
      .title{font-size:18px}
      table{min-width:640px}
    }
  </style>
</head>
<body>
  <!-- Bot車n de instalaci車n -->
  <button class="btn" id="btnInstall" style="display:none;margin:8px">Instalar</button>

  <header>
    <div class="bar">
      <div class="brand">
        <img src="/RecargApp/icons/icon-192x192.png" alt="logo">
      </div>
      <div class="titleWrap"><h1 class="title">RecargApp</h1></div>
      <div class="actions">
        <span id="lockState" class="role">Modo lectura</span>
        <button class="btn" id="btnCambiarPinAdmin" style="display:none" title="Cambiar PIN Admin">Cambiar PIN</button>
        <button class="btn" id="btnToggleAdmin" title="Ingresar PIN">Iniciar sesi車n</button>
      </div>
    </div>
    <div class="tabs">
      <div class="tab active" data-tab="hoy">Recargos</div>
      <div class="tab" data-tab="general">Lista</div>
      <div class="tab" data-tab="historial">Historial</div>
    </div>
  </header>

  <main>
    <div id="banner" class="section" style="display:none"></div>

    <!-- ========== TAB HOY ========== -->
    <section class="section" data-panel="hoy">
      <h2 id="tituloDia">RECARGOS DEL DIA</h2>
      <div class="row">
        <label>Fecha</label>
        <input id="fecha" type="date" style="max-width:160px">
        <label>Faltantes</label>
        <input id="faltantes" type="number" value="1" min="0" style="max-width:90px">
        <div class="spacer"></div>
        <button class="btn danger" id="btnReiniciar">Reiniciar lista</button>
        <button class="btn" id="btnActualizar">Actualizar</button>
        <button class="btn" id="btnCopiarListado">Copiar orden</button>
        <button class="btn" id="btnAgregarExtra">+ Agregar extra</button>
      </div>

      <div class="tableWrap" style="margin-top:8px">
        <table id="tablaDia">
          <thead>
            <tr>
              <th style="width:46px">#</th>
              <th style="width:240px">Nombre</th>
              <th style="width:120px">Jerarquia</th>
              <th style="width:220px">Estado</th>
              <th style="width:160px">Pabellon</th>
              <th style="width:220px">Obs recargo</th>
              <th style="width:80px">Acc</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="note" style="margin-top:6px">
        * <span class="pill warn">ART</span>,
        <span class="pill ok">AUTORIZADO</span>,
        <span class="pill info">SALTEADO</span> o
        <span class="pill err">LICENCIA</span> se muestran pero no numeran.
        Con <b>Presente</b> (13/26/04) suben y cuentan. (debe X) se ve en la fila.
      </div>

      <!-- Pasivos DEBAJO -->
      <div class="section" style="margin-top:12px">
        <h2>PASIVOS</h2>
        <div class="row">
          <label>Para:</label>
          <select id="pasivosPara" style="max-width:260px">
            <option value="mismo">1er dia de franco (mismo dia)</option>
            <option value="siguiente">2do dia de franco (al dia siguiente)</option>
          </select>
          <div class="spacer"></div>
          <button class="btn" id="btnImprimirPasivos">Imprimir pasivos</button>
          <button class="btn" id="btnCopiarResultado">Copiar recargos+pasivos</button>
        </div>
        <div class="tableWrap" style="margin-top:6px">
          <table id="tablaPasivos">
            <thead>
              <tr><th style="width:42px">#</th><th>Nombre</th><th style="width:160px">Jerarquia</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="row" style="margin-top:10px;gap:14px">
        <button class="btn primary" id="btnConfirmar">Confirmar guardia</button>
        <button class="btn warn" id="btnDeshacer" title="Ctrl+Z">Deshacer (Ctrl+Z)</button>
      </div>
    </section>

    <!-- ========== TAB GENERAL ========== -->
    <section class="section" data-panel="general" style="display:none">
      <h2>Listado general</h2>
      <div class="row">
        <input id="nombre" placeholder="Nombre y Apellido" style="max-width:240px">
        <input id="dni" placeholder="DNI" style="max-width:140px">
        <input id="legajo" placeholder="Legajo" style="max-width:140px">
        <select id="jerarquia" style="max-width:160px">
          <option>AYTE MY (CG)</option><option>AYTE PR (CG)</option><option>AYTE 1∼ (CG)</option><option>AYTE 2∼ (CG)</option><option>AYTE 3∼ (CG)</option><option>AYTE 4∼ (CG)</option><option>AYTE 5∼ (CG)</option><option>SUBAYTE (CG)</option><option>- vacio -</option>
        </select>
        <input id="antiguedad" type="number" placeholder="Antig邦edad (a?os)" style="max-width:140px">
        <button class="btn primary" id="btnAgregar">Agregar</button>
        <button class="btn" id="btnOrdenarCriterios">Ordenar (Jerarquia ↙ Antig邦edad)</button>
        <button class="btn" id="btnDeshacerOrden" title="Volver al orden anterior">Deshacer orden</button>
        <button class="btn warn" id="btnEditarGeneral" title="Editar en linea y arrastrar">Editar</button>
      </div>
      <div class="tableWrap" style="margin-top:8px">
        <table id="tablaGeneral">
          <thead><tr>
            <th style="width:64px">Orden</th>
            <th style="width:280px">Nombre</th>
            <th style="width:140px">DNI</th>
            <th style="width:140px">Legajo</th>
            <th style="width:160px">Jerarquia</th>
            <th style="width:90px">Antig.</th>
            <th style="width:90px">Debe</th>
            <th>Obs</th>
            <th style="width:80px" class="muted">Eliminar</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="btnExportar">Exportar JSON</button>
        <button class="btn" id="btnImportar">Importar JSON</button>
      </div>
      <div class="note">Para editar la posici車n, presion芍 "Editar" y arrastr芍 filas. Eliminar muestra confirmaci車n. (Solo Admin)</div>
    </section>

    <!-- ========== TAB HISTORIAL ========== -->
    <section class="section" data-panel="historial" style="display:none">
      <h2>Historial</h2>
      <div class="row" style="justify-content:flex-end;margin-bottom:8px">
        <button class="btn danger" id="btnBorrarHistRec">Borrar historial Recargos</button>
        <button class="btn danger" id="btnBorrarHistCamb">Borrar historial Cambios</button>
      </div>

      <div class="row" style="gap:10px;margin-bottom:6px">
        <button class="tab active" id="tabHistRec">Recargos</button>
        <button class="tab" id="tabHistCamb">Cambios</button>
        <div class="spacer"></div>
        <button class="btn primary" id="btnGuardarLlamados">Guardar llamados del ultimo</button>
      </div>

      <div id="histRecargos" class="section" style="padding:10px">
        <div class="tableWrap">
          <table id="tablaHistorial">
            <thead><tr>
              <th style="width:80px">Ver</th>
              <th>Resumen</th>
              <th style="width:180px">Acciones</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="histCambios" class="section" style="display:none;padding:10px">
        <div class="tableWrap">
          <table id="tablaCambios">
            <thead><tr>
              <th style="width:80px">Ver</th>
              <th>Cambio</th>
              <th style="width:160px">Acciones</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal gen谷rico (Extra) -->
  <div id="backdrop" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:20">
    <div class="section" style="min-width:300px;max-width:95vw">
      <h3 style="margin:0 0 8px;font-size:16px">Agregar extra</h3>
      <div class="row"><input id="extraNombre" placeholder="Nombre (opcional)" style="flex:1"></div>
      <div class="row">
        <select id="extraJerarquia" style="max-width:220px">
          <option value="">(sin jerarquia)</option>
          <option>AYTE MY (CG)</option><option>AYTE PR (CG)</option><option>AYTE 1∼ (CG)</option><option>AYTE 2∼ (CG)</option><option>AYTE 3∼ (CG)</option><option>AYTE 4∼ (CG)</option><option>AYTE 5∼ (CG)</option><option>SUBAYTE (CG)</option><option>- vacio -</option>
        </select>
        <select id="extraPab" style="max-width:220px">
          <option value="">(sin pabellon)</option>
          <option>Vigilancia</option><option>Pab 1</option><option>Pab 3S</option><option>Pab 3N</option><option>Pab 5S</option><option>Pab 5N</option><option>Pab 7</option><option>Pab 9</option><option>Pab 11</option><option>Pab Aisl</option><option>Cruz</option><option>Porton</option>
        </select>
      </div>
      <div class="row"><input id="extraObs" placeholder="Observacion (opcional)" style="flex:1"></div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn" id="extraCancel">Cancelar</button>
        <button class="btn primary" id="extraOk">Agregar</button>
      </div>
    </div>
  </div>

  <footer>Version <span id="appVersion">〞</span></footer>

<script>
/* ========= Helpers ========= */
function $all(sel, root){ return Array.prototype.slice.call((root||document).querySelectorAll(sel)); }
function $qs(root, sel){ return (root||document).querySelector(sel); }
function showBanner(msg,opts){opts=opts||{};var b=$qs(null,'#banner');if(!b)return;b.textContent=msg;b.style.display='block';if(showBanner._t)clearTimeout(showBanner._t);if(!opts.sticky){showBanner._t=setTimeout(()=>b.style.display='none',opts.timeout||3200);}}

/* ========= Modelo y estado ========= */
const KEY='recargapp.v1';
let ADMIN_PIN = localStorage.getItem('recargapp.admin.pin') || '1111';
const SUPERADMIN_PIN='9999';
function setAdminPin(newPin){ ADMIN_PIN=String(newPin); localStorage.setItem('recargapp.admin.pin', ADMIN_PIN); }

function save(){ localStorage.setItem(KEY, JSON.stringify(db)); }
function load(){ try{ return JSON.parse(localStorage.getItem(KEY)||'null'); }catch(e){ return null; } }
function uid(){ return Math.random().toString(36).slice(2,9); }
function today(){ return new Date().toISOString().slice(0,10); }
function fmtDM(s){ var a=s.split('-'); return a[2]+"/"+a[1]; }
function inLicencia(p, fecha){ var L=p.obs.licencia; if(!L||!L.desde||!L.hasta) return false; return (fecha>=L.desde && fecha<=L.hasta); }
function isDayAfter(dateStr, baseStr){ if(!dateStr||!baseStr) return false; var d=new Date(dateStr), b=new Date(baseStr); var next=new Date(d.getTime()+86400000); return next.toISOString().slice(0,10)===b.toISOString().slice(0,10); }

let db = load() || { personas: [], historial: [], cambios: [], generalHead: 0 };
if(db.personas){ var base=Date.now(); db.personas.forEach((p,i)=>{ if(p.rorder==null){ p.rorder=(typeof p.order==='number')?p.order:(base+i);} if(typeof p.debeLista!=='number'){p.debeLista=0;} if(!p.obs){p.obs={art:null,licencia:{desde:null,hasta:null},autorizado:false};} }); }

let prioridadHoy = {}; // {id:'ART13'|'ART26'|'ART04'}
let role='viewer';

/* ========= Header / sesi車n ========= */
const lockState=$qs(null,'#lockState');
const btnToggleAdmin=$qs(null,'#btnToggleAdmin');
const btnCambiarPinAdmin=$qs(null,'#btnCambiarPinAdmin');

function isAdmin(){ return role==='admin' || role==='superadmin'; }
function isSuper(){ return role==='superadmin'; }

btnToggleAdmin.onclick=function(){
  if(role!=='viewer'){ role='viewer'; lockState.textContent='Modo lectura'; btnToggleAdmin.textContent='Iniciar sesi車n'; if(btnCambiarPinAdmin) btnCambiarPinAdmin.style.display='none'; renderAll(); return; }
  var code=prompt('Ingresar PIN');
  if(code===ADMIN_PIN){ role='admin'; lockState.textContent='ADMIN'; btnToggleAdmin.textContent='Salir'; if(btnCambiarPinAdmin) btnCambiarPinAdmin.style.display='none'; renderAll(); }
  else if(code===SUPERADMIN_PIN){ role='superadmin'; lockState.textContent='SUPERADMIN'; btnToggleAdmin.textContent='Salir'; if(btnCambiarPinAdmin) btnCambiarPinAdmin.style.display='inline-block'; renderAll(); }
  else if(code!==null){ alert('PIN incorrecto'); }
};
btnCambiarPinAdmin.onclick=function(){
  if(!isSuper()) return;
  var np=prompt('Nueva contrase?a de ADMIN (4-8 digitos):'); if(np==null) return;
  np=np.trim(); if(!/^\d{4,8}$/.test(np)) return alert('Debe ser de 4 a 8 digitos.');
  setAdminPin(np); showBanner('Contrase?a de ADMIN actualizada');
};

/* ========= Tabs ========= */
var tabs = $all('.tab');
var panels = $all('[data-panel]');
tabs.forEach(function(t){
  t.addEventListener('click', function(){
    tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active');
    var name=t.getAttribute('data-tab');
    panels.forEach(p=>p.style.display=(p.getAttribute('data-panel')===name)?'block':'none');
    renderAll();
  });
});

/* ========= General ========= */
var snapshotOrden=null, editGeneral=false;
var nombreEl=$qs(null,'#nombre'), dniEl=$qs(null,'#dni'), legajoEl=$qs(null,'#legajo'), jerarquiaEl=$qs(null,'#jerarquia'), antigEl=$qs(null,'#antiguedad');

$qs(null,'#btnAgregar').onclick=function(){
  if(!isAdmin()) return alert('Solo Admin');
  if(!nombreEl.value.trim()) return alert('Nombre requerido');
  const p={ id:uid(), nombre:nombreEl.value.trim(), dni:dniEl.value.trim(), legajo:legajoEl.value.trim(), jerarquia:jerarquiaEl.value, antiguedad:parseInt(antigEl.value||'0',10), obs:{art:null, licencia:{desde:null,hasta:null}, autorizado:false}, order:Date.now(), rorder:Date.now(), debeLista:0, salteado:false };
  db.personas.push(p);
  db.cambios.push({t:Date.now(), tipo:'agregar', nombre:p.nombre});
  save(); nombreEl.value=''; dniEl.value=''; legajoEl.value=''; antigEl.value=''; renderGeneral(); renderHoy();
};

$qs(null,'#btnOrdenarCriterios').onclick=function(){
  if(!isAdmin()) return alert('Solo Admin');
  snapshotOrden = db.personas.map(p=>p.id);
  var rank={'AYTE MY (CG)':1,'AYTE PR (CG)':2,'AYTE 1∼ (CG)':3,'AYTE 2∼ (CG)':4,'AYTE 3∼ (CG)':5,'AYTE 4∼ (CG)':6,'AYTE 5∼ (CG)':7,'SUBAYTE (CG)':8,'- vacio -':9};
  db.personas.sort((a,b)=> rank[a.jerarquia]-rank[b.jerarquia] || (b.antiguedad||0)-(a.antiguedad||0));
  var base=Date.now(); db.personas.forEach((p,i)=>{ p.order=base+i; });
  db.cambios.push({t:Date.now(), tipo:'ordenar', detalle:'Jerarquia -> Antiguedad'});
  save(); renderGeneral(); renderHoy();
};

$qs(null,'#btnDeshacerOrden').onclick=function(){
  if(!isAdmin()) return alert('Solo Admin');
  if(!snapshotOrden) return alert('No hay orden anterior');
  var base=Date.now(); snapshotOrden.forEach((id,i)=>{ var p=getById(id); if(p){ p.order=base+i; } });
  db.cambios.push({t:Date.now(), tipo:'deshacer-orden'});
  save(); renderGeneral(); renderHoy();
};

$qs(null,'#btnEditarGeneral').onclick=function(){
  if(!isAdmin()) return alert('Solo Admin');
  editGeneral=!editGeneral; $qs(null,'#btnEditarGeneral').textContent = editGeneral? 'Guardar' : 'Editar';
  renderGeneral();
};

function getById(id){ for(var i=0;i<db.personas.length;i++) if(db.personas[i].id===id) return db.personas[i]; return null; }

function renderGeneral(){
  var tbody=$qs(null,'#tablaGeneral tbody'); tbody.innerHTML='';
  var list=[].concat(db.personas).sort((a,b)=>a.order-b.order);
  list.forEach(function(p,i){
    var tr=document.createElement('tr'); tr.setAttribute('data-id', p.id);

    if(editGeneral){
      tr.setAttribute('draggable','true');
      tr.ondragstart=function(ev){ ev.dataTransfer.setData('text/plain', p.id); tr.classList.add('dragging'); };
      tr.ondragend=function(){ tr.classList.remove('dragging'); };
      tr.ondragover=function(ev){ ev.preventDefault(); tr.style.outline='1px dashed #334155'; };
      tr.ondragleave=function(){ tr.style.outline=''; };
      tr.ondrop=function(ev){
        ev.preventDefault(); tr.style.outline='';
        var fromId=ev.dataTransfer.getData('text/plain'); if(!fromId||fromId===p.id) return;
        var ordered=[].concat(db.personas).sort((a,b)=>a.order-b.order);
        var fromIdx=ordered.findIndex(x=>x.id===fromId);
        var toIdx=ordered.findIndex(x=>x.id===p.id);
        if(fromIdx<0||toIdx<0) return;
        var moved=ordered.splice(fromIdx,1)[0]; ordered.splice(toIdx,0,moved);
        var base=Date.now(); ordered.forEach((x,idx)=>{ x.order=base+idx; });
        db.cambios.push({t:Date.now(), tipo:'mover', nombre:moved.nombre, detalle:'a posicion '+(toIdx+1)});
        save(); renderGeneral(); renderHoy();
      };
    }

    function cell(txt){ return '<td>'+txt+'</td>'; }
    var cOrden = cell(i+1);
    var cNombre = cell(p.nombre);
    var cDNI = editGeneral ? '<td><input value="'+(p.dni||'')+'" onblur="setField(\''+p.id+'\',\'dni\',this.value)"></td>' : cell(p.dni||'');
    var cLegajo = editGeneral ? '<td><input value="'+(p.legajo||'')+'" onblur="setField(\''+p.id+'\',\'legajo\',this.value)"></td>' : cell(p.legajo||'');
    var jerOpts = ['AYTE MY (CG)','AYTE PR (CG)','AYTE 1∼ (CG)','AYTE 2∼ (CG)','AYTE 3∼ (CG)','AYTE 4∼ (CG)','AYTE 5∼ (CG)','SUBAYTE (CG)','- vacio -']
      .map(j=>'<option '+(p.jerarquia===j?'selected':'')+'>'+j+'</option>').join('');
    var cJer = editGeneral ? '<td><select onchange="setField(\''+p.id+'\',\'jerarquia\',this.value)">'+jerOpts+'</select></td>' : cell(p.jerarquia);
    var cAnt = editGeneral ? '<td><input type="number" min="0" value="'+(p.antiguedad||0)+'" onblur="setField(\''+p.id+'\',\'antiguedad\',parseInt(this.value||\'0\',10))"></td>' : cell(p.antiguedad||0);
    var cDebe = editGeneral ? '<td><input type="number" min="0" value="'+(p.debeLista||0)+'" onblur="setField(\''+p.id+'\',\'debeLista\',parseInt(this.value||\'0\',10))"></td>' : cell(p.debeLista||0);
    var obsParts=[]; if(p.obs.art) obsParts.push('ART '+p.obs.art);
    if(p.obs.licencia && p.obs.licencia.desde && p.obs.licencia.hasta) obsParts.push('LIC '+fmtDM(p.obs.licencia.desde)+'-'+fmtDM(p.obs.licencia.hasta));
    if(p.obs.autorizado) obsParts.push('AUTORIZADO'); if(p.salteado) obsParts.push('SALTEADO');
    var cObs = cell(obsParts.join(' ﹞ ')||'<span class="muted">-</span>');
    var cDel = editGeneral
      ? "<td><button class='btn danger' onclick=\"eliminar('"+p.id+"')\">Eliminar</button></td>"
      : "<td class='muted'>-</td>";

    tr.innerHTML = cOrden + cNombre + cDNI + cLegajo + cJer + cAnt + cDebe + cObs + cDel;
    if(!isAdmin()){ $all('button,input,select', tr).forEach(el=>{ el.setAttribute('disabled','disabled'); el.classList.add('lock'); el.title='Solo Admin'; }); }
    tbody.appendChild(tr);
  });
}
window.setField=function(id,key,val){ if(!isAdmin()) return alert('Solo Admin'); var p=getById(id); if(!p) return; p[key]=val; save(); };
function eliminar(id){
  if(!isAdmin()) return alert('Solo Admin');
  var p=getById(id); if(!p) return;
  if(!confirm('Eliminar a '+p.nombre+' del listado?')) return;
  db.personas=db.personas.filter(x=>x.id!==id);
  db.cambios.push({t:Date.now(), tipo:'eliminar', nombre:p.nombre});
  save(); renderGeneral(); renderHoy();
}

/* ========= HOY ========= */
var fechaEl=$qs(null,'#fecha'); var faltEl=$qs(null,'#faltantes'); fechaEl.value=today();
function setTitulo(){ $qs(null,'#tituloDia').textContent = 'RECARGOS '+fmtDM(fechaEl.value); }
setTitulo(); fechaEl.addEventListener('change', setTitulo);

$qs(null,'#btnReiniciar').onclick=function(){
  if(!isAdmin()) return alert('Solo Admin');
  if(confirm('Seguro? Esto reinicia la rotacion desde el listado general.')){
    var ordered=[].concat(db.personas).sort((a,b)=>a.order-b.order); var base=Date.now();
    ordered.forEach((p,i)=>{ p.rorder=base+i; });
    prioridadHoy={}; db.generalHead=0; save(); renderHoy();
  }
};
$qs(null,'#btnActualizar').onclick=function(){ renderHoy(); };

function generalList(){ return [].concat(db.personas).sort((a,b)=>a.order-b.order); }
function elegibles(){ return [].concat(db.personas).sort((a,b)=>(a.rorder||0)-(b.rorder||0)); }

/* Plan del dia (toggle robusto) */
function getPlan(){
  var falt=Math.max(0, parseInt(faltEl.value||'0',10));
  var fecha=fechaEl.value;
  var base=elegibles();

  var prioIds=Object.keys(prioridadHoy);
  var pART = base.filter(p=> prioridadHoy[p.id]==='ART13' || prioridadHoy[p.id]==='ART26');
  var p04  = base.filter(p=> prioridadHoy[p.id]==='ART04');
  var resto= base.filter(p=> prioIds.indexOf(p.id)===-1);

  resto.sort((a,b)=> (b.debeLista||0)-(a.debeLista||0) || (a.rorder||0)-(b.rorder||0));

  var mostrados=[], numerados=[];
  function pushPersona(p, forzarContar){
    var saltPorFlag = p.salteado===true;
    // IMPORTANTE: NO eliminar por toggles; solo saltear si no hay "presente"
    var saltar = !forzarContar && (p.obs.art || p.obs.autorizado || inLicencia(p,fecha) || saltPorFlag);
    mostrados.push({p:p, saltar:saltar, saltPorFlag:saltPorFlag});
    if(!saltar) numerados.push(p);
  }
  pART.forEach(p=>pushPersona(p,true));
  p04.forEach(p=>pushPersona(p,true));
  resto.forEach(p=>pushPersona(p,false));

  var asignados = numerados.slice(0,falt);
  var idxUlt=falt-1;
  var pasivos = (idxUlt>=0)? numerados.slice(idxUlt+1, idxUlt+3) : numerados.slice(0,2);

  return {mostrados, asignados, pasivos};
}

/* Estado: construir pildoras y toggles sin borrar filas */
function estadoPills(p, fecha){
  var pills=[];
  // ART toggle (13/26) -> Presente
  if(p.obs && (p.obs.art==='13' || p.obs.art==='26')){
    var tipo=p.obs.art;
    var isPres = (prioridadHoy[p.id]==='ART13' && tipo==='13') || (prioridadHoy[p.id]==='ART26' && tipo==='26');
    var txt = isPres? ('Presente '+tipo) : ('ART '+tipo);
    pills.push('<span class="pill warn clickable" data-act="toggle-art" data-tipo="'+tipo+'" data-id="'+p.id+'">'+txt+'</span>');
  }
  // LIC toggle (LIC dd/mm-dd/mm) <-> Presente 04
  if(inLicencia(p,fecha) || prioridadHoy[p.id]==='ART04'){
    var L=p.obs.licencia||{desde:null,hasta:null};
    var isPres04 = (prioridadHoy[p.id]==='ART04');
    if(isPres04){
      pills.push('<span class="pill err clickable" data-act="toggle-lic" data-id="'+p.id+'">Presente 04</span>');
    }else if(L.desde && L.hasta){
      pills.push('<span class="pill err clickable" data-act="toggle-lic" data-id="'+p.id+'">LIC '+fmtDM(L.desde)+'-'+fmtDM(L.hasta)+'</span>');
    }
  }
  if(p.obs && p.obs.autorizado) pills.push('<span class="pill ok">AUTORIZADO</span>');
  if(p.salteado) pills.push('<span class="pill info">SALTEADO</span>');
  if((p.debeLista||0)>0) pills.push('<span class="pill info">debe '+p.debeLista+'</span>');
  return pills.join(' ');
}

function renderHoy(){
  setTitulo();
  var fecha=fechaEl.value;
  var prev={};
  $all('#tablaDia tbody tr[data-id]').forEach(function(r){
    var id=r.getAttribute('data-id');
    var sel=r.querySelector('select'); var inp=r.querySelector('input[type="text"]');
    prev[id]={pab: sel?sel.value:'', obs: inp?inp.value:''};
  });

  var tb=$qs(null,'#tablaDia tbody'); tb.innerHTML=''; var n=0;
  // Si una licencia termin車 ayer, hoy sugiere Presente 04
  db.personas.forEach(function(p){
    if(p && p.obs && p.obs.licencia && isDayAfter(p.obs.licencia.hasta, fecha)){
      if(!prioridadHoy[p.id]) prioridadHoy[p.id]='ART04';
    }
  });

  var plan=getPlan();
  plan.mostrados.forEach(function(item){
    var p=item.p, saltar=item.saltar;
    var tr=document.createElement('tr'); tr.setAttribute('data-id', p.id);

    var numCell=document.createElement('td'); numCell.textContent = saltar? '-' : (++n);

    var pabSel=document.createElement('select');
    ['','Vigilancia','Pab 1','Pab 3S','Pab 3N','Pab 5S','Pab 5N','Pab 7','Pab 9','Pab 11','Pab Aisl','Cruz','Porton'].forEach(function(x){
      var opt=document.createElement('option'); opt.textContent=x; pabSel.appendChild(opt);
    });
    if(prev[p.id] && prev[p.id].pab) pabSel.value=prev[p.id].pab;
    if(saltar || !isAdmin()){ pabSel.disabled=true; pabSel.classList.add('lock'); }
    var pabCell=document.createElement('td'); pabCell.appendChild(pabSel);

    var obsRecInput=document.createElement('input'); obsRecInput.type='text'; obsRecInput.placeholder='(ej. cubre Ibarra)';
    if(prev[p.id] && prev[p.id].obs) obsRecInput.value=prev[p.id].obs;
    if(!isAdmin()){ obsRecInput.disabled=true; obsRecInput.classList.add('lock'); }
    var obsRecCell=document.createElement('td'); obsRecCell.appendChild(obsRecInput);

    var estadoHTML = estadoPills(p, fecha) || '<span class="muted">-</span>';
    var estadoCell=document.createElement('td'); estadoCell.innerHTML = estadoHTML;

    var actCell=document.createElement('td');
    actCell.innerHTML = "<button class='btn' onclick=\"openModal('"+p.id+"')\" "+(!isAdmin()?"disabled title='Solo Admin'":"")+">Abrir</button>";

    tr.appendChild(numCell);
    tr.insertAdjacentHTML('beforeend', "<td>"+p.nombre+"</td><td>"+p.jerarquia+"</td>");
    tr.appendChild(estadoCell);
    tr.appendChild(pabCell); tr.appendChild(obsRecCell); tr.appendChild(actCell);
    tb.appendChild(tr);
  });

  // Delegaci車n: clicks en pills (no alteran lista, solo prioridadHoy)
  tb.addEventListener('click', function(ev){
    var el=ev.target.closest('[data-act]'); if(!el) return;
    if(!isAdmin()) return alert('Solo Admin');
    var id=el.getAttribute('data-id');
    var act=el.getAttribute('data-act');
    if(act==='toggle-art'){
      var tipo=el.getAttribute('data-tipo'); // "13" o "26"
      var key=(tipo==='13'?'ART13':'ART26');
      prioridadHoy[id] = (prioridadHoy[id]===key)? undefined : key;
    }
    if(act==='toggle-lic'){
      prioridadHoy[id] = (prioridadHoy[id]==='ART04')? undefined : 'ART04';
    }
    renderHoy();
  }, { once:true }); // se vuelve a agregar en cada render

  // Pasivos
  var tpas=$qs(null,'#tablaPasivos tbody'); tpas.innerHTML='';
  plan.pasivos.forEach(function(p,i){
    var tr=document.createElement('tr'); tr.setAttribute('data-id', p.id);
    tr.innerHTML="<td>"+(i+1)+"</td><td>"+p.nombre+"</td><td>"+p.jerarquia+"</td>";
    tpas.appendChild(tr);
  });
}

function copyText(txt){
  (navigator.clipboard && navigator.clipboard.writeText)
    ? navigator.clipboard.writeText(txt).then(()=>alert('Texto copiado'))
    : (function(){var w=window.open('', '_blank'); w.document.write('<pre>'+txt+'</pre>'); w.document.close(); w.focus();})();
}

/* Copiar orden del d赤a (sin pasivos) */
$qs(null,'#btnCopiarListado').onclick=function(){
  var fecha=fechaEl.value;
  var plan=getPlan();
  var lines=['RECARGOS '+fmtDM(fecha),''];
  var n=0;
  plan.mostrados.forEach(function(item){
    var p=item.p, saltar=item.saltar;
    var prio=prioridadHoy[p.id], tags=[];
    if(prio){ tags.push(prio==='ART13'?'(presente 13)': prio==='ART26'?'(presente 26)':'(presente 04)'); }
    if(p.obs && p.obs.art && !prio) tags.push('(ART '+p.obs.art+')');
    if(p.obs && p.obs.autorizado) tags.push('(autorizado)');
    if(item.saltPorFlag) tags.push('(salteado)');
    if(inLicencia(p,fecha)) tags.push('(licencia)');
    if((p.debeLista||0)>0) tags.push('(debe '+p.debeLista+')');

    if(saltar){ lines.push('- '+p.nombre+' '+tags.join(' ')); }
    else{ lines.push((++n)+') '+p.nombre+' '+tags.join(' ')); }
  });
  copyText(lines.join('\n'));
};

/* Agregar extra (modal simple) */
const backdrop=$qs(null,'#backdrop');
$qs(null,'#btnAgregarExtra').onclick=function(){ if(!isAdmin()) return alert('Solo Admin'); backdrop.style.display='flex'; }
$qs(null,'#extraCancel').onclick=function(){ backdrop.style.display='none'; }
$qs(null,'#extraOk').onclick=function(){
  if(!isAdmin()) return;
  var plan=getPlan();
  var nombre=($qs(null,'#extraNombre').value||'Extra').trim();
  var jer=$qs(null,'#extraJerarquia').value||'- vacio -';
  var pab=$qs(null,'#extraPab').value||'';
  var obs=$qs(null,'#extraObs').value||'';
  // se agrega arriba (no altera lista general)
  var id='extra_'+uid();
  prioridadHoy[id]='EXTRA'; // no se usa en plan, solo marca
  // Insertamos visualmente en primera posici車n contable
  var tbody=$qs(null,'#tablaDia tbody');
  var tr=document.createElement('tr'); tr.setAttribute('data-id', id);
  tr.innerHTML='<td>*</td><td>'+nombre+'</td><td>'+jer+'</td><td><span class="pill info">EXTRA</span></td>'
              +'<td>'+ (pab||'') +'</td><td>'+ (obs||'') +'</td><td>-</td>';
  tbody.insertBefore(tr, tbody.firstChild);
  backdrop.style.display='none';
};

/* Confirmar guardia */
$qs(null,'#btnConfirmar').onclick=function(){
  if(!isAdmin()) return alert('Solo Admin');
  var plan=getPlan();
  var idsAsignados={}; plan.asignados.forEach(p=>idsAsignados[p.id]=true);

  var rows=$all('#tablaDia tbody tr[data-id]');
  var recargos=[];
  rows.forEach(function(r){
    var id=r.getAttribute('data-id'); if(!idsAsignados[id]) return;
    var sel=r.querySelector('select'); var pab= sel?sel.value:'';
    var inp=r.querySelector('input[type="text"]'); var obsRec=inp?inp.value.trim():'';
    var per=getById(id); recargos.push({id:id,nombre:per?per.nombre:(r.children[1].textContent),pabellon:pab,obsRecargo:obsRec});
  });

  var pasivos=plan.pasivos;
  var fecha=fechaEl.value;
  var falt=Math.max(0, parseInt(faltEl.value||'0',10));
  var glist=generalList(); if(glist.length===0){ alert('No hay personal'); return; }
  if(db.generalHead>=glist.length) db.generalHead=0;

  // ventana seg迆n lista general
  var ventanaIdx=[], idx=db.generalHead;
  for(var k=0;k<falt && k<glist.length;k++){ ventanaIdx.push(idx); idx=(idx+1)%glist.length; }
  var ventanaIds=ventanaIdx.map(i=>glist[i].id);

  var asignadosIds={}; recargos.forEach(r=>asignadosIds[r.id]=true);

  // reglas DEBE
  ventanaIds.forEach(function(id){
    var p=getById(id); if(!p) return;
    var prio=prioridadHoy[id];
    var lic=inLicencia(p,fecha);
    var quedoPorLista = !!asignadosIds[id] && !(prio==='ART13' || prio==='ART26' || prio==='ART04');
    if(quedoPorLista){ if((p.debeLista||0)>0) p.debeLista=0; }
    else{
      if(lic) return;
      if(p.obs.art || p.obs.autorizado || prio){ if((p.debeLista||0)<1) p.debeLista=1; }
    }
  });

  // Avanzar puntero general
  db.generalHead = (db.generalHead + falt) % glist.length;

  // Reubicar rorder de asignados
  var baseOrder=Date.now();
  db.personas.forEach(p=>{ if(p.rorder==null) p.rorder=baseOrder; });
  recargos.forEach((r,i)=>{ var p=getById(r.id); if(p) p.rorder = baseOrder + i + 1; });

  // Limpiar ART 13/26 si se presentaron (no borra fila)
  for(var pid in prioridadHoy){
    var why=prioridadHoy[pid];
    if((why==='ART13'||why==='ART26') && getById(pid)){ getById(pid).obs.art=null; }
  }

  // Salteados al fondo
  var tailBase=Date.now()+100000, kk=0;
  db.personas.forEach(p=>{ if(p.salteado){ p.rorder = tailBase+(++kk); } });

  // Limpiar banderas del d赤a
  db.personas.forEach(p=>{ p.obs.autorizado=false; p.salteado=false; });

  // Layout para historial resumido
  var conteo=0, layout=[];
  var fechaTxt=fmtDM(fecha);
  plan.mostrados.forEach(function(item){
    var p=item.p, saltar=item.saltar;
    var prio=prioridadHoy[p.id]; var per=getById(p.id)||{};
    var tags=[];
    if(prio){ tags.push(prio==='ART13'?'(por 13)': prio==='ART26'?'(por 26)':'(por 04)'); }
    if(per.obs && per.obs.autorizado) tags.push('(autorizado)');
    if(per.salteado) tags.push('(salteado)');
    if(per.obs && per.obs.art && !prio) tags.push('(ART '+per.obs.art+')');
    if(inLicencia(per, fecha)) tags.push('(licencia)');
    if((per.debeLista||0)>0) tags.push('(debe '+per.debeLista+')');

    if(!saltar && conteo<falt){
      var tr=$qs(null,'#tablaDia tbody tr[data-id="'+p.id+'"]');
      var sel=tr?tr.querySelector('select'):null; var pab=sel?sel.value:'';
      var inp=tr?tr.querySelector('input[type="text"]'):null; var obsRec=inp?inp.value.trim():'';
      layout.push({id:p.id,nombre:p.nombre,counted:true,n:conteo+1,pabellon:pab,obsRecargo:obsRec,tags:tags});
      conteo++;
    }else if(saltar){
      layout.push({id:p.id,nombre:p.nombre,counted:false,tags:tags});
    }
  });

  db.historial.push({
    fecha:fechaTxt,
    recargos:recargos,
    pasivos:pasivos.map(x=>({id:x.id,nombre:x.nombre})),
    llamados:[],
    layout:layout
  });
  save();
  prioridadHoy={};

  renderAll();
  alert('Guardia guardada.');
};

/* Deshacer basico (Ctrl+Z peque?o): vuelve al ultimo snapshot de render del dia si existe */
document.addEventListener('keydown',function(e){
  if(e.ctrlKey && e.key.toLowerCase()==='z') $qs(null,'#btnDeshacer').click();
});
$qs(null,'#btnDeshacer').onclick=function(){ showBanner('Deshacer basico: no hay acciones para revertir por ahora'); };

/* ===== Historial (resumen por linea, desplegable) ===== */
function renderHistorial(){
  // Recargos
  var tb=$qs(null,'#tablaHistorial tbody'); tb.innerHTML='';
  for(var idx=db.historial.length-1; idx>=0; idx--){
    var h=db.historial[idx];
    var recCount=(h.layout||[]).filter(x=>x.counted).length;
    var extraCount=(h.layout||[]).filter(x=>x.extra===true).length;
    var llamados=(h.llamados||[]).length;

    var tr=document.createElement('tr');
    var vid='rec_det_'+idx;
    tr.innerHTML="<td><button class='btn' data-toggle='"+vid+"'>Ver</button></td>"
      +"<td>"+h.fecha+" 〞 Recargos: "+recCount+" 〞 Extras: "+extraCount+" 〞 Llamados: "+llamados+"</td>"
      +"<td><button class='btn danger' data-del='"+idx+"'>Borrar</button> <button class='btn' data-copy='"+idx+"'>Copiar</button></td>";
    tb.appendChild(tr);

    // detalle
    var det=document.createElement('tr'); det.id=vid; det.style.display='none';
    var htmlRec='';
    if(h.layout && h.layout.length){
      htmlRec = h.layout.map(function(x){
        if(x.counted){
          var m={'Vigilancia':'vigilancia','Pab 1':'pab 01','Pab 3S':'pab 03 sur','Pab 3N':'pab 03 norte','Pab 5S':'pab 05 sur','Pab 5N':'pab 05 norte','Pab 7':'pab 07','Pab 9':'pab 09','Pab 11':'pab 11','Pab Aisl':'pab aisl','Cruz':'cruz','Porton':'porton','':''};
          var pabTxt=m[x.pabellon||'']||x.pabellon||''; var tags=(x.tags&&x.tags.length)?(' '+x.tags.join(' ')):'';
          var obs=x.obsRecargo?(' 〞 Obs: '+x.obsRecargo):''; var pab=pabTxt?(' 〞 Pab: '+pabTxt):'';
          return '<li>'+x.n+') '+x.nombre+tags+pab+obs+'</li>';
        }else{
          var tags2=(x.tags&&x.tags.length)?(' '+x.tags.join(' ')):'';
          return '<li>- '+x.nombre+tags2+'</li>';
        }
      }).join('');
    }else{ htmlRec='<li>-</li>'; }

    var htmlPas = (h.pasivos||[]).map(function(x,i){
      var nombre=getById(x.id)?getById(x.id).nombre:x.nombre;
      var checked = (h.llamados||[]).indexOf(x.id)>=0 ? 'checked':''; // solo ultima fila se podr芍 marcar
      var disabled = (idx===db.historial.length-1)? '' : 'disabled';
      return '<li><label><input type="checkbox" data-h="'+idx+'" data-id="'+x.id+'" '+disabled+' '+checked+'> '+(i+1)+') '+nombre+'</label></li>';
    }).join('') || '<li>-</li>';

    det.innerHTML="<td></td><td colspan='2'><div class='row' style='gap:20px'>"
      +"<div><b>Recargos</b><ul style='padding-left:18px;margin:6px 0 0'>"+htmlRec+"</ul></div>"
      +"<div><b>Pasivos (Fue llamado)</b><ul style='padding-left:18px;margin:6px 0 0'>"+htmlPas+"</ul></div>"
      +"</div></td>";
    tb.appendChild(det);
  }

  tb.addEventListener('click', function(e){
    var t=e.target;
    if(t.dataset.toggle){ var row=$qs(null,'#'+t.dataset.toggle); if(row) row.style.display=(row.style.display==='none')?'table-row':'none'; }
    if(t.dataset.del){ if(!isSuper()) return alert('Solo Superadmin'); var i=parseInt(t.dataset.del,10); if(confirm('Borrar registro?')){ db.historial.splice(i,1); save(); renderHistorial(); } }
    if(t.dataset.copy){
      var i=parseInt(t.dataset.copy,10); var h=db.historial[i];
      var lines=['RECARGOS '+h.fecha,''];
      var conteo=0;
      (h.layout||[]).forEach(function(x){
        if(x.counted){ var pab=x.pabellon?('  '+x.pabellon):''; var tags=(x.tags&&x.tags.length)?(' '+x.tags.join(' ')):''; var obs=x.obsRecargo?(' ('+x.obsRecargo+')'):''; lines.push((++conteo)+') '+x.nombre+tags+obs+pab); }
        else{ lines.push('- '+x.nombre); }
      });
      lines.push('','Pasivos','');
      (h.pasivos||[]).forEach(function(x,i){
        var nombre=getById(x.id)?getById(x.id).nombre:x.nombre;
        lines.push((i+1)+') '+nombre);
      });
      copyText(lines.join('\n'));
    }
  });
}

/* Guardar llamados del ultimo */
$qs(null,'#btnGuardarLlamados').onclick=function(){
  if(!isAdmin()) return alert('Solo Admin');
  if(!db.historial.length) return;
  var idx=db.historial.length-1; var h=db.historial[idx];
  var checks=$all("input[type='checkbox'][data-h='"+idx+"']");
  h.llamados = checks.filter(c=>c.checked).map(c=>c.getAttribute('data-id'));
  save(); renderHistorial(); showBanner('Llamados guardados');
};

/* Borrar historiales (solo super) */
$qs(null,'#btnBorrarHistRec').onclick=function(){ if(!isSuper()) return alert('Solo Superadmin'); if(confirm('Borrar historial de Recargos?')){ db.historial=[]; save(); renderHistorial(); } };
$qs(null,'#btnBorrarHistCamb').onclick=function(){ if(!isSuper()) return alert('Solo Superadmin'); if(confirm('Borrar historial de Cambios?')){ db.cambios=[]; save(); renderHistorial(); } };

/* Render maestro */
function renderAll(){
  renderGeneral(); renderHoy(); renderHistorial();
  if(btnCambiarPinAdmin) btnCambiarPinAdmin.style.display = isSuper()? 'inline-block' : 'none';
}

/* Seed si est芍 vac赤o */
(function seedIfEmpty(){
  if(db.personas && db.personas.length) return;
  var base=Date.now();
  var N=['Julio Angulo','Leandro Ordonez','Mariano Lezcano','Medina Diego','Jorge Tobar','Ortigoza Joaquin','Quirico Andres','Cheche Tobias','Moore Mariano','Mareco','Oliva Enzo','Mansilla David','Maidana Marcos'];
  db.personas=N.map(function(nombre,i){
    return { id:uid(), nombre:nombre, dni:'', legajo:'', jerarquia:'- vacio -', antiguedad:0, obs:{art:null, licencia:{desde:null,hasta:null}, autorizado:false}, order:base+i, rorder:base+i, debeLista:0, salteado:false };
  });
  save();
})();

renderAll();

/* ========= PWA: SW y version visible ========= */
(function(){
  // Registro SW (no auto-aplica updates sin confirm)
  let userAcceptedUpdate=false;

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/RecargApp/sw.js', { scope: '/RecargApp/' })
      .catch(err => console.error('SW fail', err));

    navigator.serviceWorker.addEventListener('controllerchange', () => {
      if (userAcceptedUpdate) window.location.reload();
    });

    navigator.serviceWorker.getRegistration().then(reg=>{
      if(!reg) return;
      function askToUpdate(){
        if(confirm('Hay una actualizaci車n de RecargApp. ?Aplicar ahora?')){
          userAcceptedUpdate=true;
          reg.waiting && reg.waiting.postMessage({type:'SKIP_WAITING'});
        }
      }
      if(reg.waiting) askToUpdate();
      reg.addEventListener('updatefound', ()=>{
        const nw = reg.installing;
        if(!nw) return;
        nw.addEventListener('statechange', ()=>{
          if(nw.state==='installed' && navigator.serviceWorker.controller){
            askToUpdate();
          }
        });
      });
    });
  }

  // Install prompt propio
  let deferredPrompt=null;
  const btnInstall=document.getElementById('btnInstall');
  window.addEventListener('beforeinstallprompt', (e)=>{
    e.preventDefault(); deferredPrompt=e;
    if(btnInstall) btnInstall.style.display='inline-block';
  });
  if(btnInstall){
    btnInstall.addEventListener('click', async ()=>{
      if(!deferredPrompt) return;
      await deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt=null; btnInstall.style.display='none';
    });
  }

  // Version visible (no se adelanta a la nueva hasta aceptar)
  async function updateVisibleVersion(){
    const el=document.getElementById('appVersion'); if(!el) return;
    try{
      const res=await fetch('/RecargApp/manifest.json?t='+(+new Date()), {cache:'no-store'});
      const m=await res.json();
      const v = m.version ? ('V'+m.version) : ((m.name&& (m.name.match(/V\d+(\.\d+)*/i)?.[0]||''))||'');
      el.textContent = v || 'V?';
    }catch(e){ el.textContent='V?'; }
  }
  updateVisibleVersion();
})();

</script>
</body>
</html>
