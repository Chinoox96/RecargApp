<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RecargApp</title>

  <!-- PWA -->
  <link rel="manifest" href="/RecargApp/manifest.json">
  <meta name="theme-color" content="#0b1223" />

  <!-- iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="/RecargApp/icons/icon-192x192.png">

  <style>
    :root{
      --bg:#0f172a;--card:#111827;--muted:#94a3b8;--ok:#16a34a;--warn:#f59e0b;--err:#ef4444;--ink:#e5e7eb;--accent:#38bdf8;
      --blue:#2563eb;--blue2:#1f6feb;--blue3:#1463d6;--border:#1f2937
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink)}

    /* ===== Header ===== */
    header{padding:10px 12px;border-bottom:1px solid var(--border);background:#0b1223;position:sticky;top:0;z-index:5}
    .appbar{display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center;max-width:1150px;margin:0 auto}
    .brand{display:flex;align-items:center;gap:10px;justify-content:flex-start}
    .brand img{width:32px;height:32px;border-radius:8px;display:block}
    .brand-title{justify-self:center;text-align:center;font-weight:800;font-size:22px;letter-spacing:.5px}
    @media (min-width:700px){.brand-title{font-size:26px}}
    .actions{display:flex;gap:8px;align-items:center;justify-content:flex-end}
    .btn{background:#0b1223;border:1px solid var(--border);color:#d1d5db;border-radius:8px;padding:7px 12px;font-weight:600;cursor:pointer}
    .btn-login .label{display:none}.btn-login .ico{display:inline}
    @media (min-width:700px){.btn-login .label{display:inline}.btn-login .ico{display:none}}
    /* Colores de botones (restaurados) */
    .btn.primary,.primary{background:linear-gradient(180deg,var(--blue2),var(--blue3));color:#fff;border:0}
    .btn.warn,.warn{background:linear-gradient(180deg,#f59e0b,#d97706);color:#fff;border:0}
    .btn.danger,.danger{background:linear-gradient(180deg,#ef4444,#dc2626);color:#fff;border:0}
    .icon-btn{padding:6px 8px;min-width:0;line-height:1}
    .muted{color:var(--muted)}
    .lock{opacity:.6}

    /* Tabs principales */
    .tabs-wrap{border-top:1px solid var(--border);margin-top:10px}
    .tabs{display:flex;gap:6px;justify-content:center;padding:8px 6px;flex-wrap:wrap;max-width:1150px;margin:0 auto}
    .tab{background:#0b1223;border:1px solid var(--border);color:var(--muted);padding:6px 10px;border-radius:10px;cursor:pointer}
    .tab.active{color:#fff;border-color:var(--blue);background:linear-gradient(180deg,var(--blue2),var(--blue3))}

    main{padding:10px;max-width:1150px;margin:0 auto}
    .section{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin:12px 0}
    h2{margin:0 0 8px;font-size:13px;color:var(--muted);letter-spacing:.12em;text-transform:uppercase}

    .tableWrap{width:100%;overflow-x:auto}
    table{width:100%;border-collapse:collapse;table-layout:fixed}
    th,td{padding:6px 8px;border-bottom:1px solid var(--border);text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    th{color:var(--accent)}

    /* Listado del d√≠a (Estado visible 4¬™ col) */
    #tablaDia th:nth-child(1),#tablaDia td:nth-child(1){width:40px}
    #tablaDia th:nth-child(2),#tablaDia td:nth-child(2){width:220px}
    #tablaDia th:nth-child(3),#tablaDia td:nth-child(3){width:110px}
    #tablaDia th:nth-child(4),#tablaDia td:nth-child(4){width:auto}
    #tablaDia th:nth-child(5),#tablaDia td:nth-child(5){width:130px}
    #tablaDia th:nth-child(6),#tablaDia td:nth-child(6){width:220px}
    #tablaDia th:nth-child(7),#tablaDia td:nth-child(7){width:96px}

    /* Pasivos compactos */
    #tablaPasivos th:nth-child(1),#tablaPasivos td:nth-child(1){width:42px}
    #tablaPasivos th:nth-child(2),#tablaPasivos td:nth-child(2){width:auto}
    #tablaPasivos th:nth-child(3),#tablaPasivos td:nth-child(3){width:140px}

    /* Lista general (sin columna Acciones, m√°s compacto) */
    #tablaGeneral th:nth-child(1),#tablaGeneral td:nth-child(1){width:56px}
    #tablaGeneral th:nth-child(2),#tablaGeneral td:nth-child(2){width:260px}
    #tablaGeneral th:nth-child(3),#tablaGeneral td:nth-child(3){width:120px}
    #tablaGeneral th:nth-child(4),#tablaGeneral td:nth-child(4){width:120px}
    #tablaGeneral th:nth-child(5),#tablaGeneral td:nth-child(5){width:140px}
    #tablaGeneral th:nth-child(6),#tablaGeneral td:nth-child(6){width:80px}
    #tablaGeneral th:nth-child(7),#tablaGeneral td:nth-child(7){width:80px}
    #tablaGeneral th:nth-child(8),#tablaGeneral td:nth-child(8){width:auto}

    input,select,textarea{background:#0b1223;border:1px solid var(--border);color:var(--ink);border-radius:8px;padding:6px;width:100%}
    input[type=date]{cursor:pointer}
    textarea{resize:vertical;min-height:30px;max-height:120px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    /* Pills */
    .pill{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border-radius:999px;border:1px solid #334155;white-space:nowrap}
    .pill.warn{background:#2a1b05;color:#fbbf24}
    .pill.err{background:#3b0a0a;color:#fca5a5}
    .pill.ok{background:#052e1a;color:#86efac}

    .banner{background:#065f46;border:1px solid #14532d;color:#d1fae5;border-radius:12px;padding:8px 12px;margin:8px auto;display:none}
    .note{font-size:12px;color:#9ca3af}

    #backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:20}
    .modal{background:#0b1223;border:1px solid var(--border);border-radius:12px;min-width:300px;max-width:95vw;padding:12px}

    /* Botonera recargos */
    .actions-line{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:12px;flex-wrap:wrap}
    .left-actions{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .right-actions{margin-left:auto;display:flex;gap:12px;align-items:center;flex-wrap:wrap}

    /* Historial con subtabs */
    .subtabs{display:flex;gap:6px;margin:6px 0 10px;flex-wrap:wrap}
    .subtab{padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:#0b1223;color:var(--muted);cursor:pointer}
    .subtab.active{color:#fff;background:linear-gradient(180deg,var(--blue2),var(--blue3));border:0}
    .history-toolbar{display:flex;gap:10px;align-items:center;justify-content:flex-end;margin:6px 0}
    .history-row{border:1px solid var(--border);border-radius:10px;padding:8px;margin:8px 0;background:#0b1223}
    .history-row-head{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .history-row-body{display:none;margin-top:8px}
    .history-row.open .history-row-body{display:block}
    .history-meta{color:var(--muted);font-size:12px}

    @media (max-width:600px){
      html,body{font-size:13px}
      main{padding:8px}
      .section{padding:10px}
      .row{gap:6px}
      button{padding:7px 9px}
      table{min-width:0}
      .brand img{width:28px;height:28px}
    }
  </style>
</head>
<body>

  <!-- ===== Header ===== -->
  <header>
    <div class="appbar">
      <div class="brand">
        <img src="/RecargApp/icons/icon-192x192.png" alt="Logo">
      </div>
      <div class="brand-title">RecargApp</div>
      <div class="actions">
        <span id="lockState" class="muted lock" style="align-self:center">Modo lectura</span>
        <button class="btn btn-login" id="btnToggleAdmin" title="Ingresar PIN">
          <span class="ico">üîí</span><span class="label">Iniciar sesi√≥n</span>
        </button>
        <button class="btn icon-btn" id="btnCambiarPinAdmin" style="display:none" title="Cambiar PIN del Admin">üîë</button>
        <button class="btn" id="btnInstall" style="display:none" title="Instalar app">Instalar</button>
      </div>
    </div>

    <div class="tabs-wrap">
      <div class="tabs">
        <div class="tab active" data-tab="hoy">Recargos</div>
        <div class="tab" data-tab="general">Lista</div>
        <div class="tab" data-tab="historial">Historial</div>
      </div>
    </div>
  </header>

  <main>
    <div id="banner" class="banner"></div>

    <!-- TAB: HOY -->
    <section class="section" data-panel="hoy">
      <h2 id="tituloDia">RECARGOS DEL D√çA</h2>

      <div class="row">
        <label>Fecha</label>
        <input id="fecha" type="date" style="max-width:160px">
        <label>Faltantes</label>
        <input id="faltantes" type="number" value="1" min="0" style="max-width:90px">
        <button class="btn" id="btnActualizar" title="Refrescar lista">üîÑ Actualizar</button>
        <button class="btn" id="btnCopiarListado" title="Copiar s√≥lo el orden (sin pasivos)">Copiar orden</button>
        <button class="btn" id="btnAgregarExtra" title="Agregar extra">‚ûï Agregar extra</button>
        <button class="danger" id="btnReiniciar" style="margin-left:auto">‚ö†Ô∏è Reiniciar rotaci√≥n</button>
      </div>

      <div>
        <h2>Listado del d√≠a</h2>
        <div class="tableWrap">
          <table id="tablaDia">
            <thead>
              <tr>
                <th>#</th><th>Nombre</th><th>Jerarqu√≠a</th><th>Estado</th><th>Pabell√≥n</th><th>Obs recargo</th><th>Acc</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="note">* <span class="pill warn">ART</span>, <span class="pill ok">AUTORIZADO</span>, <span class="pill">SALTEADO</span> o <span class="pill err">LICENCIA</span> se muestran pero <b>no numeran</b>. Con <b>Presente de ART</b> (13/26/04) suben y cuentan. ‚Äú(debe X)‚Äù se ve en la fila.</div>
      </div>

      <!-- Pasivos DEBAJO -->
      <div style="margin-top:14px">
        <h2>Pasivos</h2>
        <div class="row">
          <label>Franco de pasivos</label>
          <select id="francoPasivos" style="max-width:160px">
            <option value="1" selected>1¬∞ Franco</option>
            <option value="2">2¬∞ Franco</option>
          </select>
        </div>
        <div class="tableWrap" style="margin-top:6px">
          <table id="tablaPasivos">
            <thead><tr><th>#</th><th>Nombre</th><th>Jerarqu√≠a</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Botonera separada y con copiar/imp derecha -->
      <div class="actions-line">
        <div class="left-actions">
          <button class="primary" id="btnConfirmar">Confirmar guardia</button>
          <button class="btn" id="btnUndo">Deshacer</button>
        </div>
        <div class="right-actions">
          <button class="btn" id="btnImprimirPasivos">Imprimir pasivos</button>
          <button class="btn" id="btnCopiarResultado">Copiar recargos+pasivos</button>
        </div>
      </div>
    </section>

    <!-- TAB: GENERAL -->
    <section class="section" data-panel="general" style="display:none">
      <h2>Listado general (Editar requiere <b>Admin</b>)</h2>
      <div class="row">
        <input id="nombre" placeholder="Nombre y Apellido" style="max-width:240px">
        <input id="dni" placeholder="DNI" style="max-width:140px">
        <input id="legajo" placeholder="Legajo" style="max-width:140px">
        <select id="jerarquia" style="max-width:160px">
          <option>AYTE MY (CG)</option><option>AYTE PR (CG)</option><option>AYTE 1¬∞ (CG)</option><option>AYTE 2¬∞ (CG)</option><option>AYTE 3¬∞ (CG)</option><option>AYTE 4¬∞ (CG)</option><option>AYTE 5¬∞ (CG)</option><option>SUBAYTE (CG)</option><option>- vacio -</option>
        </select>
        <input id="antiguedad" type="number" placeholder="Antig√ºedad (a√±os)" style="max-width:140px">
        <button class="primary" id="btnAgregar">Agregar</button>
        <button class="btn" id="btnOrdenarCriterios">Ordenar (Jerarqu√≠a ‚Üí Antig√ºedad)</button>
        <button class="btn" id="btnDeshacerOrden" title="Volver al orden anterior">Deshacer orden</button>
        <button class="warn" id="btnEditarGeneral" title="Editar en l√≠nea y arrastrar">Editar</button>
      </div>
      <div class="tableWrap">
        <table id="tablaGeneral" style="margin-top:6px">
          <thead><tr>
            <th>Orden</th><th>Nombre</th><th>DNI</th><th>Legajo</th><th>Jerarqu√≠a</th><th>Antig.</th><th>Debe</th><th>Obs</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="btnExportar">Exportar JSON</button>
        <button class="btn" id="btnImportar">Importar JSON</button>
      </div>
      <div class="note">ART/LIC/AUT/SALTEAR se gestionan desde la pesta√±a <b>Recargos</b>.</div>
    </section>

    <!-- TAB: HISTORIAL -->
    <section class="section" data-panel="historial" style="display:none">
      <h2>Historial</h2>

      <!-- Subtabs -->
      <div class="subtabs">
        <div class="subtab active" data-sub="rec">Recargos</div>
        <div class="subtab" data-sub="chg">Cambios</div>
      </div>

      <!-- Toolbars -->
      <div id="toolbarRec" class="history-toolbar">
        <button class="btn" id="btnGuardarLlamados">Guardar llamados (√∫ltimo)</button>
        <button class="danger" id="btnBorrarHistRec">Borrar historial de recargos</button>
      </div>
      <div id="toolbarChg" class="history-toolbar" style="display:none">
        <button class="danger" id="btnBorrarHistChg">Borrar historial de cambios</button>
      </div>

      <!-- Contenedores -->
      <div id="histRec"></div>
      <div id="histChg" style="display:none"></div>
    </section>
  </main>

  <!-- Modal de acciones -->
  <div id="backdrop">
    <div class="modal">
      <h3 style="margin:0 0 8px;font-size:15px">Acciones para <span id="modalNombre"></span></h3>
      <div class="row">
        <button class="btn danger icon-btn" onclick="modalSetArt('13')">13</button>
        <button class="btn warn icon-btn" onclick="modalSetArt('26')">26</button>
        <button class="btn icon-btn" onclick="modalSetArt('clear')" title="Quitar ART">‚úï</button>
        <button class="btn primary" onclick="modalTogglePresente04()">Presente 04</button>
      </div>
      <hr style="border-color:#1f2937; margin:10px 0">
      <div class="row">
        <label>Licencia desde</label>
        <input id="licDesde" type="date" style="max-width:180px">
        <label>hasta</label>
        <input id="licHasta" type="date" style="max-width:180px">
        <button class="btn" onclick="modalSetLic()">Guardar licencia</button>
        <button class="danger" onclick="modalClearLic()">Quitar licencia</button>
      </div>
      <hr style="border-color:#1f2937; margin:10px 0">
      <div class="row">
        <button class="btn" onclick="modalToggleAutorizado()">AUTORIZADO</button>
        <button class="btn" onclick="modalToggleSalteado()">SALTEAR</button>
      </div>
      <div class="row" style="margin-top:6px;justify-content:flex-end">
        <button class="primary" onclick="closeModal()">Listo</button>
      </div>
    </div>
  </div>

<script>
/* ===== utils ===== */
function $all(sel, root){ return Array.prototype.slice.call((root||document).querySelectorAll(sel)); }
function $qs(root, sel){ return (root||document).querySelector(sel); }
window.addEventListener('error', e=>{ try{ alert('Error JS: ' + e.message); }catch(_){} console.error(e); });

/* ===== Modelo =====
Persona: {id, nombre, dni, legajo, jerarquia, antiguedad, obs:{art:null|"13"|"26", licencia:{desde:null,hasta:null}, autorizado:boolean}, order, rorder, debeLista:number, salteado:boolean}
Historial recargos: {fecha, recargos:[...], pasivos:[...], llamados:[id], layout:[...], personasBefore, generalHeadBefore, franco:1|2, extras:[{...}]}
Historial cambios: {ts, fechaISO, tipo:'add'|'del'|'move', detalle:{...}}
*/
const KEY='recargapp.v1';
let ADMIN_PIN = localStorage.getItem('recargapp.admin.pin') || '1111';
const SUPERADMIN_PIN='9999';

function setAdminPin(newPin){ ADMIN_PIN=String(newPin); localStorage.setItem('recargapp.admin.pin', ADMIN_PIN); }
function save(){ localStorage.setItem(KEY, JSON.stringify(db)); }
function load(){ try{ return JSON.parse(localStorage.getItem(KEY)||'null'); }catch(e){ return null; } }
function uid(){ return Math.random().toString(36).slice(2,9); }
function today(){ return new Date().toISOString().slice(0,10); }
function fmtDM(s){ var a=s.split('-'); return a[2]+"/"+a[1]; }
function addDays(iso,n){ var d=new Date(iso); d.setDate(d.getDate()+n); return d.toISOString().slice(0,10); }
function inLicencia(p, fecha){ var L=p.obs.licencia; if(!L||!L.desde||!L.hasta) return false; return (fecha>=L.desde && fecha<=L.hasta); }
function isDayAfter(dateStr, baseStr){ if(!dateStr||!baseStr) return false; var d=new Date(dateStr), b=new Date(baseStr); var next = new Date(d.getTime()+86400000); return next.toISOString().slice(0,10)===b.toISOString().slice(0,10); }

let db = load() || { personas: [], historial: [], generalHead: 0, cambios: [] };
if(!db.cambios) db.cambios=[];
if(db.personas){ var base=Date.now(); db.personas.forEach(function(p,i){ if(p.rorder==null){ p.rorder = (typeof p.order==='number')? p.order : (base+i); } if(typeof p.debeLista!=='number'){ p.debeLista=0; } if(!p.obs){ p.obs={art:null, licencia:{desde:null,hasta:null}, autorizado:false}; } }); }

let prioridadHoy = {}; // {id:'ART13'|'ART26'|'ART04'}
let modalId=null;
let role='viewer';
let manualDateChanged=false;

/* ===== Undo (Ctrl+Z l√≥gico) ===== */
const undoStack=[];
function snapshot(label){
  undoStack.push({
    label:label||'',
    personas: JSON.parse(JSON.stringify(db.personas)),
    generalHead: db.generalHead,
    prioridadHoy: JSON.parse(JSON.stringify(prioridadHoy)),
    extras: JSON.parse(JSON.stringify(dayExtras)),
    franco: getFranco()
  });
  if(undoStack.length>80) undoStack.shift();
}
function restoreLast(){
  var last=undoStack.pop(); if(!last) return false;
  db.personas = last.personas; db.generalHead = last.generalHead;
  prioridadHoy = last.prioridadHoy; dayExtras = last.extras||[];
  setFranco(last.franco||1);
  save(); renderAll(); return true;
}

/* ===== Logging de cambios del listado general ===== */
function logCambio(tipo, detalle){
  db.cambios.push({ts:Date.now(), fechaISO:today(), tipo:tipo, detalle:detalle});
  if(db.cambios.length>2000) db.cambios.shift();
  save();
}

/* ===== Accesos ===== */
var lockState=$qs(null,'#lockState');
var btnToggleAdmin=$qs(null,'#btnToggleAdmin');
var btnCambiarPinAdmin=$qs(null,'#btnCambiarPinAdmin');
function isAdmin(){ return role==='admin' || role==='superadmin'; }
function isSuper(){ return role==='superadmin'; }

/* ===== Banner helper ===== */
function showBanner(msg, opts){
  opts = opts || {};
  var b=$qs(null,'#banner'); if(!b) return;
  if(opts.html){ b.innerHTML = msg; } else { b.textContent = msg; }
  b.style.display='block';
  if(showBanner._t){ clearTimeout(showBanner._t); showBanner._t=null; }
  if(!opts.sticky){ showBanner._t=setTimeout(function(){ b.style.display='none'; }, opts.timeout || 3200); }
}

/* ===== Login / roles ===== */
if(btnCambiarPinAdmin){
  btnCambiarPinAdmin.onclick=function(){
    if(!isSuper()) return alert('Solo superadmin');
    var np=prompt('Nueva contrase√±a de ADMIN (4-8 d√≠gitos):'); if(np==null) return;
    np=np.trim(); if(!/^\d{4,8}$/.test(np)) return alert('Debe ser de 4 a 8 d√≠gitos.');
    setAdminPin(np); showBanner('Contrase√±a de ADMIN actualizada ‚úÖ');
  };
}
btnToggleAdmin.onclick=function(){
  if(role!=='viewer'){ role='viewer'; lockState.textContent='Modo lectura'; btnToggleAdmin.title='Ingresar PIN'; btnCambiarPinAdmin.style.display='none'; renderAll(); return; }
  var code=prompt('Ingres√° PIN (Admin o Superadmin)');
  if(code===ADMIN_PIN){ role='admin'; lockState.textContent='Modo ADMIN'; btnToggleAdmin.title='Cerrar sesi√≥n'; btnCambiarPinAdmin.style.display='none'; renderAll(); }
  else if(code===SUPERADMIN_PIN){ role='superadmin'; lockState.textContent='üëë SUPERADMIN'; btnToggleAdmin.title='Cerrar sesi√≥n'; btnCambiarPinAdmin.style.display='inline-block'; renderAll(); }
  else if(code!==null){ alert('PIN incorrecto'); }
};

/* ===== Tabs ===== */
var tabs = $all('.tab'); var panels = $all('[data-panel]');
tabs.forEach(function(t){
  t.addEventListener('click', function(){
    tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active');
    var name=t.getAttribute('data-tab');
    panels.forEach(p=>p.style.display = (p.getAttribute('data-panel')===name)?'block':'none');
    renderAll();
  });
});

/* ===== General ===== */
var snapshotOrden=null, editGeneral=false;
var nombreEl=$qs(null,'#nombre'), dniEl=$qs(null,'#dni'), legajoEl=$qs(null,'#legajo'), jerarquiaEl=$qs(null,'#jerarquia'), antigEl=$qs(null,'#antiguedad');

$qs(null,'#btnAgregar').onclick=function(){
  if(!isAdmin()) return alert('Solo Admin');
  if(!nombreEl.value.trim()) return alert('Nombre requerido');
  snapshot('agregar persona');
  var p={ id:uid(), nombre:nombreEl.value.trim(), dni:dniEl.value.trim(), legajo:legajoEl.value.trim(), jerarquia:jerarquiaEl.value, antiguedad:parseInt(antigEl.value||'0',10), obs:{art:null, licencia:{desde:null,hasta:null}, autorizado:false}, order:Date.now(), rorder:Date.now(), debeLista:0, salteado:false };
  db.personas.push(p);
  logCambio('add', {id:p.id, nombre:p.nombre});
  save(); nombreEl.value=''; dniEl.value=''; legajoEl.value=''; antigEl.value=''; renderGeneral(); renderHoy();
};

$qs(null,'#btnOrdenarCriterios').onclick=function(){
  if(!isAdmin()) return alert('Solo Admin');
  snapshot('ordenar por jerarqu√≠a/antig√ºedad');
  snapshotOrden = db.personas.map(p=>p.id);
  var rank={'AYTE MY (CG)':1,'AYTE PR (CG)':2,'AYTE 1¬∞ (CG)':3,'AYTE 2¬∞ (CG)':4,'AYTE 3¬∞ (CG)':5,'AYTE 4¬∞ (CG)':6,'AYTE 5¬∞ (CG)':7,'SUBAYTE (CG)':8,'- vacio -':9};
  db.personas.sort((a,b)=> (rank[a.jerarquia]-rank[b.jerarquia]) || ((b.antiguedad||0)-(a.antiguedad||0)));
  var base=Date.now(); db.personas.forEach((p,i)=>{ p.order=base+i; });
  logCambio('bulk-reorder',{motivo:'jerarquia-antiguedad'});
  save(); renderGeneral(); renderHoy();
};

$qs(null,'#btnDeshacerOrden').onclick=function(){
  if(!isAdmin()) return alert('Solo Admin');
  if(!snapshotOrden) return alert('No hay orden anterior guardado');
  snapshot('deshacer orden criterios');
  var base=Date.now(); snapshotOrden.forEach(function(id,i){ var p=getById(id); if(p){ p.order=base+i; } });
  logCambio('bulk-reorder',{motivo:'deshacer-criterios'});
  save(); renderGeneral(); renderHoy();
};

$qs(null,'#btnEditarGeneral').onclick=function(){
  if(!isAdmin()) return alert('Solo Admin');
  editGeneral=!editGeneral;
  $qs(null,'#btnEditarGeneral').textContent = editGeneral? 'Guardar edici√≥n' : 'Editar';
  renderGeneral();
};

function renderGeneral(){
  var tbody=$qs(null,'#tablaGeneral tbody'); tbody.innerHTML='';
  var list=[].concat(db.personas).sort((a,b)=>a.order-b.order);
  list.forEach(function(p,i){
    var tr=document.createElement('tr'); tr.setAttribute('data-id', p.id);

    if(editGeneral){
      tr.setAttribute('draggable','true');
      tr.ondragstart=function(ev){ ev.dataTransfer.setData('text/plain', p.id); tr.classList.add('dragging'); };
      tr.ondragend=function(){ tr.classList.remove('dragging'); };
      tr.ondragover=function(ev){ ev.preventDefault(); tr.style.outline='1px dashed #334155'; };
      tr.ondragleave=function(){ tr.style.outline=''; };
      tr.ondrop=function(ev){
        ev.preventDefault(); tr.style.outline='';
        var fromId=ev.dataTransfer.getData('text/plain'); if(!fromId||fromId===p.id) return;
        snapshot('drag reorder general');
        var ordered=[].concat(db.personas).sort((a,b)=>a.order-b.order);
        var fromIdx=ordered.findIndex(x=>x.id===fromId);
        var toIdx=ordered.findIndex(x=>x.id===p.id);
        if(fromIdx<0||toIdx<0) return;
        var moved=ordered.splice(fromIdx,1)[0]; ordered.splice(toIdx,0,moved);
        var base=Date.now(); ordered.forEach((x,idx)=>{ x.order=base+idx; });
        logCambio('move',{id:moved.id,nombre:moved.nombre,from:fromIdx+1,to:toIdx+1});
        save(); renderGeneral(); renderHoy();
      };
    }

    function cell(txt){ return '<td>'+txt+'</td>'; }
    var delBtn = editGeneral ? " <button class='danger icon-btn' title='Eliminar' onclick=\"eliminar('"+p.id+"')\">‚úï</button>" : "";
    var cOrden = cell(i+1);
    var cNombre = editGeneral
      ? '<td>'+p.nombre+delBtn+'</td>'
      : '<td>'+p.nombre+'</td>';
    var cDNI = editGeneral ? '<td><input value="'+(p.dni||'')+'" onblur="setField(\''+p.id+'\',\'dni\',this.value)"></td>' : cell(p.dni||'');
    var cLegajo = editGeneral ? '<td><input value="'+(p.legajo||'')+'" onblur="setField(\''+p.id+'\',\'legajo\',this.value)"></td>' : cell(p.legajo||'');
    var jerOpts = ['AYTE MY (CG)','AYTE PR (CG)','AYTE 1¬∞ (CG)','AYTE 2¬∞ (CG)','AYTE 3¬∞ (CG)','AYTE 4¬∞ (CG)','AYTE 5¬∞ (CG)','SUBAYTE (CG)','- vacio -'].map(function(j){ return '<option '+(p.jerarquia===j?'selected':'')+'>'+j+'</option>'; }).join('');
    var cJer = editGeneral ? '<td><select onchange="setField(\''+p.id+'\',\'jerarquia\',this.value)">'+jerOpts+'</select></td>' : cell(p.jerarquia);
    var cAnt = editGeneral ? '<td><input type="number" min="0" value="'+(p.antiguedad||0)+'" onblur="setField(\''+p.id+'\',\'antiguedad\',parseInt(this.value||\'0\',10))"></td>' : cell(p.antiguedad||0);
    var cDebe = editGeneral ? '<td><input type="number" min="0" value="'+(p.debeLista||0)+'" onblur="setField(\''+p.id+'\',\'debeLista\',parseInt(this.value||\'0\',10))"></td>' : cell(p.debeLista||0);

    var obsParts=[]; if(p.obs.art) obsParts.push('ART '+p.obs.art);
    if(p.obs.licencia && p.obs.licencia.desde && p.obs.licencia.hasta) obsParts.push('LIC '+p.obs.licencia.desde+'‚Üí'+p.obs.licencia.hasta);
    if(p.obs.autorizado) obsParts.push('AUTORIZADO'); if(p.salteado) obsParts.push('SALTEADO');
    var cObs = cell(obsParts.join(' ¬∑ ')||'<span class="muted">‚Äî</span>');

    tr.innerHTML = cOrden + cNombre + cDNI + cLegajo + cJer + cAnt + cDebe + cObs;
    if(!isAdmin()){
      $all('button,input,select', tr).forEach(function(el){ el.setAttribute('disabled','disabled'); el.classList.add('lock'); el.title='Solo Admin'; });
    }
    tbody.appendChild(tr);
  });
}

window.setField=function(id,key,val){
  if(!isAdmin()) return alert('Solo Admin'); var p=getById(id); if(!p) return;
  snapshot('editar campo '+key); p[key]=val; save();
};

function eliminar(id){
  if(!isAdmin()) return alert('Solo Admin');
  var p=getById(id); if(!p) return;
  if(!confirm('¬øEliminar a "'+p.nombre+'" de la lista general?')) return;
  snapshot('eliminar persona');
  db.personas=db.personas.filter(x=>x.id!==id);
  logCambio('del',{id:id,nombre:p.nombre});
  save(); renderGeneral(); renderHoy();
}
function getById(id){ for(var i=0;i<db.personas.length;i++) if(db.personas[i].id===id) return db.personas[i]; return null; }

/* ===== HOY ===== */
var fechaEl=$qs(null,'#fecha'); var faltEl=$qs(null,'#faltantes'); fechaEl.value=today();
function setTitulo(){ $qs(null,'#tituloDia').textContent = 'RECARGOS '+fmtDM(fechaEl.value); }
setTitulo();
fechaEl.addEventListener('change', function(){ setTitulo(); manualDateChanged=true; });

/* Extras (ajenos a la lista; nombre/jerarqu√≠a opcionales; en copiado van con "-") */
let dayExtras = []; // [{id, nombre?, jerarquia?, pabellon, obsRecargo}]
$qs(null,'#btnAgregarExtra').onclick=function(){
  if(!isAdmin()) return alert('Solo Admin');
  var nombre = prompt('Nombre del extra (opcional):') || '';
  var jer = prompt('Jerarqu√≠a del extra (opcional):') || '';
  var obs = prompt('Observaci√≥n (opcional):') || '';
  snapshot('agregar extra');
  dayExtras.push({ id:'extra_'+uid(), nombre:nombre.trim(), jerarquia:jer.trim(), pabellon:'', obsRecargo: obs.trim() });
  renderHoy();
};

function generalList(){ return [].concat(db.personas).sort((a,b)=>a.order-b.order); }
function elegibles(){ return [].concat(db.personas).sort((a,b)=>(a.rorder||0)-(b.rorder||0)); }

function getFranco(){ var f=$qs(null,'#francoPasivos'); return f? parseInt(f.value||'1',10):1; }
function setFranco(v){ var f=$qs(null,'#francoPasivos'); if(f){ f.value=String(v||1); } }

/* Prioridad visual/selecci√≥n */
function getPlan(){
  var falt=Math.max(0, parseInt(faltEl.value||'0',10));
  var fecha=fechaEl.value;
  var base=elegibles();

  var prioIds=Object.keys(prioridadHoy);
  var pART = base.filter(p=> prioridadHoy[p.id]==='ART13' || prioridadHoy[p.id]==='ART26');
  var p04  = base.filter(p=> prioridadHoy[p.id]==='ART04');
  var resto= base.filter(p=> prioIds.indexOf(p.id)===-1);

  resto.sort(function(a,b){
    var da=(a.debeLista||0), dbb=(b.debeLista||0);
    if(dbb!==da) return dbb-da;
    return (a.rorder||0)-(b.rorder||0);
  });

  var mostrados=[], numerados=[];

  /* Extras al inicio (cuentan en la asignaci√≥n, pero en copiado van con "-") */
  dayExtras.forEach(function(ex){
    mostrados.push({extra:true, data:ex});
    numerados.push(ex);
  });

  function pushPersona(p, forzarContar){
    var saltPorFlag = p.salteado===true;
    var saltar = !forzarContar && (p.obs.art || p.obs.autorizado || inLicencia(p,fecha) || saltPorFlag);
    mostrados.push({p:p, saltar:saltar, saltPorFlag:saltPorFlag});
    if(!saltar) numerados.push(p);
  }
  pART.forEach(p=>pushPersona(p,true));
  p04.forEach(p=>pushPersona(p,true));
  resto.forEach(p=>pushPersona(p,false));

  var asignados = numerados.slice(0,falt);
  var idxUlt=falt-1;
  var pasivos = (idxUlt>=0)? numerados.slice(idxUlt+1, idxUlt+3) : numerados.slice(0,2);

  return {mostrados:mostrados, asignados:asignados, pasivos:pasivos};
}

/* Modal */
function openModal(id){
  if(!isAdmin()) return alert('Solo Admin');
  modalId=id; var p=getById(id);
  $qs(null,'#modalNombre').textContent = p? p.nombre : '';
  var L=p && p.obs? p.obs.licencia : null;
  $qs(null,'#licDesde').value = L && L.desde ? L.desde : '';
  $qs(null,'#licHasta').value = L && L.hasta ? L.hasta : '';
  $qs(null,'#backdrop').style.display='flex';
}
function closeModal(){ $qs(null,'#backdrop').style.display='none'; modalId=null; }
function modalSetArt(val){
  if(!modalId) return; if(!isAdmin()) return alert('Solo Admin'); var p=getById(modalId); if(!p) return;
  snapshot('set ART '+val); p.obs.art = (val==='clear')? null : val; save(); renderHoy(); renderGeneral();
}
function modalSetLic(){
  if(!modalId) return; if(!isAdmin()) return alert('Solo Admin');
  var d=$qs(null,'#licDesde').value; var h=$qs(null,'#licHasta').value; if(!d||!h) return alert('Complet√° desde y hasta');
  snapshot('set licencia'); var p=getById(modalId); p.obs.licencia={desde:d,hasta:h}; save(); renderHoy(); renderGeneral(); alert('Licencia guardada');
}
function modalTogglePresente04(){
  if(!modalId) return; if(!isAdmin()) return alert('Solo Admin');
  snapshot('toggle presente 04');
  var id=modalId; if(prioridadHoy[id]==='ART04') delete prioridadHoy[id]; else prioridadHoy[id]='ART04'; renderHoy();
}
function modalClearLic(){
  if(!modalId) return; if(!isAdmin()) return alert('Solo Admin');
  snapshot('clear licencia');
  var p=getById(modalId); p.obs.licencia={desde:null,hasta:null}; save(); renderHoy(); renderGeneral(); alert('Licencia quitada');
}
function modalToggleAutorizado(){
  if(!modalId) return; if(!isAdmin()) return alert('Solo Admin');
  snapshot('toggle autorizado');
  var p=getById(modalId); p.obs.autorizado=!p.obs.autorizado; save(); renderHoy(); renderGeneral();
}
function modalToggleSalteado(){
  if(!modalId) return; if(!isAdmin()) return alert('Solo Admin');
  snapshot('toggle salteado');
  var p=getById(modalId); p.salteado=!p.salteado; save(); renderHoy(); renderGeneral();
}

/* Render del d√≠a */
function renderHoy(){
  setTitulo();
  var fecha=fechaEl.value;
  var prev={};
  // conservar selecciones previas (pab/obs recargo, incl. extras)
  $all('#tablaDia tbody tr').forEach(function(r){
    var id=r.getAttribute('data-id');
    var sel=r.querySelector('select'); var inp=r.querySelector('input[type="text"]');
    if(!id) return;
    prev[id]={pab: sel?sel.value:'', obs: inp?inp.value:''};
  });

  var tb=$qs(null,'#tablaDia tbody'); tb.innerHTML=''; var n=0;
  db.personas.forEach(function(p){
    if(p && p.obs && p.obs.licencia && isDayAfter(p.obs.licencia.hasta, fecha)){
      if(!prioridadHoy[p.id]) prioridadHoy[p.id]='ART04';
    }
  });

  var plan=getPlan();
  plan.mostrados.forEach(function(item){
    if(item.extra){
      var ex=item.data;
      var tr=document.createElement('tr'); tr.setAttribute('data-id', ex.id);
      var numCell=document.createElement('td'); numCell.textContent = (++n);

      var pabSel=document.createElement('select');
      ['', 'Vigilancia','Pab 1','Pab 3S','Pab 3N','Pab 5S','Pab 5N','Pab 7','Pab 9','Pab 11','Pab Aisl','Cruz','Port√≥n'].forEach(function(x){
        var opt=document.createElement('option'); opt.textContent=x; pabSel.appendChild(opt);
      });
      if(prev[ex.id] && prev[ex.id].pab) pabSel.value=prev[ex.id].pab;
      if(!isAdmin()){ pabSel.disabled=true; pabSel.classList.add('lock'); }
      var obsRecInput=document.createElement('input'); obsRecInput.type='text';
      obsRecInput.placeholder='(observaci√≥n)'; obsRecInput.value = (prev[ex.id] && prev[ex.id].obs) ? prev[ex.id].obs : (ex.obsRecargo||'');
      if(!isAdmin()){ obsRecInput.disabled=true; obsRecInput.classList.add('lock'); }
      var actCell=document.createElement('td'); var actions=document.createElement('div'); actions.className='row';
      actions.innerHTML = isAdmin()? "<button class='btn icon-btn' title='Quitar extra' onclick=\"quitarExtra('"+ex.id+"')\">‚úï</button>":"";
      actCell.appendChild(actions);

      tr.appendChild(numCell);
      tr.insertAdjacentHTML('beforeend', "<td>"+(ex.nombre||'<i>Extra</i>')+"</td><td>"+(ex.jerarquia||'‚Äî')+"</td><td><span class='pill'>EXTRA</span></td>");
      var pabCell=document.createElement('td'); pabCell.appendChild(pabSel);
      var obsCell=document.createElement('td'); obsCell.appendChild(obsRecInput);
      tr.appendChild(pabCell); tr.appendChild(obsCell); tr.appendChild(actCell);
      tb.appendChild(tr);
      return;
    }

    // Personas
    var p=item.p, saltar=item.saltar, saltPorFlag=item.saltPorFlag;
    var tr=document.createElement('tr'); tr.setAttribute('data-id', p.id);

    var obsParts=[];
    if(p.obs && p.obs.art) obsParts.push("<span class='pill warn'>ART "+p.obs.art+"</span>");
    if(inLicencia(p,fecha)) obsParts.push("<span class='pill err'>LIC "+p.obs.licencia.desde+"‚Üí"+p.obs.licencia.hasta+"</span>");
    if(p.obs && p.obs.autorizado) obsParts.push("<span class='pill ok'>AUTORIZADO</span>");
    if(saltPorFlag) obsParts.push("<span class='pill'>SALTEADO</span>");
    if((p.debeLista||0)>0) obsParts.push("<span class='pill'>debe "+p.debeLista+"</span>");
    var prio = prioridadHoy[p.id];
    if(prio){ var label = prio==='ART13'?'PRESENTE ART 13' : (prio==='ART26'?'PRESENTE ART 26':'PRESENTE 04'); obsParts.unshift("<span class='pill'>"+label+"</span>"); }

    var numCell=document.createElement('td'); numCell.textContent = saltar? '-' : (++n);

    var pabSel=document.createElement('select');
    ['', 'Vigilancia','Pab 1','Pab 3S','Pab 3N','Pab 5S','Pab 5N','Pab 7','Pab 9','Pab 11','Pab Aisl','Cruz','Port√≥n'].forEach(function(x){
      var opt=document.createElement('option'); opt.textContent=x; pabSel.appendChild(opt);
    });
    if(prev[p.id] && prev[p.id].pab) pabSel.value=prev[p.id].pab;
    if(saltar || !isAdmin()) { pabSel.disabled=true; pabSel.classList.add('lock'); }
    var pabCell=document.createElement('td'); pabCell.appendChild(pabSel);

    var obsRecInput=document.createElement('input'); obsRecInput.type='text'; obsRecInput.placeholder='(ej. cubre Ibarra)';
    if(prev[p.id] && prev[p.id].obs) obsRecInput.value=prev[p.id].obs;
    if(!isAdmin()){ obsRecInput.disabled=true; obsRecInput.classList.add('lock'); }
    var obsRecCell=document.createElement('td'); obsRecCell.appendChild(obsRecInput);

    var actCell=document.createElement('td'); var actions=document.createElement('div'); actions.className='row';
    actions.innerHTML = "<button class='btn icon-btn' aria-label='Acciones' onclick=\"openModal('"+p.id+"')\" "+(!isAdmin()?"disabled title='Solo Admin'":"")+">‚öôÔ∏è</button>";
    if(p.obs && p.obs.art==='13') actions.innerHTML += "<button class='btn danger icon-btn' "+(!isAdmin()?"disabled title='Solo Admin'":"")+" onclick=\"togglePresente('"+p.id+"','ART13')\">13</button>";
    if(p.obs && p.obs.art==='26') actions.innerHTML += "<button class='btn warn icon-btn' "+(!isAdmin()?"disabled title='Solo Admin'":"")+" onclick=\"togglePresente('"+p.id+"','ART26')\">26</button>";
    actCell.appendChild(actions);

    tr.appendChild(numCell);
    tr.insertAdjacentHTML('beforeend', "<td>"+p.nombre+"</td><td>"+p.jerarquia+"</td><td>"+(obsParts.join(' ')||'<span class=\"muted\">‚Äî</span>')+"</td>");
    tr.appendChild(pabCell); tr.appendChild(obsRecCell); tr.appendChild(actCell);
    tb.appendChild(tr);
  });

  // Pasivos
  var tpas=$qs(null,'#tablaPasivos tbody'); tpas.innerHTML='';
  plan.pasivos.forEach(function(p,i){
    if(!p.id){ return; }
    var tr=document.createElement('tr'); tr.setAttribute('data-id', p.id);
    tr.innerHTML="<td>"+(i+1)+"</td><td>"+p.nombre+"</td><td>"+p.jerarquia+"</td>";
    tpas.appendChild(tr);
  });
}

function quitarExtra(id){
  if(!isAdmin()) return;
  snapshot('quitar extra');
  dayExtras = dayExtras.filter(x=>x.id!==id);
  renderHoy();
}

function togglePresente(id,tipo){
  if(!isAdmin()) return alert('Solo Admin');
  snapshot('toggle presente '+tipo);
  if(prioridadHoy[id]===tipo) delete prioridadHoy[id]; else prioridadHoy[id]=tipo;
  renderHoy();
}

/* Copiar ORDEN (sin pasivos) */
$qs(null,'#btnCopiarListado').addEventListener('click', function(){
  var fecha=fechaEl.value, plan=getPlan();
  var lines=['RECARGOS '+fmtDM(fecha),'']; var n=0;

  function mapPab(p){ var m={'Vigilancia':'vigilancia','Pab 1':'pab 01','Pab 3S':'pab 03 sur','Pab 3N':'pab 03 norte','Pab 5S':'pab 05 sur','Pab 5N':'pab 05 norte','Pab 7':'pab 07','Pab 9':'pab 09','Pab 11':'pab 11','Pab Aisl':'pab aisl','Cruz':'cruz','Port√≥n':'port√≥n','':''}; return m[p||'']||p||''; }

  var tbRows=$all('#tablaDia tbody tr[data-id]');
  var byId={}; tbRows.forEach(function(r){
    var id=r.getAttribute('data-id');
    var sel=r.querySelector('select'); var inp=r.querySelector('input[type="text"]');
    byId[id]={pab: sel?sel.value:'', obs: inp?inp.value.trim():''};
  });

  plan.mostrados.forEach(function(item){
    if(item.extra){
      var ex=item.data, row=byId[ex.id]||{}; var pabTxt=mapPab(row.pab); var obs = row.obs?(' ('+row.obs+')'):'';
      var nombreOut = (ex.nombre || ex.obsRecargo || '‚Äî').trim();
      lines.push('- '+ nombreOut + (pabTxt?('  '+pabTxt):'') + (obs||''));
      return;
    }
    var p=item.p, saltar=item.saltar, prio=prioridadHoy[p.id], per=getById(p.id)||{};
    var tags=[]; if(prio){ tags.push(prio==='ART13'?'(por ART 13)': prio==='ART26'?'(por ART 26)':'(por ART 04)'); }
    if(per.obs && per.obs.autorizado) tags.push('(autorizado)');
    if(per.salteado) tags.push('(salteado)');
    if(per.obs && per.obs.art && !prio) tags.push('(ART '+per.obs.art+')');
    if(inLicencia(per, fecha)) tags.push('(licencia)');
    if((per.debeLista||0)>0) tags.push('(debe '+per.debeLista+')');

    var row=byId[p.id]||{}; var pabTxt=mapPab(row.pab); var obs = row.obs? (' ('+row.obs+')') : '';
    if(!saltar){ lines.push((++n)+') '+p.nombre+' '+tags.join(' ')+' '+obs+(pabTxt?('  '+pabTxt):'')); }
    else{ lines.push('- '+p.nombre+' '+tags.join(' ')); }
  });

  copyText(lines.join('\n'));
});

/* Copiar resultado final (recargos + pasivos) */
$qs(null,'#btnCopiarResultado').onclick=function(){
  var fecha=fechaEl.value, plan=getPlan(), falt=Math.max(0, parseInt(faltEl.value||'0',10));
  var lines=['RECARGOS '+fmtDM(fecha),''];
  function mapPab(p){ var m={'Vigilancia':'vigilancia','Pab 1':'pab 01','Pab 3S':'pab 03 sur','Pab 3N':'pab 03 norte','Pab 5S':'pab 05 sur','Pab 5N':'pab 05 norte','Pab 7':'pab 07','Pab 9':'pab 09','Pab 11':'pab 11','Pab Aisl':'pab aisl','Cruz':'cruz','Port√≥n':'port√≥n','':''}; return m[p||'']||p||''; }

  var tbRows=$all('#tablaDia tbody tr[data-id]'); var byId={};
  tbRows.forEach(function(r){ var id=r.getAttribute('data-id'); var sel=r.querySelector('select'); var inp=r.querySelector('input[type="text"]'); byId[id]={pab: sel?sel.value:'', obs: inp?inp.value.trim():''}; });

  var conteo=0;
  plan.mostrados.forEach(function(item){
    if(item.extra){
      var ex=item.data, row=byId[ex.id]||{}; var pabTxt=mapPab(row.pab); var obs=row.obs?(' ('+row.obs+')'):'';
      var nombreOut = (ex.nombre || ex.obsRecargo || '‚Äî').trim();
      // NO enumera extras
      lines.push('- '+ nombreOut + (pabTxt?('  '+pabTxt):'') + (obs||''));
      return;
    }
    var p=item.p, saltar=item.saltar;
    var prio=prioridadHoy[p.id], per=getById(p.id)||{};
    var tags=[]; if(prio){ tags.push(prio==='ART13'?'(por ART 13)': prio==='ART26'?'(por ART 26)':'(por ART 04)'); }
    if(per.obs && per.obs.autorizado) tags.push('(autorizado)');
    if(per.salteado) tags.push('(salteado)');
    if(per.obs && per.obs.art && !prio) tags.push('(ART '+per.obs.art+')');
    if(inLicencia(per, fecha)) tags.push('(licencia)');
    if((per.debeLista||0)>0) tags.push('(debe '+per.debeLista+')');

    var row=byId[p.id]||{}; var pabTxt=mapPab(row.pab); var obs = row.obs? (' ('+row.obs+')') : '';

    if(!saltar && conteo<falt){
      lines.push((++conteo)+') '+p.nombre+' '+tags.join(' ')+' '+obs+(pabTxt?('  '+pabTxt):''));
    }else if(saltar){
      lines.push('- '+p.nombre+' '+tags.join(' '));
    }
  });

  // Pasivos (Franco 1¬∞ o 2¬∞)
  var franco=getFranco();
  if(franco===1){ lines.push('','Pasivos',''); }
  else{
    var manana = fmtDM(addDays(fecha,1));
    lines.push('','Pasivos ('+manana+')','');
  }
  plan.pasivos.forEach(function(p,i){
    if(!p.id) return;
    var tr=$qs(null,'#tablaDia tbody tr[data-id="'+p.id+'"]');
    var inp=tr?tr.querySelector('input[type="text"]'):null; var obsRec=inp?inp.value.trim():'';
    var obs = obsRec? (' ('+obsRec+')') : '';
    lines.push((i+1)+') '+p.nombre+obs);
  });

  copyText(lines.join('\n'));
};

function copyText(txt){
  (navigator.clipboard && navigator.clipboard.writeText)
    ? navigator.clipboard.writeText(txt).then(()=>alert('Texto copiado'))
    : (function(){ var w=window.open('', '_blank'); w.document.write('<pre>'+txt.replace(/[<&>]/g,m=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[m]))+'</pre>'); w.document.close(); w.focus(); })();
}

/* Confirmar guardia */
$qs(null,'#btnConfirmar').onclick=function(){
  if(!isAdmin()) return alert('Solo Admin');
  snapshot('confirmar guardia (pre)');

  var plan=getPlan();
  var idsAsignados={}; plan.asignados.forEach(function(p){ if(p.id) idsAsignados[p.id]=true; });

  // Leer filas para obtener pab/obs (personas + extras)
  var rows=$all('#tablaDia tbody tr');
  var recargos=[]; var extrasForHist=[];
  rows.forEach(function(r){
    var id=r.getAttribute('data-id'); var sel=r.querySelector('select'); var inp=r.querySelector('input[type="text"]');
    var pab= sel?sel.value:''; var obsRec=inp?inp.value.trim():'';

    if(id && id.indexOf('extra_')===0){
      var ex=dayExtras.find(x=>x.id===id)||{};
      extrasForHist.push({id:id, nombre:ex.nombre||'', jerarquia:ex.jerarquia||'', pabellon:pab, obsRecargo:obsRec});
      return;
    }
    if(!id || !idsAsignados[id]) return;
    var per=getById(id); recargos.push({id:id,nombre:per?per.nombre:'',pabellon:pab,obsRecargo:obsRec});
  });

  var pasivos=plan.pasivos.filter(x=>x.id);
  var fecha=fechaEl.value, falt=Math.max(0, parseInt(faltEl.value||'0',10));
  var glist=generalList(); if(glist.length===0){ alert('No hay personal'); return; }
  if(db.generalHead>=glist.length) db.generalHead=0;

  // Ventana seg√∫n lista general
  var ventanaIdx=[], idx=db.generalHead;
  for(var k=0;k<falt && k<glist.length;k++){ ventanaIdx.push(idx); idx=(idx+1)%glist.length; }
  var ventanaIds=ventanaIdx.map(i=>glist[i].id);

  // Asignados reales
  var asignadosIds={}; recargos.forEach(r=>asignadosIds[r.id]=true);

  // Reglas DEBE (cap 1)
  ventanaIds.forEach(function(id){
    var p=getById(id); if(!p) return;
    var prio=prioridadHoy[id]; var lic=inLicencia(p,fecha);
    var quedoPorLista = !!asignadosIds[id] && !(prio==='ART13' || prio==='ART26' || prio==='ART04');
    if(quedoPorLista){ if((p.debeLista||0)>0) p.debeLista=0; }
    else{ if(lic) return; if(p.obs.art || p.obs.autorizado || prio){ if((p.debeLista||0)<1) p.debeLista=1; } }
  });

  // Avanzar puntero general
  db.generalHead = (db.generalHead + falt) % glist.length;

  // Reubicar rorder de asignados (solo personas)
  var baseOrder=Date.now();
  db.personas.forEach(p=>{ if(p.rorder==null) p.rorder=baseOrder; });
  recargos.forEach(function(r,i){ var p=getById(r.id); if(p) p.rorder = baseOrder + i + 1; });

  // Limpiar ART si se presentaron
  for(var pid in prioridadHoy){
    var why=prioridadHoy[pid];
    if(why==='ART13'||why==='ART26'){ var per=getById(pid); if(per){ per.obs.art=null; } }
  }

  // Salteados al fondo
  var tailBase=Date.now()+100000, kk=0;
  db.personas.forEach(function(p){ if(p.salteado){ p.rorder = tailBase+(++kk); } });

  // Limpiar banderas del d√≠a
  db.personas.forEach(function(p){ p.obs.autorizado=false; p.salteado=false; });

  // Layout inline para historial (incluye extras y no numerados)
  var conteo=0, layout=[];
  function mapPab(p){ var m={'Vigilancia':'vigilancia','Pab 1':'pab 01','Pab 3S':'pab 03 sur','Pab 3N':'pab 03 norte','Pab 5S':'pab 05 sur','Pab 5N':'pab 05 norte','Pab 7':'pab 07','Pab 9':'pab 09','Pab 11':'pab 11','Pab Aisl':'pab aisl','Cruz':'cruz','Port√≥n':'port√≥n','':''}; return m[p||'']||p||''; }
  var tbRows=$all('#tablaDia tbody tr');

  plan.mostrados.forEach(function(item){
    if(item.extra){
      var r = tbRows.find? tbRows.find(x=>x.getAttribute('data-id')===item.data.id) : null;
      var sel=r? r.querySelector('select'):null; var pab=sel?sel.value:'';
      var inp=r? r.querySelector('input[type="text"]'):null; var obsRec=inp?inp.value.trim():'';
      layout.push({id:item.data.id,nombre:(item.data.nombre||'Extra'),counted:false,tags:['(extra)'],pabellon:pab,obsRecargo:obsRec});
      return;
    }
    var p=item.p, saltar=item.saltar;
    var prio=prioridadHoy[p.id]; var per=getById(p.id)||{};
    var tags=[]; if(prio){ tags.push(prio==='ART13'?'(por ART 13)': prio==='ART26'?'(por ART 26)':'(por ART 04)'); }
    if(per.obs && per.obs.autorizado) tags.push('(autorizado)');
    if(per.salteado) tags.push('(salteado)');
    if(per.obs && per.obs.art && !prio) tags.push('(ART '+per.obs.art+')');
    if(inLicencia(per, fecha)) tags.push('(licencia)');
    if((per.debeLista||0)>0) tags.push('(debe '+per.debeLista+')');

    if(!saltar && conteo<falt){
      var tr=$qs(null,'#tablaDia tbody tr[data-id="'+p.id+'"]');
      var sel=tr?tr.querySelector('select'):null; var pab=sel?sel.value:'';
      var inp=tr?tr.querySelector('input[type="text"]'):null; var obsRec=inp?inp.value.trim():'';
      layout.push({id:p.id,nombre:p.nombre,counted:true,n:conteo+1,pabellon:pab,obsRecargo:obsRec,tags:tags});
      conteo++;
    }else if(saltar){
      layout.push({id:p.id,nombre:p.nombre,counted:false,tags:tags});
    }
  });

  save();
  db.historial.push({
    fecha:fmtDM(fecha),
    recargos:recargos,
    pasivos:pasivos.map(x=>({id:x.id,nombre:x.nombre})),
    llamados:[],
    layout:layout,
    personasBefore: JSON.parse(JSON.stringify(undoStack[undoStack.length-1]?.personas || db.personas)),
    generalHeadBefore: undoStack[undoStack.length-1]?.generalHead ?? db.generalHead,
    franco:getFranco(),
    extras:extrasForHist
  });
  save();
  prioridadHoy={}; dayExtras=[];

  // Avanzar 3 d√≠as solo si NO cambiaste la fecha manualmente
  if(!manualDateChanged){
    fechaEl.value = addDays(fechaEl.value, 3);
    setTitulo();
  }
  manualDateChanged=false;

  renderAll();
  alert('Guardia guardada. Los llamados se marcan en la guardia siguiente (Historial).');
};

/* Deshacer m√≠nimo */
$qs(null,'#btnUndo').onclick=function(){
  if(!isAdmin()) return alert('Solo Admin');
  if(!undoStack.length) return alert('No hay cambios para deshacer');
  if(!restoreLast()) alert('No se pudo deshacer');
};

/* ===== Historial (subtabs) ===== */
const subRec=$qs(null,'.subtab[data-sub="rec"]');
const subChg=$qs(null,'.subtab[data-sub="chg"]');
subRec.addEventListener('click', ()=>{
  subRec.classList.add('active'); subChg.classList.remove('active');
  $qs(null,'#histRec').style.display='block';
  $qs(null,'#histChg').style.display='none';
  $qs(null,'#toolbarRec').style.display='flex';
  $qs(null,'#toolbarChg').style.display='none';
});
subChg.addEventListener('click', ()=>{
  subChg.classList.add('active'); subRec.classList.remove('active');
  $qs(null,'#histRec').style.display='none';
  $qs(null,'#histChg').style.display='block';
  $qs(null,'#toolbarRec').style.display='none';
  $qs(null,'#toolbarChg').style.display='flex';
});

function renderHistorialRec(){
  var cont=$qs(null,'#histRec'); cont.innerHTML='';
  for(var idx=db.historial.length-1; idx>=0; idx--){
    var h=db.historial[idx];
    var esUltimo=(idx===db.historial.length-1);

    // Resumen cantidades
    var cantRec = (h.layout||[]).filter(x=>x.counted).length || (h.recargos||[]).length;
    var cantLlam = (h.llamados||[]).length;

    // Head (l√≠nea √∫nica)
    var row=document.createElement('div'); row.className='history-row';
    row.innerHTML =
      "<div class='history-row-head'>"+
        "<div><b>"+(h.fecha||'')+"</b> ¬∑ <span class='history-meta'>Recargos: "+cantRec+" ¬∑ Pasivos llamados: "+cantLlam+"</span></div>"+
        "<div>"+
          "<button class='btn' data-copy='"+idx+"'>Copiar</button> "+
          (isSuper()? "<button class='danger' data-del='"+idx+"'>Borrar</button>": "")+
          " <button class='btn' data-toggle='"+idx+"'>Ver</button>"+
        "</div>"+
      "</div>"+
      "<div class='history-row-body' id='body-"+idx+"'></div>";

    // Body (tarjeta)
    (function buildBody(){
      var body=row.querySelector('#body-'+idx);
      // Recargos
      var recListHtml='';
      if(h.layout && h.layout.length){
        recListHtml = h.layout.map(function(x){
          if(x.counted){
            var m={'Vigilancia':'vigilancia','Pab 1':'pab 01','Pab 3S':'pab 03 sur','Pab 3N':'pab 03 norte','Pab 5S':'pab 05 sur','Pab 5N':'pab 05 norte','Pab 7':'pab 07','Pab 9':'pab 09','Pab 11':'pab 11','Pab Aisl':'pab aisl','Cruz':'cruz','Port√≥n':'port√≥n','':''};
            var pabTxt=m[x.pabellon||'']||x.pabellon||'';
            var tags=(x.tags&&x.tags.length)?(' '+x.tags.join(' ')):'';
            var obs=x.obsRecargo?(' ‚Äî Obs: '+x.obsRecargo):'';
            var pab=pabTxt?(' ‚Äî Pab: '+pabTxt):'';
            return '<li>'+x.n+') '+x.nombre+tags+pab+obs+'</li>';
          }else{
            var tags2=(x.tags&&x.tags.length)?(' '+x.tags.join(' ')):'';
            return '<li>- '+x.nombre+tags2+'</li>';
          }
        }).join('');
      }else{
        recListHtml = (h.recargos||[]).map(function(x,i){
          return '<li>'+(i+1)+') '+x.nombre+' ‚Äî Pab: '+(x.pabellon||'-')+(x.obsRecargo?(' ‚Äî Obs: '+x.obsRecargo):'')+'</li>';
        }).join('') || '<li>‚Äî</li>';
      }

      // Pasivos con checkbox al lado del nombre
      var pasHtml = (h.pasivos||[]).map(function(x,i){
        var checked = (h.llamados||[]).indexOf(x.id)>=0 ? 'checked':'';
        var disabled = esUltimo? '' : 'disabled';
        return '<li>'+(i+1)+') '+(getById(x.id)?.nombre||x.nombre)+' &nbsp; <input type="checkbox" data-h="'+idx+'" data-id="'+x.id+'" '+checked+' '+disabled+'></li>';
      }).join('') || '<li>‚Äî</li>';

      body.innerHTML =
        "<div><b>Recargos</b><ul style='padding-left:18px;margin:6px 0'>"+recListHtml+"</ul></div>"+
        "<div style='margin-top:6px'><b>Pasivos</b><ul style='padding-left:18px;margin:6px 0'>"+pasHtml+"</ul></div>";
    })();

    // acciones
    row.querySelector('[data-toggle]').addEventListener('click', function(){
      row.classList.toggle('open');
      this.textContent = row.classList.contains('open')? 'Ocultar' : 'Ver';
    });
    row.querySelector('[data-copy]').addEventListener('click', function(){
      copyText(buildCopyFromHistory(db.historial[idx]));
    });
    row.querySelector('[data-del]')?.addEventListener('click', function(){
      var idxDel=parseInt(this.getAttribute('data-del'),10);
      borrarHistRec(idxDel);
    });

    cont.appendChild(row);
  }

  function buildCopyFromHistory(H){
    var fechaTxt = H.fecha || '';
    var lines=['RECARGOS '+fechaTxt,''];
    if(H.layout && H.layout.length){
      H.layout.forEach(function(x){
        if(x.counted){
          var m={'Vigilancia':'vigilancia','Pab 1':'pab 01','Pab 3S':'pab 03 sur','Pab 3N':'pab 03 norte','Pab 5S':'pab 05 sur','Pab 5N':'pab 05 norte','Pab 7':'pab 07','Pab 9':'pab 09','Pab 11':'pab 11','Pab Aisl':'pab aisl','Cruz':'cruz','Port√≥n':'port√≥n','':''};
          var pabTxt=m[x.pabellon||'']||x.pabellon||'';
          var tags=(x.tags&&x.tags.length)?(' '+x.tags.join(' ')):'';
          var obs=x.obsRecargo?(' ('+x.obsRecargo+')'):'';
          lines.push(x.n+') '+x.nombre+tags+obs+(pabTxt?('  '+pabTxt):''));
        }else{
          var tags2=(x.tags&&x.tags.length)?(' '+x.tags.join(' ')):'';
          lines.push('- '+x.nombre+tags2);
        }
      });
    }else{
      (H.recargos||[]).forEach(function(x,i){
        lines.push((i+1)+') '+x.nombre+(x.obsRecargo?(' ('+x.obsRecargo+')'):'')+(x.pabellon?('  '+x.pabellon):''));
      });
    }
    // Pasivos (con franco)
    var pasHeader='Pasivos';
    if(H.franco===2){
      var parts = (H.fecha||'').split('/');
      if(parts.length===2){
        var y = new Date().getFullYear();
        var d0 = new Date(y, parseInt(parts[1],10)-1, parseInt(parts[0],10));
        var d1 = new Date(d0.getTime()+86400000);
        var dd=('0'+d1.getDate()).slice(-2)+'/'+('0'+(d1.getMonth()+1)).slice(-2);
        pasHeader = 'Pasivos ('+dd+')';
      }
    }
    lines.push('',pasHeader,'');
    (H.pasivos||[]).forEach(function(x,i){
      var per=getById(x.id); var nombre=per?per.nombre:x.nombre;
      lines.push((i+1)+') '+nombre);
    });
    return lines.join('\n');
  }
}

/* Historial de cambios */
function renderHistorialChg(){
  var cont=$qs(null,'#histChg'); cont.innerHTML='';
  // Agrupar por fecha
  var byDate={};
  db.cambios.forEach(function(c){
    var d=c.fechaISO||today();
    (byDate[d]=byDate[d]||[]).push(c);
  });
  var fechas=Object.keys(byDate).sort().reverse();
  fechas.forEach(function(f){
    var items=byDate[f];
    var row=document.createElement('div'); row.className='history-row';
    row.innerHTML =
      "<div class='history-row-head'>"+
        "<div><b>"+f+"</b> ¬∑ <span class='history-meta'>"+items.length+" cambio(s)</span></div>"+
        "<div><button class='btn' data-toggle='chg-"+f+"'>Ver</button></div>"+
      "</div>"+
      "<div class='history-row-body' id='chg-"+f+"'>"+ items.map(function(c){
        if(c.tipo==='add') return "<div>‚ûï Agregado: <b>"+(c.detalle.nombre||c.detalle.id)+"</b></div>";
        if(c.tipo==='del') return "<div>‚úñÔ∏è Eliminado: <b>"+(c.detalle.nombre||c.detalle.id)+"</b></div>";
        if(c.tipo==='move') return "<div>‚ÜïÔ∏è Movido: <b>"+(c.detalle.nombre||c.detalle.id)+"</b> de "+c.detalle.from+" a "+c.detalle.to+"</div>";
        if(c.tipo==='bulk-reorder') return "<div>üßÆ Reordenaci√≥n masiva ("+c.detalle.motivo+")</div>";
        return "<div>‚Ä¢ "+c.tipo+"</div>";
      }).join('') +"</div>";
    row.querySelector('[data-toggle]').addEventListener('click', function(){
      var id=this.getAttribute('data-toggle'); var body=$qs(null,'#'+id);
      var opened=body.style.display==='block'; body.style.display=opened?'none':'block';
      this.textContent = opened? 'Ver' : 'Ocultar';
    });
    cont.appendChild(row);
  });
}

/* Borrar historiales */
function borrarHistRec(idx){
  if(!isSuper()) return alert('Solo superadmin');
  if(!confirm('¬øBorrar registro del historial de recargos?')) return;
  db.historial.splice(idx,1); save(); renderHistorialRec();
}
$qs(null,'#btnBorrarHistRec').onclick=function(){
  if(!isSuper()) return alert('Solo superadmin');
  if(!confirm('¬øBorrar TODO el historial de recargos?')) return;
  db.historial=[]; save(); renderHistorialRec(); alert('Historial de recargos borrado.');
};
$qs(null,'#btnBorrarHistChg').onclick=function(){
  if(!isSuper()) return alert('Solo superadmin');
  if(!confirm('¬øBorrar TODO el historial de cambios?')) return;
  db.cambios=[]; save(); renderHistorialChg(); alert('Historial de cambios borrado.');
};

/* Guardar llamados del √∫ltimo */
$qs(null,'#btnGuardarLlamados').addEventListener('click', function(){
  if(!isAdmin()) return alert('Solo Admin');
  if(!db.historial.length) return;
  var idx=db.historial.length-1; var h=db.historial[idx];
  var checks=$all("input[type='checkbox'][data-h='"+idx+"']");
  h.llamados = checks.filter(c=>c.checked).map(c=>c.getAttribute('data-id'));

  // Reordenar pr√≥xima guardia: DEBE > pasivos NO llamados > resto > llamados
  var current=elegibles();
  var debeIds=current.filter(p=>(p.debeLista||0)>0).map(p=>p.id);
  var notCalled=(h.pasivos||[]).filter(x=>(h.llamados||[]).indexOf(x.id)<0).map(x=>x.id);
  var called=(h.pasivos||[]).filter(x=>(h.llamados||[]).indexOf(x.id)>=0).map(x=>x.id);
  var restIds=current.map(p=>p.id).filter(id=> notCalled.indexOf(id)<0 && called.indexOf(id)<0);

  var seq=[].concat(debeIds, notCalled, restIds, called);
  var seen={}; var base=Date.now(), i=0;
  seq.forEach(function(id){ if(seen[id]) return; seen[id]=true; var p=getById(id); if(p) p.rorder=base+(i++); });

  save(); renderAll(); alert('Llamados guardados.');
});

/* ===== Render maestro ===== */
function renderAll(){
  renderGeneral(); renderHoy(); renderHistorialRec(); renderHistorialChg();
  // Mostrar cambiar PIN admin solo superadmin
  if(btnCambiarPinAdmin) btnCambiarPinAdmin.style.display = isSuper()? 'inline-block' : 'none';
}

/* ===== Seed si est√° vac√≠o ===== */
function seedIfEmpty(){
  if(db.personas && db.personas.length) return;
  var base=Date.now();
  var N=['Julio Angulo','Leandro Ordo√±ez','Mariano lezcano','Medina Diego','Jorge Tobar','Ortigoza Joaquin','Quirico Andres','Cheche tobias','Moore Mariano','Mareco','Oliva Enzo','Mansilla David','Maidana Marcos'];
  db.personas=N.map(function(nombre,i){
    return { id:uid(), nombre:nombre, dni:'', legajo:'', jerarquia:'- vacio -', antiguedad:0, obs:{art:null, licencia:{desde:null,hasta:null}, autorizado:false}, order:base+i, rorder:base+i, debeLista:0, salteado:false };
  });
  save();
}

/* ===== Init ===== */
(function selfTests(){
  try{
    var KEY_TEST='recargapp.test.tmp';
    var sample={personas:[{id:'x',nombre:'Test',obs:{art:null,licencia:{desde:null,hasta:null},autorizado:false},order:1,debeLista:0,salteado:false}],historial:[]};
    localStorage.setItem(KEY_TEST, JSON.stringify(sample));
    var parsed=JSON.parse(localStorage.getItem(KEY_TEST)||'');
    console.assert(parsed && parsed.personas && parsed.personas.length===1, 'Test localStorage');
    localStorage.removeItem(KEY_TEST);
  }catch(e){ console.warn('Autotest fall√≥', e); }
})();
seedIfEmpty();
renderAll();

/* ====== PWA ====== */
(function () {
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/RecargApp/sw.js', { scope: '/RecargApp/' })
      .catch(err => console.error('SW fail', err));
    let refreshing = false;
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      if (refreshing) return; refreshing = true; window.location.reload();
    });
  }
  let deferredPrompt = null;
  const btnInstall = document.getElementById('btnInstall');
  window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; if (btnInstall) btnInstall.style.display = 'inline-block'; });
  if (btnInstall) {
    btnInstall.addEventListener('click', async () => {
      if (!deferredPrompt) return; await deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; btnInstall.style.display = 'none';
    });
  }
})();
</script>

<footer style="text-align:center;color:#aaa;font-size:0.8em;margin:12px 0;">
  Versi√≥n <span id="appVersion">‚Äî</span>
</footer>

<script>
(async function updateVisibleVersion() {
  const el = document.getElementById('appVersion');
  if (!el) return;
  const candidates = ['/RecargApp/manifest.json','/RecargApp/manifest.webmanifest'];
  let manifest = null, lastErr = null;
  for (const url of candidates) {
    try { const res = await fetch(url + '?t=' + Date.now(), { cache: 'no-store' }); if (!res.ok) throw new Error('HTTP ' + res.status); manifest = await res.json(); break; }
    catch (e) { lastErr = e; }
  }
  if (!manifest) { console.error('No pude leer manifest:', lastErr); el.textContent = 'V?'; return; }
  const fromField = (manifest.version && String(manifest.version).trim()) || '';
  const fromName = (manifest.name && (manifest.name.match(/V\d+(\.\d+)*/i)?.[0] || '').trim()) || '';
  const v = fromField ? ('V' + fromField) : fromName;
  el.textContent = v || 'V?';
})();
</script>

</body>
</html>
