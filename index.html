<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>RecargApp</title>

<link rel="manifest" href="/RecargApp/manifest.json">
<meta name="theme-color" content="#0b1223">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="apple-touch-icon" href="/RecargApp/icons/icon-192x192.png">

<style>
:root{
  --bg:#0f172a;--card:#111827;--ink:#e5e7eb;--muted:#94a3b8;--accent:#38bdf8;--line:#1f2937;--btn:#0b1223;
  --ok:#16a34a;--warn:#f59e0b;--err:#ef4444;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
a{color:inherit;text-decoration:none}

/* Header */
header{position:sticky;top:0;z-index:5;background:#0b1223;border-bottom:1px solid var(--line)}
.bar{max-width:1150px;margin:0 auto;padding:10px 12px;display:grid;grid-template-columns:120px 1fr 300px;gap:8px;align-items:center}
.brand{display:flex;align-items:center;gap:8px}
.brand img{width:28px;height:28px;border-radius:6px;object-fit:cover}
.titleWrap{display:flex;justify-content:center}
h1{margin:0;font-size:22px}
.actions{display:flex;gap:8px;justify-content:flex-end;align-items:center}
.role{font-size:12px;color:var(--muted)}

.btn{background:var(--btn);border:1px solid var(--line);color:#d1d5db;border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer}
.btn.primary{background:linear-gradient(180deg,#1f6feb,#1463d6);border:0;color:#fff}
.btn.warn{background:linear-gradient(180deg,#f59e0b,#d97706);border:0;color:#fff}
.btn.danger{background:linear-gradient(180deg,#ef4444,#dc2626);border:0;color:#fff}
.btn[disabled]{opacity:.6;cursor:not-allowed}

.tabs{max-width:1150px;margin:0 auto 8px;display:flex;gap:6px;justify-content:center;flex-wrap:wrap;padding:0 12px}
.tab{background:var(--btn);border:1px solid var(--line);color:var(--muted);padding:6px 10px;border-radius:10px;cursor:pointer}
.tab.active{color:#fff;border-color:#2563eb;background:linear-gradient(180deg,#1f6feb,#1463d6)}

main{padding:10px;max-width:1150px;margin:0 auto}
.section{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:12px}
h2{margin:0 0 8px;font-size:13px;color:var(--muted);letter-spacing:.12em;text-transform:uppercase}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.spacer{flex:1}
input,select,textarea{background:var(--btn);border:1px solid var(--line);color:var(--ink);border-radius:8px;padding:6px}
.tableWrap{width:100%;overflow-x:auto}
table{width:100%;border-collapse:collapse;table-layout:fixed;min-width:780px}
th,td{padding:8px;border-bottom:1px solid var(--line);text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
th{color:var(--accent)}
.note{font-size:12px;color:var(--muted)}
.muted{color:var(--muted)}

/* Pills */
.pill{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border-radius:999px;border:1px solid #334155;white-space:nowrap;font-size:12px}
.pill.warn{background:#2a1b05;color:#fbbf24;border-color:#533c0d}
.pill.err{background:#3b0a0a;color:#fca5a5;border-color:#6b1a1a}
.pill.ok{background:#052e1a;color:#86efac;border-color:#0d3e28}
.pill.info{background:#0b1223;color:#cbd5e1;border-color:#334155}
.clickable{cursor:pointer}

/* Drawer (Mas) */
#fabMore{position:fixed;right:14px;bottom:14px;z-index:40}
#drawer{position:fixed;inset:0;display:none;z-index:50}
#drawer .back{position:absolute;inset:0;background:rgba(0,0,0,.5)}
#drawer .panel{position:absolute;right:0;top:0;height:100%;width:min(520px,94vw);background:#0b1223;border-left:1px solid var(--line);padding:16px;overflow:auto}
#drawer h3{margin:10px 0 6px}
#drawer ul{margin:6px 0 12px;padding-left:18px}

/* Footer */
footer{color:#aaa;font-size:.8em;text-align:center;margin:14px 0}

/* Confirm modal */
#confirm{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:60}
#confirm .box{background:#0b1223;border:1px solid var(--line);border-radius:12px;max-width:92vw;min-width:260px;padding:14px}

@media (max-width:720px){
  .bar{grid-template-columns:42px 1fr 180px}
  h1{font-size:18px}
  table{min-width:640px}
}
</style>
</head>
<body>

<button class="btn" id="btnInstall" style="display:none;margin:8px">Instalar</button>

<header>
  <div class="bar">
    <div class="brand"><img src="/RecargApp/icons/icon-192x192.png" alt="logo"></div>
    <div class="titleWrap"><h1>RecargApp</h1></div>
    <div class="actions">
      <span id="lockState" class="role">Modo lectura</span>
      <button class="btn" id="btnCambiarPinAdmin" style="display:none">Cambiar PIN</button>
      <button class="btn" id="btnToggleAdmin">Iniciar sesion</button>
    </div>
  </div>
  <div class="tabs">
    <button class="tab active" data-tab="hoy">Recargos</button>
    <button class="tab" data-tab="general">Lista</button>
    <button class="tab" data-tab="historial">Historial</button>
  </div>
</header>

<main>
  <div id="banner" class="section" style="display:none"></div>

  <!-- HOY -->
  <section class="section" data-panel="hoy">
    <h2 id="tituloDia">RECARGOS DEL DIA</h2>
    <div class="row">
      <label>Fecha</label><input id="fecha" type="date" style="max-width:160px">
      <label>Faltantes</label><input id="faltantes" type="number" value="1" min="0" style="max-width:90px">
      <div class="spacer"></div>
      <button class="btn danger only-admin" id="btnReiniciar">Reiniciar lista</button>
      <button class="btn only-admin" id="btnActualizar">Actualizar</button>
      <button class="btn only-admin" id="btnCopiarListado">Copiar orden</button>
      <button class="btn primary only-admin" id="btnAgregarExtra">+ Agregar extra</button>
    </div>

    <div class="tableWrap" style="margin-top:8px">
      <table id="tablaDia">
        <thead>
          <tr>
            <th style="width:46px">#</th>
            <th style="width:240px">Nombre</th>
            <th style="width:120px">Jerarquia</th>
            <th style="width:240px">Estado</th>
            <th style="width:160px">Pabellon</th>
            <th style="width:220px">Obs recargo</th>
            <th style="width:90px">Acc</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="note" style="margin-top:6px">
      * <span class="pill warn">ART</span>, <span class="pill ok">AUTORIZADO</span>, <span class="pill info">SALTEADO</span>,
      <span class="pill err">LICENCIA</span> se muestran pero no numeran. Con <b>Presente</b> (13/26/04) suben y cuentan. (debe X) se ve en la fila.
    </div>

    <!-- PASIVOS (debajo) -->
    <div class="section" style="margin-top:12px">
      <h2>PASIVOS</h2>
      <div class="row">
        <label>Para:</label>
        <select id="pasivosPara" style="max-width:280px">
          <option value="mismo">1er dia de franco (mismo dia)</option>
          <option value="siguiente">2do dia de franco (al dia siguiente)</option>
        </select>
        <div class="spacer"></div>
        <button class="btn only-admin" id="btnImprimirPasivos">Imprimir pasivos</button>
        <button class="btn only-admin" id="btnCopiarResultado">Copiar recargos+pasivos</button>
      </div>
      <div class="tableWrap" style="margin-top:6px">
        <table id="tablaPasivos">
          <thead><tr><th style="width:42px">#</th><th>Nombre</th><th style="width:160px">Jerarquia</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="row" style="margin-top:12px;gap:14px">
      <button class="btn primary only-admin" id="btnConfirmar">Confirmar guardia</button>
      <button class="btn warn only-admin" id="btnDeshacer" title="Ctrl+Z">Deshacer (Ctrl+Z)</button>
    </div>
  </section>

  <!-- GENERAL -->
  <section class="section" data-panel="general" style="display:none">
    <h2>Listado general</h2>
    <div class="row">
      <input id="nombre" placeholder="Nombre y Apellido" style="max-width:240px">
      <input id="dni" placeholder="DNI" style="max-width:140px">
      <input id="legajo" placeholder="Legajo" style="max-width:140px">
      <select id="jerarquia" style="max-width:160px">
        <option>AYTE MY (CG)</option><option>AYTE PR (CG)</option><option>AYTE 1ro (CG)</option><option>AYTE 2do (CG)</option><option>AYTE 3ro (CG)</option><option>AYTE 4to (CG)</option><option>AYTE 5to (CG)</option><option>SUBAYTE (CG)</option><option>- vacio -</option>
      </select>
      <input id="antiguedad" type="number" placeholder="Antiguedad (anios)" style="max-width:140px">
      <button class="btn primary only-admin" id="btnAgregar">Agregar</button>
      <button class="btn only-admin" id="btnOrdenarCriterios">Ordenar (Jerarquia -> Antiguedad)</button>
      <button class="btn only-admin" id="btnDeshacerOrden">Deshacer orden</button>
      <button class="btn warn only-admin" id="btnEditarGeneral">Editar</button>
    </div>
    <div class="tableWrap" style="margin-top:8px">
      <table id="tablaGeneral">
        <thead><tr>
          <th style="width:64px">Orden</th>
          <th style="width:260px">Nombre</th>
          <th style="width:120px">DNI</th>
          <th style="width:120px">Legajo</th>
          <th style="width:150px">Jerarquia</th>
          <th style="width:80px">Antig.</th>
          <th style="width:70px">Debe</th>
          <th>Obs</th>
          <th style="width:80px" class="muted">Eliminar</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn only-admin" id="btnExportar">Exportar JSON</button>
      <button class="btn only-admin" id="btnImportar">Importar JSON</button>
    </div>
  </section>

  <!-- HISTORIAL -->
  <section class="section" data-panel="historial" style="display:none">
    <h2>Historial</h2>
    <div class="row" style="justify-content:flex-end;margin-bottom:8px">
      <button class="btn danger only-super" id="btnBorrarHistRec">Borrar historial Recargos</button>
      <button class="btn danger only-super" id="btnBorrarHistCamb">Borrar historial Cambios</button>
    </div>

    <div class="row" style="gap:10px;margin-bottom:6px">
      <button class="tab subtab active" id="subRec">Recargos</button>
      <button class="tab subtab" id="subCamb">Cambios</button>
      <div class="spacer"></div>
      <button class="btn primary only-admin" id="btnGuardarLlamados">Guardar llamados del ultimo</button>
    </div>

    <!-- Recargos -->
    <div id="histRecargos" class="section" style="padding:10px">
      <div class="tableWrap">
        <table id="tablaHistorial">
          <thead><tr>
            <th style="width:80px">Ver</th>
            <th>Resumen</th>
            <th style="width:180px">Acciones</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Cambios (una linea por item) -->
    <div id="histCambios" class="section" style="display:none;padding:10px">
      <div class="tableWrap">
        <table id="tablaCambios">
          <thead><tr><th>Detalle</th><th style="width:160px">Acciones</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<!-- Boton / Drawer "Mas" -->
<button class="btn" id="fabMore" title="Mas">... Mas</button>
<div id="drawer">
  <div class="back"></div>
  <div class="panel">
    <div class="row" style="align-items:center;gap:10px">
      <img src="/RecargApp/icons/icon-192x192.png" alt="logo" style="width:28px;height:28px;border-radius:6px">
      <div class="spacer"><strong>RecargApp</strong> <span id="drawerVersion" class="muted"></span></div>
      <button class="btn" id="closeDrawer">Cerrar</button>
    </div>

    <div class="row" style="gap:8px;margin:10px 0">
      <!-- ojo: ID corregido a btnCheckUpdates para coincidir con JS -->
      <button class="btn" id="btnCheckUpdates">Buscar actualizaciones</button>
      <button class="btn" id="btnApplyUpdate">Actualizar ahora</button>
      <span id="updMsg" class="muted"></span>
    </div>

    <h3>Descripcion</h3>
    <p>Gestor de recargos del dia, pasivos e historial. Incluye lista general con orden, permisos por rol y soporte PWA.</p>

    <h3>Notas de actualizacion</h3>
    <div id="releaseNotes" class="note">Cargando...</div>
  </div>
</div>

<!-- Modal Extra -->
<div id="modalExtra" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:20">
  <div class="section" style="min-width:300px;max-width:95vw">
    <h3 style="margin:0 0 8px;font-size:16px">Agregar extra</h3>
    <div class="row"><input id="extraNombre" placeholder="Nombre (opcional)" style="flex:1"></div>
    <div class="row">
      <select id="extraJerarquia" style="max-width:220px">
        <option value="">(sin jerarquia)</option>
        <option>AYTE MY (CG)</option><option>AYTE PR (CG)</option><option>AYTE 1ro (CG)</option><option>AYTE 2do (CG)</option><option>AYTE 3ro (CG)</option><option>AYTE 4to (CG)</option><option>AYTE 5to (CG)</option><option>SUBAYTE (CG)</option><option>- vacio -</option>
      </select>
      <select id="extraPab" style="max-width:220px">
        <option value="">(sin pabellon)</option>
        <option>Vigilancia</option><option>Pab 1</option><option>Pab 3S</option><option>Pab 3N</option><option>Pab 5S</option><option>Pab 5N</option><option>Pab 7</option><option>Pab 9</option><option>Pab 11</option><option>Pab Aisl</option><option>Cruz</option><option>Porton</option>
      </select>
    </div>
    <div class="row"><input id="extraObs" placeholder="Observacion (opcional)" style="flex:1"></div>
    <div class="row" style="justify-content:flex-end">
      <button class="btn" id="extraCancel">Cancelar</button>
      <button class="btn primary" id="extraOk">Agregar</button>
    </div>
  </div>
</div>

<!-- Modal Acciones -->
<div id="modalAcc" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:21">
  <div class="section" style="min-width:320px;max-width:95vw">
    <h3 style="margin:0 0 8px;font-size:16px">Acciones para <span id="accNombre"></span></h3>
    <div class="row">
      <button class="btn" id="accArt13">ART 13</button>
      <button class="btn" id="accArt26">ART 26</button>
      <button class="btn" id="accArtClear">Quitar ART</button>
      <button class="btn" id="accPres04">Presente 04</button>
    </div>
    <hr style="border-color:#1f2937;margin:10px 0">
    <div class="row">
      <label>Lic desde</label><input id="accLicD" type="date" style="max-width:170px">
      <label>hasta</label><input id="accLicH" type="date" style="max-width:170px">
      <button class="btn" id="accLicSave">Guardar licencia</button>
      <button class="btn danger" id="accLicClear">Quitar licencia</button>
    </div>
    <hr style="border-color:#1f2937;margin:10px 0">
    <div class="row">
      <button class="btn" id="accAut">AUTORIZADO</button>
      <button class="btn" id="accSalt">SALTEAR</button>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:6px">
      <button class="btn primary" id="accClose">Listo</button>
    </div>
  </div>
</div>

<!-- Modal Confirm propio -->
<div id="confirm">
  <div class="box">
    <div id="confirmMsg" style="margin-bottom:10px">Confirmar?</div>
    <div class="row" style="justify-content:flex-end">
      <button class="btn" id="confirmNo">Cancelar</button>
      <button class="btn danger" id="confirmYes">Confirmar</button>
    </div>
  </div>
</div>

<footer style="text-align:center;color:#aaa;font-size:0.8em;margin:12px 0;">
  Version instalada: <span id="appVersion">¡ª</span>
  <span id="appVersionAvailWrap" style="display:none">
    &nbsp;¡¤&nbsp; Disponible: <span id="appVersionAvail"></span>
  </span>
</footer>

<script>
/* ===== util ===== */
function $qs(r,s){return (r||document).querySelector(s)}
function $all(s,r){return Array.prototype.slice.call((r||document).querySelectorAll(s))}
function showBanner(t,o){o=o||{};const b=$qs(null,'#banner');if(!b)return;b.textContent=t;b.style.display='block';if(showBanner._t)clearTimeout(showBanner._t);if(!o.sticky)showBanner._t=setTimeout(()=>b.style.display='none',o.timeout||3200)}
function uid(){return Math.random().toString(36).slice(2,9)}
function today(){return new Date().toISOString().slice(0,10)}
function fmtDM(s){var a=s.split('-');return a[2]+'/'+a[1]}
function isDayAfter(a,b){if(!a||!b)return false;var d=new Date(a),e=new Date(b);var n=new Date(d.getTime()+86400000);return n.toISOString().slice(0,10)===e.toISOString().slice(0,10)}
function inLic(p,f){var L=p.obs.licencia;return L&&L.desde&&L.hasta&&(f>=L.desde&&f<=L.hasta)}
/* confirm propio */
function ask(msg){return new Promise(res=>{const box=$qs(null,'#confirm');$qs(null,'#confirmMsg').textContent=msg;box.style.display='flex';const yes=$qs(null,'#confirmYes'),no=$qs(null,'#confirmNo');function done(v){box.style.display='none';yes.onclick=no.onclick=null;res(v)};yes.onclick=()=>done(true);no.onclick=()=>done(false)})}

/* ===== Modelo ===== */
const KEY='recargapp.v1';
let ADMIN_PIN=localStorage.getItem('recargapp.admin.pin')||'1111';
const SUPERADMIN_PIN='9999';
function setAdminPin(v){ADMIN_PIN=String(v);localStorage.setItem('recargapp.admin.pin',ADMIN_PIN)}
function save(){localStorage.setItem(KEY,JSON.stringify(db))}
function load(){try{return JSON.parse(localStorage.getItem(KEY)||'null')}catch(_){return null}}

let db=load()||{personas:[],historial:[],cambios:[],generalHead:0};
if(!db.personas||!db.personas.length){
  const base=Date.now();
  const N=['Julio Angulo','Leandro Ordonez','Mariano Lezcano','Medina Diego','Jorge Tobar','Ortigoza Joaquin','Quirico Andres','Cheche Tobias','Moore Mariano','Mareco','Oliva Enzo','Mansilla David','Maidana Marcos'];
  db.personas=N.map((n,i)=>({id:uid(),nombre:n,dni:'',legajo:'',jerarquia:'- vacio -',antiguedad:0,obs:{art:null,licencia:{desde:null,hasta:null},autorizado:false},order:base+i,rorder:base+i,debeLista:0,salteado:false}));
  save();
}
db.personas.forEach((p,i)=>{if(p.rorder==null)p.rorder=p.order||Date.now()+i;if(typeof p.debeLista!=='number')p.debeLista=0;if(!p.obs)p.obs={art:null,licencia:{desde:null,hasta:null},autorizado:false}})

let prioridadHoy={}; // {id:'ART13'|'ART26'|'ART04'}
let role='viewer';
function isAdmin(){return role==='admin'||role==='superadmin'}
function isSuper(){return role==='superadmin'}
function applyRoleVisibility(){
  $all('.only-admin').forEach(b=>{b.style.display=isAdmin()?'':'none'; if(!isAdmin()) b.setAttribute('disabled','disabled'); else b.removeAttribute('disabled')})
  $all('.only-super').forEach(b=>{b.style.display=isSuper()?'':'none'; if(!isSuper()) b.setAttribute('disabled','disabled'); else b.removeAttribute('disabled')})
}

/* ===== Sesion ===== */
const lockState=$qs(null,'#lockState');
const btnToggleAdmin=$qs(null,'#btnToggleAdmin');
const btnCambiarPinAdmin=$qs(null,'#btnCambiarPinAdmin');

btnToggleAdmin.onclick=function(){
  if(role!=='viewer'){role='viewer';lockState.textContent='Modo lectura';btnToggleAdmin.textContent='Iniciar sesion';btnCambiarPinAdmin.style.display='none';applyRoleVisibility();return}
  var code=prompt('Ingresar PIN');
  if(code===ADMIN_PIN){role='admin';lockState.textContent='ADMIN';btnToggleAdmin.textContent='Salir';btnCambiarPinAdmin.style.display='none';applyRoleVisibility()}
  else if(code===SUPERADMIN_PIN){role='superadmin';lockState.textContent='SUPERADMIN';btnToggleAdmin.textContent='Salir';btnCambiarPinAdmin.style.display='inline-block';applyRoleVisibility()}
  else if(code!==null){showBanner('PIN incorrecto')}
}
btnCambiarPinAdmin.onclick=async function(){
  if(!isSuper())return;
  var np=prompt('Nueva contrasena ADMIN (4-8 digitos):'); if(np==null)return;
  if(!/^\d{4,8}$/.test(np.trim()))return showBanner('Debe ser 4-8 digitos');
  setAdminPin(np.trim()); showBanner('PIN ADMIN actualizado');
}

/* ===== Tabs ===== */
$all('.tab[data-tab]').forEach(t=>{
  t.onclick=function(){
    $all('.tab[data-tab]').forEach(x=>x.classList.remove('active')); t.classList.add('active');
    const name=t.getAttribute('data-tab');
    $all('[data-panel]').forEach(p=>p.style.display=(p.getAttribute('data-panel')===name)?'block':'none');
    if(name==='historial') renderHistorial();
  }
})

/* ===== Undo ===== */
const undoStack=[];
function pushUndo(obj){undoStack.push(JSON.parse(JSON.stringify(obj)))}
function popUndo(){return undoStack.length?undoStack.pop():null}

/* ===== Helpers personas ===== */
function getById(id){return db.personas.find(p=>p.id===id)||null}
function generalList(){return [].concat(db.personas).sort((a,b)=>a.order-b.order)}
function elegibles(){return [].concat(db.personas).sort((a,b)=>(a.rorder||0)-(b.rorder||0))}

/* ===== General ===== */
const nombreEl=$qs(null,'#nombre'),dniEl=$qs(null,'#dni'),legajoEl=$qs(null,'#legajo'),jerarquiaEl=$qs(null,'#jerarquia'),antigEl=$qs(null,'#antiguedad')
let snapshotOrden=null, editGeneral=false

$qs(null,'#btnAgregar').onclick=function(){
  if(!isAdmin())return showBanner('Solo Admin');
  if(!nombreEl.value.trim())return showBanner('Nombre requerido');
  const p={id:uid(),nombre:nombreEl.value.trim(),dni:dniEl.value.trim(),legajo:legajoEl.value.trim(),jerarquia:jerarquiaEl.value,antiguedad:parseInt(antigEl.value||'0',10),obs:{art:null,licencia:{desde:null,hasta:null},autorizado:false},order:Date.now(),rorder:Date.now(),debeLista:0,salteado:false}
  pushUndo({type:'general',personas:db.personas})
  db.personas.push(p); db.cambios.push({t:Date.now(),tipo:'agregar',nombre:p.nombre})
  save(); nombreEl.value='';dniEl.value='';legajoEl.value='';antigEl.value=''; renderGeneral(); renderHoy()
}
$qs(null,'#btnOrdenarCriterios').onclick=function(){
  if(!isAdmin())return showBanner('Solo Admin');
  snapshotOrden=db.personas.map(p=>p.id)
  const rank={'AYTE MY (CG)':1,'AYTE PR (CG)':2,'AYTE 1ro (CG)':3,'AYTE 2do (CG)':4,'AYTE 3ro (CG)':5,'AYTE 4to (CG)':6,'AYTE 5to (CG)':7,'SUBAYTE (CG)':8,'- vacio -':9}
  pushUndo({type:'general',personas:db.personas})
  db.personas.sort((a,b)=>rank[a.jerarquia]-rank[b.jerarquia] || (b.antiguedad||0)-(a.antiguedad||0))
  const base=Date.now(); db.personas.forEach((p,i)=>p.order=base+i)
  db.cambios.push({t:Date.now(),tipo:'ordenar',detalle:'Jerarquia -> Antiguedad'})
  save(); renderGeneral(); renderHoy()
}
$qs(null,'#btnDeshacerOrden').onclick=function(){
  if(!isAdmin())return showBanner('Solo Admin');
  if(!snapshotOrden)return showBanner('No hay orden anterior');
  pushUndo({type:'general',personas:db.personas})
  const base=Date.now(); snapshotOrden.forEach((id,i)=>{const p=getById(id); if(p)p.order=base+i})
  db.cambios.push({t:Date.now(),tipo:'deshacer-orden'})
  save(); renderGeneral(); renderHoy()
}
$qs(null,'#btnEditarGeneral').onclick=function(){
  if(!isAdmin())return showBanner('Solo Admin');
  editGeneral=!editGeneral; $qs(null,'#btnEditarGeneral').textContent=editGeneral?'Guardar':'Editar'; renderGeneral()
}
window.setField=function(id,key,val){ if(!isAdmin())return showBanner('Solo Admin'); const p=getById(id); if(!p)return; pushUndo({type:'general',personas:db.personas}); p[key]=val; save(); }
async function eliminar(id){
  if(!isAdmin())return showBanner('Solo Admin');
  const p=getById(id); if(!p)return;
  if(!(await ask('Eliminar a '+p.nombre+' del listado?')))return;
  pushUndo({type:'general',personas:db.personas})
  db.personas=db.personas.filter(x=>x.id!==id);
  db.cambios.push({t:Date.now(),tipo:'eliminar',nombre:p.nombre})
  save(); renderGeneral(); renderHoy()
}
function renderGeneral(){
  const tb=$qs(null,'#tablaGeneral tbody'); tb.innerHTML=''
  const list=[].concat(db.personas).sort((a,b)=>a.order-b.order)
  list.forEach((p,i)=>{
    const tr=document.createElement('tr'); tr.dataset.id=p.id
    if(editGeneral){
      tr.draggable=true
      tr.ondragstart=e=>{e.dataTransfer.setData('text/plain',p.id); tr.classList.add('dragging')}
      tr.ondragend=()=>tr.classList.remove('dragging')
      tr.ondragover=e=>{e.preventDefault(); tr.style.outline='1px dashed #334155'}
      tr.ondragleave=()=>tr.style.outline=''
      tr.ondrop=e=>{
        e.preventDefault(); tr.style.outline=''
        const fromId=e.dataTransfer.getData('text/plain'); if(!fromId||fromId===p.id)return
        const ordered=[].concat(db.personas).sort((a,b)=>a.order-b.order)
        const a=ordered.findIndex(x=>x.id===fromId), b=ordered.findIndex(x=>x.id===p.id)
        if(a<0||b<0)return
        pushUndo({type:'general',personas:db.personas})
        const moved=ordered.splice(a,1)[0]; ordered.splice(b,0,moved)
        const base=Date.now(); ordered.forEach((x,idx)=>x.order=base+idx)
        db.cambios.push({t:Date.now(),tipo:'mover',nombre:moved.nombre,detalle:'a posicion '+(b+1)})
        save(); renderGeneral(); renderHoy()
      }
    }
    function cell(t){return '<td>'+t+'</td>'}
    const cOrden=cell(i+1)
    const cNombre=cell(p.nombre)
    const cDNI=editGeneral?'<td><input value="'+(p.dni||'')+'" onblur="setField(\''+p.id+'\',\'dni\',this.value)"></td>':cell(p.dni||'')
    const cLeg=editGeneral?'<td><input value="'+(p.legajo||'')+'" onblur="setField(\''+p.id+'\',\'legajo\',this.value)"></td>':cell(p.legajo||'')
    const jer=['AYTE MY (CG)','AYTE PR (CG)','AYTE 1ro (CG)','AYTE 2do (CG)','AYTE 3ro (CG)','AYTE 4to (CG)','AYTE 5to (CG)','SUBAYTE (CG)','- vacio -']
      .map(j=>'<option '+(p.jerarquia===j?'selected':'')+'>'+j+'</option>').join('')
    const cJer=editGeneral?'<td><select onchange="setField(\''+p.id+'\',\'jerarquia\',this.value)">'+jer+'</select></td>':cell(p.jerarquia)
    const cAnt=editGeneral?'<td><input type="number" min="0" value="'+(p.antiguedad||0)+'" onblur="setField(\''+p.id+'\',\'antiguedad\',parseInt(this.value||\'0\',10))"></td>':cell(p.antiguedad||0)
    const cDebe=editGeneral?'<td><input type="number" min="0" value="'+(p.debeLista||0)+'" onblur="setField(\''+p.id+'\',\'debeLista\',parseInt(this.value||\'0\',10))"></td>':cell(p.debeLista||0)
    const obs=[]; if(p.obs.art)obs.push('ART '+p.obs.art); if(p.obs.licencia&&p.obs.licencia.desde&&p.obs.licencia.hasta)obs.push('LIC '+fmtDM(p.obs.licencia.desde)+'-'+fmtDM(p.obs.licencia.hasta)); if(p.obs.autorizado)obs.push('AUTORIZADO'); if(p.salteado)obs.push('SALTEADO')
    const cObs=cell(obs.join(' ¡¤ ')||'<span class="muted">-</span>')
    const cDel=editGeneral?"<td><button class='btn danger' onclick=\"eliminar('"+p.id+"')\">Eliminar</button></td>":"<td class='muted'>-</td>"
    tr.innerHTML=cOrden+cNombre+cDNI+cLeg+cJer+cAnt+cDebe+cObs+cDel
    if(!isAdmin()) $all('button,input,select',tr).forEach(el=>{el.setAttribute('disabled','disabled');el.title='Solo Admin'})
    tb.appendChild(tr)
  })
}

/* ===== HOY ===== */
const fechaEl=$qs(null,'#fecha'); const faltEl=$qs(null,'#faltantes'); fechaEl.value=today()
function setTitulo(){ $qs(null,'#tituloDia').textContent='RECARGOS '+fmtDM(fechaEl.value) }
setTitulo(); fechaEl.onchange=setTitulo

$qs(null,'#btnReiniciar').onclick=async function(){
  if(!isAdmin())return showBanner('Solo Admin');
  if(!(await ask('Reiniciar rotacion y limpiar estados?')))return
  const ordered=[].concat(db.personas).sort((a,b)=>a.order-b.order); const base=Date.now()
  pushUndo({type:'general',personas:db.personas})
  ordered.forEach((p,i)=>{p.rorder=base+i;p.obs.art=null;p.obs.autorizado=false;p.salteado=false;p.obs.licencia={desde:null,hasta:null};p.debeLista=0})
  prioridadHoy={}; db.generalHead=0; save(); renderHoy(); showBanner('Lista reiniciada')
}
$qs(null,'#btnActualizar').onclick=()=>renderHoy()

function estadoPills(p,fecha){
  const pills=[]
  if(p.obs&&(p.obs.art==='13'||p.obs.art==='26')){
    const t=p.obs.art
    const pres=(prioridadHoy[p.id]==='ART13'&&t==='13')||(prioridadHoy[p.id]==='ART26'&&t==='26')
    pills.push('<span class="pill warn clickable" data-act="toggle-art" data-id="'+p.id+'" data-tipo="'+t+'">'+(pres?'Presente '+t:'ART '+t)+'</span>')
  }
  if(inLic(p,fecha)||prioridadHoy[p.id]==='ART04'){
    const L=p.obs.licencia||{desde:null,hasta:null}
    const pres04=(prioridadHoy[p.id]==='ART04')
    if(pres04) pills.push('<span class="pill err clickable" data-act="toggle-lic" data-id="'+p.id+'">Presente 04</span>')
    else if(L.desde&&L.hasta) pills.push('<span class="pill err clickable" data-act="toggle-lic" data-id="'+p.id+'">LIC '+fmtDM(L.desde)+'-'+fmtDM(L.hasta)+'</span>')
  }
  if(p.obs&&p.obs.autorizado)pills.push('<span class="pill ok">AUTORIZADO</span>')
  if(p.salteado)pills.push('<span class="pill info">SALTEADO</span>')
  if((p.debeLista||0)>0)pills.push('<span class="pill info">debe '+p.debeLista+'</span>')
  return pills.join(' ')
}
function attachEstadoHandlers(tb){
  tb.onclick = function(ev){
    const el = ev.target.closest('[data-act]');
    if(!el) return;
    if(!isAdmin()) return showBanner('Solo Admin');

    // Undo
    pushUndo({ type:'prioridad', prioridad: prioridadHoy });

    const id  = el.dataset.id;
    const act = el.dataset.act;

    if (act === 'toggle-art') {
      const k = (el.dataset.tipo === '13' ? 'ART13' : 'ART26');
      if (prioridadHoy[id] === k) {
        delete prioridadHoy[id];
      } else {
        prioridadHoy[id] = k;
      }
    } else if (act === 'toggle-lic') {
      if (prioridadHoy[id] === 'ART04') {
        delete prioridadHoy[id];
      } else {
        prioridadHoy[id] = 'ART04';
      }
    }

    renderHoy();
  };
}

function getPlan(){
  const falt=Math.max(0,parseInt(faltEl.value||'0',10))
  const fecha=fechaEl.value
  const base=elegibles()
  const prioIds=Object.keys(prioridadHoy)
  const pART=base.filter(p=>prioridadHoy[p.id]==='ART13'||prioridadHoy[p.id]==='ART26')
  const p04 =base.filter(p=>prioridadHoy[p.id]==='ART04')
  const resto=base.filter(p=>prioIds.indexOf(p.id)===-1)
  resto.sort((a,b)=>(b.debeLista||0)-(a.debeLista||0)||(a.rorder||0)-(b.rorder||0))
  const mostrados=[],numerados=[]
  function pushP(p,force){const skip=!force&&(p.obs.art||p.obs.autorizado||inLic(p,fecha)||p.salteado); mostrados.push({p:p,saltar:skip}); if(!skip)numerados.push(p)}
  pART.forEach(p=>pushP(p,true)); p04.forEach(p=>pushP(p,true)); resto.forEach(p=>pushP(p,false))
  const asignados=numerados.slice(0,falt)
  const idxUlt=falt-1
  const pasivos=(idxUlt>=0)?numerados.slice(idxUlt+1,idxUlt+3):numerados.slice(0,2)
  return {mostrados,asignados,pasivos}
}

function renderHoy(){
  setTitulo()
  const fecha=fechaEl.value
  // activar 04 el dia siguiente de fin de licencia (solo si corresponde)
  db.personas.forEach(p=>{ if(p&&p.obs&&p.obs.licencia&&isDayAfter(p.obs.licencia.hasta,fecha)){ if(!prioridadHoy[p.id])prioridadHoy[p.id]='ART04' } })
  const prev={}
  $all('#tablaDia tbody tr[data-id]').forEach(r=>{
    const id=r.dataset.id; const sel=r.querySelector('select'); const inp=r.querySelector('input[type="text"]')
    prev[id]={pab:sel?sel.value:'',obs:inp?inp.value:''}
  })
  const tb=$qs(null,'#tablaDia tbody'); tb.innerHTML=''
  let n=0
  const plan=getPlan()
  plan.mostrados.forEach(item=>{
    const p=item.p, saltar=item.saltar
    const tr=document.createElement('tr'); tr.dataset.id=p.id
    const num=document.createElement('td'); num.textContent=saltar?'-':(++n)
    const estado=document.createElement('td'); estado.innerHTML=estadoPills(p,fecha)||'<span class="muted">-</span>'
    const pabSel=document.createElement('select')
    ;['','Vigilancia','Pab 1','Pab 3S','Pab 3N','Pab 5S','Pab 5N','Pab 7','Pab 9','Pab 11','Pab Aisl','Cruz','Porton'].forEach(x=>{const o=document.createElement('option');o.textContent=x;pabSel.appendChild(o)})
    if(prev[p.id]&&prev[p.id].pab)pabSel.value=prev[p.id].pab
    if(saltar||!isAdmin()){pabSel.disabled=true}
    const obs=document.createElement('input'); obs.type='text'; obs.placeholder='(ej. cubre Ibarra)'; if(prev[p.id]&&prev[p.id].obs)obs.value=prev[p.id].obs; if(!isAdmin()){obs.disabled=true}
    const acc=document.createElement('td'); acc.innerHTML="<button class='btn only-admin' onclick=\"openAcc('"+p.id+"')\" "+(!isAdmin()?"disabled":"")+">Acciones</button>"

    tr.appendChild(num)
    tr.insertAdjacentHTML('beforeend',"<td>"+p.nombre+"</td><td>"+p.jerarquia+"</td>")
    tr.appendChild(estado)
    const tdP=document.createElement('td'); tdP.appendChild(pabSel); tr.appendChild(tdP)
    const tdO=document.createElement('td'); tdO.appendChild(obs); tr.appendChild(tdO)
    tr.appendChild(acc)
    tb.appendChild(tr)
  })
  attachEstadoHandlers(tb)

  // Pasivos
  const tpas=$qs(null,'#tablaPasivos tbody'); tpas.innerHTML=''
  plan.pasivos.forEach((p,i)=>{
    const tr=document.createElement('tr'); tr.dataset.id=p.id
    tr.innerHTML="<td>"+(i+1)+"</td><td>"+p.nombre+"</td><td>"+p.jerarquia+"</td>"
    tpas.appendChild(tr)
  })

  applyRoleVisibility()
}

/* Copiar orden (solo recargos) */
$qs(null,'#btnCopiarListado').onclick=function(){
  const fecha=fechaEl.value, plan=getPlan()
  const lines=['RECARGOS '+fmtDM(fecha),'']; let n=0
  plan.mostrados.forEach(item=>{
    const p=item.p, saltar=item.saltar; const prio=prioridadHoy[p.id]; const tags=[]
    if(prio) tags.push(prio==='ART13'?'(presente 13)':prio==='ART26'?'(presente 26)':'(presente 04)')
    if(p.obs&&p.obs.art&&!prio) tags.push('(ART '+p.obs.art+')')
    if(p.obs&&p.obs.autorizado) tags.push('(autorizado)')
    if(inLic(p,fecha)) tags.push('(licencia)')
    if((p.debeLista||0)>0) tags.push('(debe '+p.debeLista+')')
    if(saltar) lines.push('- '+p.nombre+' '+tags.join(' '))
    else lines.push((++n)+') '+p.nombre+' '+tags.join(' '))
  })
  navigator.clipboard?.writeText(lines.join('\n')).then(()=>showBanner('Copiado')).catch(()=>{const w=window.open('','_blank');w.document.write('<pre>'+lines.join('\n')+'</pre>');w.document.close();w.focus()})
}

/* Extra modal */
const mExtra=$qs(null,'#modalExtra')
$qs(null,'#btnAgregarExtra').onclick=()=>{if(!isAdmin())return showBanner('Solo Admin');mExtra.style.display='flex'}
$qs(null,'#extraCancel').onclick=()=>mExtra.style.display='none'
$qs(null,'#extraOk').onclick=function(){
  if(!isAdmin())return
  const nombre=($qs(null,'#extraNombre').value||'').trim()||'Extra'
  const jer=$qs(null,'#extraJerarquia').value||'- vacio -'
  const pab=$qs(null,'#extraPab').value||''
  const obs=$qs(null,'#extraObs').value||''
  const id='extra_'+uid()
  const tbody=$qs(null,'#tablaDia tbody'); const tr=document.createElement('tr'); tr.dataset.id=id
  tr.innerHTML='<td>*</td><td>'+nombre+'</td><td>'+jer+'</td><td><span class="pill info">EXTRA</span></td><td>'+pab+'</td><td>'+obs+'</td><td>-</td>'
  tbody.insertBefore(tr,tbody.firstChild); mExtra.style.display='none'
}

/* Modal Acciones */
const mAcc=$qs(null,'#modalAcc'); let accId=null
function openAcc(id){
  if(!isAdmin())return showBanner('Solo Admin')
  accId=id; const p=getById(id); if(!p)return
  $qs(null,'#accNombre').textContent=p.nombre
  $qs(null,'#accLicD').value=(p.obs.licencia&&p.obs.licencia.desde)||''
  $qs(null,'#accLicH').value=(p.obs.licencia&&p.obs.licencia.hasta)||''
  mAcc.style.display='flex'
}
window.openAcc=openAcc
$qs(null,'#accClose').onclick=()=>{mAcc.style.display='none';accId=null}
$qs(null,'#accArt13').onclick=function(){ if(!isAdmin()||!accId)return; const p=getById(accId); pushUndo({type:'general',personas:db.personas}); p.obs.art='13'; save(); renderHoy() }
$qs(null,'#accArt26').onclick=function(){ if(!isAdmin()||!accId)return; const p=getById(accId); pushUndo({type:'general',personas:db.personas}); p.obs.art='26'; save(); renderHoy() }
$qs(null,'#accArtClear').onclick=function(){ if(!isAdmin()||!accId)return; const p=getById(accId); pushUndo({type:'general',personas:db.personas}); p.obs.art=null; save(); renderHoy() }
$qs(null,'#accPres04').onclick=function(){ if(!isAdmin()||!accId)return; pushUndo({type:'prioridad',prioridad:prioridadHoy}); if(prioridadHoy[accId]==='ART04'){delete prioridadHoy[accId]} else {prioridadHoy[accId]='ART04'}; renderHoy() }
$qs(null,'#accLicSave').onclick=function(){ if(!isAdmin()||!accId)return; const p=getById(accId); const d=$qs(null,'#accLicD').value,h=$qs(null,'#accLicH').value; if(!d||!h)return showBanner('Completar fechas'); pushUndo({type:'general',personas:db.personas}); p.obs.licencia={desde:d,hasta:h}; save(); renderHoy() }
$qs(null,'#accLicClear').onclick=function(){ if(!isAdmin()||!accId)return; const p=getById(accId); pushUndo({type:'general',personas:db.personas}); p.obs.licencia={desde:null,hasta:null}; save(); renderHoy() }
$qs(null,'#accAut').onclick=function(){ if(!isAdmin()||!accId)return; const p=getById(accId); pushUndo({type:'general',personas:db.personas}); p.obs.autorizado=!p.obs.autorizado; save(); renderHoy() }
$qs(null,'#accSalt').onclick=function(){ if(!isAdmin()||!accId)return; const p=getById(accId); pushUndo({type:'general',personas:db.personas}); p.salteado=!p.salteado; save(); renderHoy() }

/* Confirmar */
$qs(null,'#btnConfirmar').onclick=function(){
  if(!isAdmin())return showBanner('Solo Admin')
  const plan=getPlan()
  const idsAsig={}; plan.asignados.forEach(p=>idsAsig[p.id]=true)
  const rows=$all('#tablaDia tbody tr[data-id]')
  const recargos=[]
  rows.forEach(r=>{
    const id=r.dataset.id; if(!idsAsig[id])return
    const sel=r.querySelector('select'); const pab=sel?sel.value:''
    const inp=r.querySelector('input[type="text"]'); const obs=inp?inp.value.trim():''
    const per=getById(id); recargos.push({id:id,nombre:per?per.nombre:r.children[1].textContent,pabellon:pab,obsRecargo:obs})
  })
  const pasivos=plan.pasivos
  const fecha=fechaEl.value
  const falt=Math.max(0,parseInt(faltEl.value||'0',10))
  const glist=generalList(); if(!glist.length){showBanner('No hay personal');return}
  if(db.generalHead>=glist.length)db.generalHead=0
  pushUndo({type:'afterConfirm',personas:db.personas,generalHead:db.generalHead})

  const ventanaIdx=[], start=db.generalHead; let idx=start
  for(let k=0;k<falt&&k<glist.length;k++){ventanaIdx.push(idx); idx=(idx+1)%glist.length}
  const ventanaIds=ventanaIdx.map(i=>glist[i].id)
  const asigIds={}; recargos.forEach(r=>asigIds[r.id]=true)
  ventanaIds.forEach(id=>{
    const p=getById(id); if(!p)return
    const prio=prioridadHoy[id]; const lic=inLic(p,fecha)
    const quedo=!!asigIds[id] && !(prio==='ART13'||prio==='ART26'||prio==='ART04')
    if(quedo){ if((p.debeLista||0)>0)p.debeLista=0 }
    else{ if(!lic && (p.obs.art||p.obs.autorizado||prio)) if((p.debeLista||0)<1)p.debeLista=1 }
  })
  db.generalHead=(db.generalHead+falt)%glist.length

  const base=Date.now(); db.personas.forEach(p=>{if(p.rorder==null)p.rorder=base})
  recargos.forEach((r,i)=>{const p=getById(r.id); if(p)p.rorder=base+i+1})

  for(const pid in prioridadHoy){const why=prioridadHoy[pid]; if((why==='ART13'||why==='ART26')&&getById(pid))getById(pid).obs.art=null}
  const tail=Date.now()+100000; let k=0; db.personas.forEach(p=>{if(p.salteado)p.rorder=tail+(++k)})
  db.personas.forEach(p=>{p.obs.autorizado=false; p.salteado=false})

  // layout (para copiar despues)
  let c=0; const layout=[]
  plan.mostrados.forEach(item=>{
    const p=item.p, saltar=item.saltar; const prio=prioridadHoy[p.id]; const per=getById(p.id)||{}
    const tags=[]; if(prio)tags.push(prio==='ART13'?'(por 13)':prio==='ART26'?'(por 26)':'(por 04)')
    if(per.obs&&per.obs.autorizado)tags.push('(autorizado)')
    if(per.salteado)tags.push('(salteado)')
    if(per.obs&&per.obs.art&&!prio)tags.push('(ART '+per.obs.art+')')
    if(inLic(per,fecha))tags.push('(licencia)')
    if((per.debeLista||0)>0)tags.push('(debe '+per.debeLista+')')
    if(!saltar&&c<falt){
      const tr=$qs(null,'#tablaDia tbody tr[data-id="'+p.id+'"]')
      const sel=tr?tr.querySelector('select'):null; const pab=sel?sel.value:''; const inp=tr?tr.querySelector('input[type="text"]'):null; const ob=inp?inp.value.trim():''
      layout.push({id:p.id,nombre:p.nombre,counted:true,n:c+1,pabellon:pab,obsRecargo:ob,tags:tags}); c++
    }else if(saltar){ layout.push({id:p.id,nombre:p.nombre,counted:false,tags:tags}) }
  })
  db.historial.push({fecha:fmtDM(fecha),recargos:recargos,pasivos:pasivos.map(x=>({id:x.id,nombre:x.nombre})),llamados:[],layout:layout})
  save(); prioridadHoy={}; renderHistorial(); renderHoy(); showBanner('Guardia guardada')
}

/* Deshacer */
document.addEventListener('keydown',e=>{if(e.ctrlKey&&e.key.toLowerCase()==='z')$qs(null,'#btnDeshacer').click()})
$qs(null,'#btnDeshacer').onclick=function(){
  const s=popUndo(); if(!s){showBanner('Nada para deshacer');return}
  if(s.type==='prioridad'){prioridadHoy=s.prioridad||{}; renderHoy(); return}
  if(s.type==='general'){db.personas=JSON.parse(JSON.stringify(s.personas)); save(); renderGeneral(); renderHoy(); return}
  if(s.type==='afterConfirm'){db.personas=JSON.parse(JSON.stringify(s.personas)); db.generalHead=s.generalHead; save(); renderHoy(); showBanner('Se revirtio el listado (la confirmacion queda en historial)'); return}
}

/* Copiar resultado recargos+pasivos */
$qs(null,'#btnCopiarResultado').onclick=function(){
  const fecha=fechaEl.value, plan=getPlan(), falt=Math.max(0,parseInt(faltEl.value||'0',10))
  const lines=['RECARGOS '+fmtDM(fecha),'']; let c=0
  plan.mostrados.forEach(item=>{
    const p=item.p, saltar=item.saltar; const prio=prioridadHoy[p.id]; const tags=[]
    if(prio)tags.push(prio==='ART13'?'(por 13)':prio==='ART26'?'(por 26)':'(por 04)')
    if(p.obs&&p.obs.art&&!prio)tags.push('(ART '+p.obs.art+')')
    if(p.obs&&p.obs.autorizado)tags.push('(autorizado)')
    if(inLic(p,fecha))tags.push('(licencia)')
    if((p.debeLista||0)>0)tags.push('(debe '+p.debeLista+')')
    if(!saltar && c<falt){
      const tr=$qs(null,'#tablaDia tbody tr[data-id="'+p.id+'"]')
      const sel=tr?tr.querySelector('select'):null; const pab=sel?sel.value:''; const inp=tr?tr.querySelector('input[type="text"]'):null; const ob=inp?inp.value.trim():''
      const extraPab=pab?('  '+pab):''; const extraObs=ob?(' ('+ob+')'):''
      lines.push((++c)+') '+p.nombre+' '+tags.join(' ')+extraObs+extraPab)
    }else if(saltar){ lines.push('- '+p.nombre+' '+tags.join(' ')) }
  })
  lines.push('')
  const para=$qs(null,'#pasivosPara').value
  if(para==='siguiente'){
    const d=new Date(fecha); d.setDate(d.getDate()+1); const y=d.getFullYear(),m=('0'+(d.getMonth()+1)).slice(-2),dd=('0'+d.getDate()).slice(-2)
    lines.push('Pasivos (para '+dd+'/'+m+')','')
  }else{
    lines.push('Pasivos','')
  }
  plan.pasivos.forEach((p,i)=>{
    const tr=$qs(null,'#tablaDia tbody tr[data-id="'+p.id+'"]'); const inp=tr?tr.querySelector('input[type="text"]'):null; const ob=inp?inp.value.trim():''
    lines.push((i+1)+') '+p.nombre+(ob?(' ('+ob+')'):''))
  })
  navigator.clipboard?.writeText(lines.join('\n')).then(()=>showBanner('Copiado')).catch(()=>{const w=window.open('','_blank');w.document.write('<pre>'+lines.join('\n')+'</pre>');w.document.close();w.focus()})
}

/* Historial */
function renderHistorial(){
  const subRec=$qs(null,'#subRec'), subCamb=$qs(null,'#subCamb'), boxRec=$qs(null,'#histRecargos'), boxCamb=$qs(null,'#histCambios')
  subRec.onclick=()=>{subRec.classList.add('active');subCamb.classList.remove('active');boxRec.style.display='block';boxCamb.style.display='none'}
  subCamb.onclick=()=>{subCamb.classList.add('active');subRec.classList.remove('active');boxRec.style.display='none';boxCamb.style.display='block'}

  const tb=$qs(null,'#tablaHistorial tbody'); tb.innerHTML=''
  for(let idx=db.historial.length-1; idx>=0; idx--){
    const h=db.historial[idx]; const rec=(h.layout||[]).filter(x=>x.counted).length; const extra=(h.layout||[]).filter(x=>x.extra===true).length; const llam=(h.llamados||[]).length
    const tr=document.createElement('tr'); const vid='rec_det_'+idx
    tr.innerHTML="<td><button class='btn' data-toggle='"+vid+"'>Ver</button></td>"
      +"<td>"+h.fecha+" - Recargos: "+rec+" - Extras: "+extra+" - Llamados: "+llam+"</td>"
      +"<td><button class='btn danger only-super' data-del='"+idx+"'>Borrar</button> <button class='btn' data-copy='"+idx+"'>Copiar</button></td>"
    tb.appendChild(tr)
    const det=document.createElement('tr'); det.id=vid; det.style.display='none'
    const htmlRec=(h.layout||[]).map(x=>{
      if(x.counted){const pab=x.pabellon?(' - Pab: '+x.pabellon):''; const tags=(x.tags&&x.tags.length)?(' '+x.tags.join(' ')):''; const obs=x.obsRecargo?(' - Obs: '+x.obsRecargo):''; return '<li>'+x.n+') '+x.nombre+tags+pab+obs+'</li>'}
      else{return '<li>- '+x.nombre+'</li>'}
    }).join('')
    const htmlPas=(h.pasivos||[]).map((x,i)=>{const nombre=(getById(x.id)?getById(x.id).nombre:x.nombre);const chk=(h.llamados||[]).indexOf(x.id)>=0?'checked':'';const dis=(idx===db.historial.length-1&&isAdmin())?'':'disabled';return '<li><label><input type="checkbox" data-h="'+idx+'" data-id="'+x.id+'" '+dis+' '+chk+'> '+(i+1)+') '+nombre+'</label></li>'}).join('')||'<li>-</li>'
    det.innerHTML="<td></td><td colspan='2'><div class='row' style='gap:18px'><div><b>Recargos</b><ul style='padding-left:18px;margin:6px 0 0'>"+htmlRec+"</ul></div><div><b>Pasivos (Fue llamado)</b><ul style='padding-left:18px;margin:6px 0 0'>"+htmlPas+"</ul></div></div></td>"
    tb.appendChild(det)
  }
  tb.onclick=function(e){
    const t=e.target
    if(t.dataset.toggle){const row=$qs(null,'#'+t.dataset.toggle); if(row)row.style.display=(row.style.display==='none')?'table-row':'none'}
    if(t.dataset.del){ if(!isSuper())return showBanner('Solo Superadmin'); const i=parseInt(t.dataset.del,10); ask('Borrar registro?').then(ok=>{if(!ok)return; db.historial.splice(i,1); save(); renderHistorial()}) }
    if(t.dataset.copy){
      const i=parseInt(t.dataset.copy,10); const h=db.historial[i]; const lines=['RECARGOS '+h.fecha,'']; let c=0
      (h.layout||[]).forEach(x=>{ if(x.counted){const pab=x.pabellon?('  '+x.pabellon):''; const tags=(x.tags&&x.tags.length)?(' '+x.tags.join(' ')):''; const obs=x.obsRecargo?(' ('+x.obsRecargo+')'):''; lines.push((++c)+') '+x.nombre+tags+obs+pab)} else lines.push('- '+x.nombre) })
      lines.push('','Pasivos',''); (h.pasivos||[]).forEach((x,i)=>{const nombre=(getById(x.id)?getById(x.id).nombre:x.nombre); lines.push((i+1)+') '+nombre) })
      navigator.clipboard?.writeText(lines.join('\n')).then(()=>showBanner('Copiado')).catch(()=>{const w=window.open('','_blank');w.document.write('<pre>'+lines.join('\n')+'</pre>');w.document.close();w.focus()})
    }
  }

  // Cambios (no desplegable)
  const tc=$qs(null,'#tablaCambios tbody'); tc.innerHTML=''
  for(let i=db.cambios.length-1;i>=0;i--){
    const c=db.cambios[i]
    const desc=c.tipo==='agregar'?'Se agrego: '+c.nombre
      : c.tipo==='eliminar'?'Se elimino: '+c.nombre
      : c.tipo==='mover'?'Se movio: '+c.nombre+' '+(c.detalle||'')
      : c.tipo==='ordenar'?'Se ordeno: '+(c.detalle||'')
      : c.tipo==='deshacer-orden'?'Se deshizo el orden'
      : (c.detalle||c.tipo)
    const tr=document.createElement('tr')
    tr.innerHTML="<td>"+desc+"</td><td><button class='btn danger only-super' data-delc='"+i+"'>Borrar</button></td>"
    tc.appendChild(tr)
  }
  tc.onclick=function(e){const t=e.target; if(t.dataset.delc){ if(!isSuper())return showBanner('Solo Superadmin'); const i=parseInt(t.dataset.delc,10); ask('Borrar item?').then(ok=>{if(!ok)return; db.cambios.splice(i,1); save(); renderHistorial()}) }}

  applyRoleVisibility()
}

$qs(null,'#btnGuardarLlamados').onclick=function(){
  if(!isAdmin())return showBanner('Solo Admin');
  if(!db.historial.length)return;
  const idx=db.historial.length-1; const h=db.historial[idx]
  const checks=$all("input[type='checkbox'][data-h='"+idx+"']"); h.llamados=checks.filter(c=>c.checked).map(c=>c.dataset.id)
  save(); renderHistorial(); showBanner('Llamados guardados')
}

/* Export / Import */
$qs(null,'#btnExportar').onclick=function(){const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='recargapp_db.json';a.click();URL.revokeObjectURL(url)}
$qs(null,'#btnImportar').onclick=function(){if(!isAdmin())return showBanner('Solo Admin');const inp=document.createElement('input');inp.type='file';inp.accept='.json,application/json';inp.onchange=e=>{const f=e.target.files[0];if(!f)return;const fr=new FileReader();fr.onload=()=>{try{db=JSON.parse(fr.result);save();renderAll()}catch(_){showBanner('Archivo invalido')}};fr.readAsText(f)};inp.click()}

/* Render inicial */
function renderAll(){renderGeneral();renderHoy();renderHistorial();applyRoleVisibility()}
renderAll()

/* Drawer "Mas" y notas */
const drawer=$qs(null,'#drawer'), fab=$qs(null,'#fabMore')
fab.onclick=function(){drawer.style.display='block'; loadReleaseNotes()}
$qs(null,'#closeDrawer').onclick=()=>drawer.style.display='none'
$qs(null,'#drawer .back').onclick=()=>drawer.style.display='none'

async function loadReleaseNotes(){
  const vtxt=$qs(null,'#appVersion').textContent.trim()
  $qs(null,'#drawerVersion').textContent=vtxt?('('+vtxt+')'):''
  const box=$qs(null,'#releaseNotes')
  try{
    const res=await fetch('/RecargApp/release-notes.json?t='+(+new Date()),{cache:'no-store'})
    if(!res.ok) throw 0
    const data=await res.json()
    const notes=Array.isArray(data)?data:(Array.isArray(data.notes)?data.notes:[])
    if(!notes.length){box.textContent='No hay notas disponibles.';return}
    const html=notes.map(n=>{
      if(typeof n==='string') return '<li>'+n+'</li>'
      const head=(n.version?('V'+n.version+' - '):'')+(n.date||'')
      const items=Array.isArray(n.items)?('<ul>'+n.items.map(i=>'<li>'+i+'</li>').join('')+'</ul>'):''
      const text=(n.text||'')
      return '<div style="margin:8px 0"><b>'+head+'</b>'+items+(text?('<div>'+text+'</div>'):'')+'</div>'
    }).join('')
    box.innerHTML=html
  }catch(e){ box.textContent='No pude leer /RecargApp/release-notes.json' }
}

/* ===== PWA / Version visible ===== */
(async function wireUpdatesUI(){
  if (!('serviceWorker' in navigator)) return;
  const reg = await navigator.serviceWorker.register('/RecargApp/sw.js', { scope: '/RecargApp/' }).catch(()=>null);
  if(!reg) return;

  // Version instalada (desde SW si responde, si no, desde manifest)
  async function getInstalledSwVersion() {
    if (!navigator.serviceWorker.controller) return null;
    return new Promise((resolve) => {
      const ch = new MessageChannel();
      ch.port1.onmessage = (ev) => resolve(ev.data || null);
      try { navigator.serviceWorker.controller.postMessage({ type: 'GET_VERSION' }, [ch.port2]); }
      catch { resolve(null); }
    });
  }
  async function renderInstalledVersion() {
    const el = document.getElementById('appVersion');
    if (!el) return;
    const info = await getInstalledSwVersion();
    if (info && info.cacheVersion) {
      const v = String(info.cacheVersion).replace(/^.*?-v/i, 'V');
      el.textContent = v;
    } else {
      try {
        const res = await fetch('/RecargApp/manifest.json', { cache: 'no-store' });
        const m = await res.json();
        const v = m.version ? 'V' + m.version :
                  (m.name && (m.name.match(/V\d+(\.\d+)*/i)?.[0] || ''));
        el.textContent = v || '¡ª';
      } catch {
        el.textContent = '¡ª';
      }
    }
  }
  renderInstalledVersion();

  // Mostrar "Disponible" sin instalar
  async function checkForUpdateAndShow(reg) {
    const availWrap = document.getElementById('appVersionAvailWrap');
    const availEl   = document.getElementById('appVersionAvail');
    if (!availWrap || !availEl) return;
    try { await reg.update(); } catch (_) {}
    const showAvail = async () => {
      try {
        const res = await fetch('/RecargApp/manifest.json', { cache: 'no-store' });
        const m = await res.json();
        const v = m.version ? 'V' + m.version :
                  (m.name && (m.name.match(/V\d+(\.\d+)*/i)?.[0] || ''));
        if (v) { availEl.textContent = v; availWrap.style.display = 'inline'; }
      } catch {}
    };
    if (reg.waiting) { await showAvail(); return; }
    const installing = reg.installing;
    if (installing) {
      installing.addEventListener('statechange', async () => {
        if (installing.state === 'installed') await showAvail();
      });
    }
  }

  checkForUpdateAndShow(reg);
  reg.addEventListener('updatefound', () => checkForUpdateAndShow(reg));

  // Aplicar update solo con confirm
  const btnApply = document.getElementById('btnApplyUpdate');
  if (btnApply) {
    btnApply.onclick = async () => {
      const reg2 = await navigator.serviceWorker.getRegistration('/RecargApp/');
      if (reg2 && reg2.waiting) {
        const ok = await ask('Hay una actualizacion disponible. Instalar ahora?');
        if (ok) reg2.waiting.postMessage({ type: 'SKIP_WAITING' });
      } else {
        showBanner('No hay una actualizacion esperando');
      }
    };
  }

  // Boton de buscar updates
  const btn = document.getElementById('btnCheckUpdates');
  if (btn) {
    btn.onclick = async () => {
      const msg = document.getElementById('updMsg');
      if (msg) msg.textContent = 'Buscando...';
      await checkForUpdateAndShow(reg);
      const availWrap = document.getElementById('appVersionAvailWrap');
      if (!availWrap || availWrap.style.display !== 'inline') {
        if (msg) msg.textContent = 'Estas actualizado';
        else showBanner('Estas actualizado');
      } else {
        if (msg) msg.textContent = 'Actualizacion disponible';
      }
    };
  }

  // Reload al activar
  let refreshing=false;
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    if (refreshing) return;
    refreshing = true;
    window.location.reload();
  });

  // Install prompt
  let deferred=null; const btnI=$qs(null,'#btnInstall');
  window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferred=e; if(btnI)btnI.style.display='inline-block'});
  if(btnI){btnI.onclick=async()=>{if(!deferred)return; await deferred.prompt(); await deferred.userChoice; deferred=null; btnI.style.display='none'}}
})();
</script>
</body>
</html>
