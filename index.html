<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RecargApp</title>

  <!-- PWA -->
  <link rel="manifest" href="/RecargApp/manifest.json">
  <meta name="theme-color" content="#0b1223" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="/RecargApp/icons/icon-192x192.png">

  <style>
    :root{
      --bg:#0f172a;--card:#111827;--muted:#94a3b8;--ok:#16a34a;--warn:#f59e0b;--err:#ef4444;--ink:#e5e7eb;--accent:#38bdf8;
      --brand:#0b1223;--border:#1f2937
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink)}

    /* HEADER */
    header{padding:10px 12px;border-bottom:1px solid var(--border);background:var(--brand);position:sticky;top:0;z-index:5}
    .appbar{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:10px;max-width:1150px;margin:0 auto}
    .brand{display:flex;align-items:center;gap:8px}
    .brand img{width:28px;height:28px;border-radius:6px}
    .titleWrap{display:flex;justify-content:center;align-items:center}
    h1{font-size:24px;margin:0;letter-spacing:.2px}
    @media(max-width:720px){ h1{font-size:20px} }
    .header-actions{display:flex;gap:8px;align-items:center;justify-content:flex-end}
    .tabs{display:flex;gap:6px;justify-content:center;margin-top:10px;flex-wrap:wrap}
    .tab{background:var(--brand);border:1px solid var(--border);color:var(--muted);padding:6px 10px;border-radius:10px;cursor:pointer}
    .tab.active{color:#fff;border-color:#2563eb;background:linear-gradient(180deg,#1f6feb,#1463d6)}

    /* LAYOUT */
    main{padding:10px;max-width:1150px;margin:0 auto}
    .section{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:12px}
    h2{margin:0 0 8px;font-size:13px;color:var(--muted);letter-spacing:.12em;text-transform:uppercase}

    /* TABLAS */
    .tableWrap{width:100%;overflow-x:auto}
    table{width:100%;border-collapse:collapse;table-layout:fixed;min-width:680px}
    th,td{padding:6px 8px;border-bottom:1px solid var(--border);text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    th{color:var(--accent)}

    /* columnas HOY */
    #tablaDia th:nth-child(1),#tablaDia td:nth-child(1){width:40px}
    #tablaDia th:nth-child(2),#tablaDia td:nth-child(2){width:190px}
    #tablaDia th:nth-child(3),#tablaDia td:nth-child(3){width:110px}
    #tablaDia th:nth-child(4),#tablaDia td:nth-child(4){width:230px} /* Estado */
    #tablaDia th:nth-child(5),#tablaDia td:nth-child(5){width:120px}
    #tablaDia th:nth-child(6),#tablaDia td:nth-child(6){width:180px}
    #tablaDia th:nth-child(7),#tablaDia td:nth-child(7){width:120px}

    /* Pasivos */
    #tablaPasivos{min-width:0}
    #tablaPasivos th:nth-child(1),#tablaPasivos td:nth-child(1){width:40px}
    #tablaPasivos th:nth-child(2),#tablaPasivos td:nth-child(2){width:220px}
    #tablaPasivos th:nth-child(3),#tablaPasivos td:nth-child(3){width:140px}

    /* General (compacta y con columna Delete bien encajada) */
    #tablaGeneral{min-width:760px}
    #tablaGeneral th,#tablaGeneral td{padding:6px}
    #tablaGeneral th:nth-child(1),#tablaGeneral td:nth-child(1){width:56px}
    #tablaGeneral th:nth-child(2),#tablaGeneral td:nth-child(2){width:220px}
    #tablaGeneral th:nth-child(3),#tablaGeneral td:nth-child(3){width:110px}
    #tablaGeneral th:nth-child(4),#tablaGeneral td:nth-child(4){width:110px}
    #tablaGeneral th:nth-child(5),#tablaGeneral td:nth-child(5){width:150px}
    #tablaGeneral th:nth-child(6),#tablaGeneral td:nth-child(6){width:70px}
    #tablaGeneral th:nth-child(7),#tablaGeneral td:nth-child(7){width:70px}
    #tablaGeneral th:nth-child(8),#tablaGeneral td:nth-child(8){width:200px}
    #tablaGeneral th:nth-child(9),#tablaGeneral td:nth-child(9){width:56px;text-align:center}

    input,select,textarea{background:#0b1223;border:1px solid var(--border);color:var(--ink);border-radius:8px;padding:6px;width:100%}
    input[type=date]{cursor:pointer}
    textarea{resize:vertical;min-height:30px;max-height:120px}
    .row{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    button{border:0;border-radius:8px;padding:6px 10px;font-weight:600;cursor:pointer}
    .btn{background:#0b1223;border:1px solid var(--border);color:#d1d5db}
    .icon-btn{padding:6px 8px;min-width:0;line-height:1}
    .primary{background:linear-gradient(180deg,#1f6feb,#1463d6);color:#fff;border:0}
    .warn{background:linear-gradient(180deg,#f59e0b,#d97706);color:#fff}
    .danger{background:linear-gradient(180deg,#ef4444,#dc2626);color:#fff}
    .btn-acciones{background:#0891b2;border-color:#0e7490;color:#fff}
    .btn-secondary{background:#374151;border-color:#4b5563;color:#e5e7eb}
    .btn-autorizado{background:#1d4ed8;border-color:#1e40af;color:#fff}
    .btn-saltear{background:#6d28d9;border-color:#5b21b6;color:#fff}
    .btn-pres04{background:#15803d;border-color:#166534;color:#fff}
    .btn-art13{background:#b91c1c;border-color:#7f1d1d;color:#fff}
    .btn-art26{background:#d97706;border-color:#a16207;color:#fff}

    .pill{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border-radius:999px;border:1px solid #334155;white-space:nowrap}
    .pill.warn{background:#2a1b05;color:#fbbf24}
    .pill.err{background:#3b0a0a;color:#fca5a5}
    .pill.ok{background:#052e1a;color:#86efac}
    .muted{color:var(--muted)}
    .note{font-size:12px;color:#9ca3af}
    .lock{opacity:.6}

    .banner{background:#065f46;border:1px solid #14532d;color:#d1fae5;border-radius:12px;padding:8px 12px;margin:8px auto;max-width:1150px;display:none}
    .banner strong{letter-spacing:.02em}

    /* Modales */
    #backdrop, #backdropExtra, #backdropAbout{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:20}
    .modal{background:#0b1223;border:1px solid var(--border);border-radius:12px;min-width:300px;max-width:95vw;padding:12px}
    .modal .row.justify-end{justify-content:flex-end}

    /* Drawer "Mas" */
    .drawer{position:fixed;top:0;right:0;height:100%;width:380px;max-width:95vw;background:#0b1223;border-left:1px solid var(--border);transform:translateX(100%);transition:transform .25s ease;z-index:30;padding:12px 12px 16px}
    .drawer.open{transform:translateX(0)}

    /* Boton flotante Mas (tres puntitos) */
    .fab{position:fixed;right:14px;bottom:14px;border-radius:999px;padding:10px 14px;background:#0b1223;color:#e5e7eb;border:1px solid var(--border);cursor:pointer;z-index:29}
    .fab .dots{font-size:20px;line-height:0}

    /* M¨®vil */
    @media (max-width:600px){
      html,body{font-size:13px}
      .appbar{grid-template-columns:1fr auto 1fr}
      .titleWrap{grid-column:1 / 4}
      .brand{justify-content:flex-start}
      .header-actions{grid-column:3;justify-content:flex-end}
      main{padding:8px}
      .section{padding:10px}
      .row{gap:4px}
      button{padding:7px 9px}
      table{min-width:0}
      #backdrop{align-items:flex-end}
      .modal{width:100vw;max-width:none;border-radius:12px 12px 0 0}
      .drawer{width:100vw}
    }
  </style>
</head>
<body>
  <!-- Bot¨®n de instalaci¨®n -->
  <button class="btn" id="btnInstall" style="display:none;margin:8px">Instalar</button>

  <header>
    <div class="appbar">
      <div class="brand">
        <img src="/RecargApp/icons/icon-192x192.png" alt="logo">
      </div>
      <div class="titleWrap">
        <h1>RecargApp</h1>
      </div>
      <div class="header-actions">
        <span id="lockState" class="muted lock" style="align-self:center">Modo lectura</span>
        <button class="btn icon-btn" id="btnCambiarPinAdmin" style="display:none" title="Cambiar PIN Admin">Clave</button>
        <button class="btn" id="btnToggleAdmin" title="Iniciar sesion">Iniciar sesion</button>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="hoy">Recargos</div>
      <div class="tab" data-tab="general">Lista</div>
      <div class="tab" data-tab="historial">Historial</div>
    </div>
  </header>

  <main>
    <div id="banner" class="banner"></div>

    <!-- TAB: HOY -->
    <section class="section" data-panel="hoy">
      <h2 id="tituloDia">RECARGOS DEL DIA</h2>
      <div class="row">
        <label>Fecha</label>
        <input id="fecha" type="date" style="max-width:160px">
        <label>Faltantes</label>
        <input id="faltantes" type="number" value="1" min="0" style="max-width:90px">
        <button class="btn" id="btnAgregarExtraDia" title="Agregar persona ajena a la lista">+ Extra</button>
        <button class="danger" id="btnReiniciar" style="margin-left:auto">Reiniciar lista</button>
        <button class="btn" id="btnActualizar">Actualizar</button>
        <button class="btn" id="btnCopiarListado">Copiar orden</button>
      </div>

      <!-- Listado del dia -->
      <div style="margin-top:8px">
        <h2>Listado del dia</h2>
        <div class="tableWrap">
          <table id="tablaDia">
            <thead>
              <tr>
                <th>#</th><th>Nombre</th><th>Jerarquia</th><th>Estado</th><th>Pabellon</th><th>Obs recargo</th><th>Acc</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="note">* ART, AUTORIZADO, SALTEADO o LICENCIA se muestran pero no numeran. Con Presente de ART (13/26/04) suben y cuentan. "debe X" se ve en la fila.</div>
      </div>

      <!-- Pasivos (DEBAJO) -->
      <div style="margin-top:14px">
        <div class="row" style="justify-content:flex-start;gap:12px">
          <h2>Pasivos</h2>
          <label for="francoSel" class="muted">en</label>
          <select id="francoSel" style="max-width:150px">
            <option value="1">1er Franco</option>
            <option value="2">2do Franco</option>
          </select>
        </div>
        <div class="tableWrap">
          <table id="tablaPasivos">
            <thead>
              <tr><th>#</th><th>Nombre</th><th>Jerarquia</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Acciones de dia -->
      <div class="row" style="margin-top:16px;justify-content:space-between">
        <div class="row" style="gap:10px">
          <button class="primary" id="btnConfirmar">Confirmar guardia</button>
          <button class="warn" id="btnDeshacer">Deshacer ultima</button>
        </div>
        <div class="row" style="gap:10px">
          <button class="btn" id="btnImprimirPasivos">Imprimir pasivos</button>
          <button class="btn" id="btnCopiarResultado">Copiar recargos+pasivos</button>
        </div>
      </div>
    </section>

    <!-- TAB: GENERAL -->
    <section class="section" data-panel="general" style="display:none">
      <h2>Listado general (Editar permite arrastrar y eliminar)</h2>
      <div class="row">
        <input id="nombre" placeholder="Nombre y Apellido" style="max-width:240px">
        <input id="dni" placeholder="DNI" style="max-width:110px">
        <input id="legajo" placeholder="Legajo" style="max-width:110px">
        <select id="jerarquia" style="max-width:160px">
          <option>AYTE MY (CG)</option><option>AYTE PR (CG)</option><option>AYTE 1¡ã (CG)</option><option>AYTE 2¡ã (CG)</option><option>AYTE 3¡ã (CG)</option><option>AYTE 4¡ã (CG)</option><option>AYTE 5¡ã (CG)</option><option>SUBAYTE (CG)</option><option>- vacio -</option>
        </select>
        <input id="antiguedad" type="number" placeholder="Antiguedad (a?os)" style="max-width:120px">
        <button class="primary" id="btnAgregar">Agregar</button>
        <button class="btn" id="btnOrdenarCriterios">Ordenar (Jerarquia -> Antiguedad)</button>
        <button class="btn" id="btnDeshacerOrden" title="Volver al orden anterior">Deshacer orden</button>
        <button class="warn" id="btnEditarGeneral" title="Editar en linea y arrastrar">Editar</button>
      </div>
      <div class="tableWrap">
        <table id="tablaGeneral" style="margin-top:6px">
          <thead><tr>
            <th>Orden</th><th>Nombre</th><th>DNI</th><th>Legajo</th><th>Jerarquia</th><th>Antig.</th><th>Debe</th><th>Obs</th><th>Del</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="row" style="margin-top:8px;justify-content:flex-start">
        <button class="btn" id="btnExportar">Exportar JSON</button>
        <button class="btn" id="btnImportar">Importar JSON</button>
        <button class="btn" id="btnAgregarExtra">Agregar extra</button>
      </div>
      <div class="note">El Admin puede reordenar; eliminar y editar en linea disponibles en modo Editar.</div>
    </section>

    <!-- TAB: HISTORIAL (subtabs) -->
    <section class="section" data-panel="historial" style="display:none">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2>Historial</h2>
        <div class="row">
          <button class="danger" id="btnBorrarHistRec" style="display:none">Borrar hist. Recargos</button>
          <button class="danger" id="btnBorrarHistCamb" style="display:none">Borrar hist. Cambios</button>
        </div>
      </div>

      <div class="tabs" id="tabsHist" style="margin-top:8px">
        <div class="tab active" data-htab="rec">Recargos</div>
        <div class="tab" data-htab="chg">Cambios</div>
      </div>

      <!-- Recargos -->
      <div id="histRec" class="section" style="margin-top:10px">
        <div class="row" style="margin:6px 0 8px;justify-content:space-between;align-items:center">
          <div class="muted">Fue llamado</div>
          <button class="primary" id="btnGuardarLlamados">Guardar llamados del ultimo</button>
        </div>
        <div class="tableWrap">
          <table id="tablaHistorial">
            <thead><tr><th>Resumen</th><th>Acciones</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Cambios -->
      <div id="histCamb" class="section" style="display:none;margin-top:10px">
        <div class="tableWrap">
          <table id="tablaCambios">
            <thead><tr><th>Fecha</th><th>Accion</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal acciones persona -->
  <div id="backdrop">
    <div class="modal" id="modalAcciones">
      <h3 style="margin:0 0 8px;font-size:15px">Acciones para <span id="modalNombre"></span></h3>
      <div class="row">
        <button class="btn btn-art13 icon-btn" onclick="modalSetArt('13')">13</button>
        <button class="btn btn-art26 icon-btn" onclick="modalSetArt('26')">26</button>
        <button class="btn btn-secondary icon-btn" onclick="modalSetArt('clear')" title="Quitar ART">Quitar</button>
        <button class="btn btn-pres04" onclick="modalTogglePresente04()">Presente 04</button>
      </div>
      <hr style="border-color:#1f2937; margin:10px 0">
      <div class="row">
        <label>Licencia desde</label>
        <input id="licDesde" type="date" style="max-width:180px">
        <label>hasta</label>
        <input id="licHasta" type="date" style="max-width:180px">
        <button class="btn" onclick="modalSetLic()">Guardar licencia</button>
        <button class="danger" onclick="modalClearLic()">Quitar licencia</button>
      </div>
      <hr style="border-color:#1f2937; margin:10px 0">
      <div class="row">
        <button class="btn btn-autorizado" onclick="modalToggleAutorizado()">AUTORIZADO</button>
        <button class="btn btn-saltear" onclick="modalToggleSalteado()">SALTEAR</button>
      </div>
      <div class="row justify-end" style="margin-top:6px">
        <button class="primary" onclick="closeModal()">Listo</button>
      </div>
    </div>
  </div>

  <!-- Modal Agregar Extra -->
  <div id="backdropExtra">
    <div class="modal" id="modalExtra">
      <h3 style="margin:0 0 8px;font-size:15px">Agregar Extra</h3>
      <div class="row">
        <input id="extraNombre" placeholder="Nombre (opcional)" style="max-width:220px">
        <input id="extraJer" placeholder="Jerarquia (opcional)" style="max-width:180px">
        <select id="extraPab" style="max-width:200px">
          <option value="">Pabellon (opcional)</option>
          <option>Vigilancia</option><option>Pab 1</option><option>Pab 3S</option><option>Pab 3N</option>
          <option>Pab 5S</option><option>Pab 5N</option><option>Pab 7</option><option>Pab 9</option>
          <option>Pab 11</option><option>Pab Aisl</option><option>Cruz</option><option>Porton</option>
        </select>
        <input id="extraObs" placeholder="Observacion (opcional)" style="max-width:240px">
      </div>
      <div class="row justify-end" style="margin-top:10px;gap:8px">
        <button class="btn" onclick="cerrarExtra()">Cancelar</button>
        <button class="primary" onclick="confirmarExtra()">Agregar</button>
      </div>
    </div>
  </div>

  <!-- Drawer: Acerca de / Notas -->
  <div class="drawer" id="drawer">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0;font-size:16px">Acerca de</h3>
      <button class="btn icon-btn" id="btnCloseDrawer" title="Cerrar">X</button>
    </div>
    <p class="muted" id="aboutDesc" style="margin:6px 0 10px">
      Herramienta para armar recargos, gestionar pasivos y llevar historial. PWA instalable.
    </p>
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
      <div>Version actual: <b><span id="aboutVersion">-</span></b></div>
      <button class="btn" id="btnBuscarUpdates">Buscar actualizaciones</button>
    </div>
    <div>
      <h4 style="margin:6px 0 4px">Notas de actualizacion</h4>
      <div id="releaseNotes" class="note" style="max-height:40vh;overflow:auto;border:1px solid var(--border);border-radius:8px;padding:8px">Cargando...</div>
    </div>
  </div>
  <button class="fab" id="btnAbout" title="Mas"><span class="dots">¡¤¡¤¡¤</span></button>

  <footer style="text-align:center;color:#aaa;font-size:0.8em;margin:12px 0;">
    Version <span id="appVersion">-</span>
  </footer>

<script>
/* ===== util ===== */
function $all(sel, root){ return Array.prototype.slice.call((root||document).querySelectorAll(sel)); }
function $qs(root, sel){ return (root||document).querySelector(sel); }
function fmtDM(s){ var a=s.split('-'); return a[2]+"/"+a[1]; }
function fmtDM_from(dateStr){ var a=dateStr.split('-'); return a[2]+"/"+a[1]; }
function addDaysISO(iso, days){ const d=new Date(iso); d.setDate(d.getDate()+days); return d.toISOString().slice(0,10); }

/* Mostrar errores en Android antiguos */
window.addEventListener('error', e => { try{ alert('Error JS: ' + e.message); }catch(_){} console.error(e); });

/* ===== Modelo ===== */
const KEY='recargapp.v1';
let ADMIN_PIN = localStorage.getItem('recargapp.admin.pin') || '1111';
const SUPERADMIN_PIN='9999';
function setAdminPin(newPin){ ADMIN_PIN=String(newPin); localStorage.setItem('recargapp.admin.pin', ADMIN_PIN); }

function save(){ localStorage.setItem(KEY, JSON.stringify(db)); }
function load(){ try{ return JSON.parse(localStorage.getItem(KEY)||'null'); }catch(e){ return null; } }
function uid(){ return Math.random().toString(36).slice(2,9); }
function today(){ return new Date().toISOString().slice(0,10); }
function inLicencia(p, fecha){ var L=p.obs.licencia; if(!L||!L.desde||!L.hasta) return false; return (fecha>=L.desde && fecha<=L.hasta); }
function isDayAfter(dateStr, baseStr){ if(!dateStr||!baseStr) return false; var d=new Date(dateStr), b=new Date(baseStr); var next = new Date(d.getTime()+86400000); return next.toISOString().slice(0,10)===b.toISOString().slice(0,10); }

let db = load() || { personas: [], historial: [], generalHead: 0, cambios: [] };
if(db.personas){ var base=Date.now(); db.personas.forEach(function(p,i){ if(p.rorder==null){ p.rorder = (typeof p.order==='number')? p.order : (base+i); } if(typeof p.debeLista!=='number'){ p.debeLista=0; } if(!p.obs){ p.obs={art:null, licencia:{desde:null,hasta:null}, autorizado:false}; } }); }

/* Extras del dia (no persiste en la lista general) */
let extrasToday = []; // {id,nombre,jerarquia,pab,obs}

/* ===== Header / sesion ===== */
var lockState=$qs(null,'#lockState');
var btnToggleAdmin=$qs(null,'#btnToggleAdmin');
var btnCambiarPinAdmin=$qs(null,'#btnCambiarPinAdmin');
let role='viewer';

btnToggleAdmin.onclick=function(){
  if(role!=='viewer'){ role='viewer'; lockState.textContent='Modo lectura'; btnToggleAdmin.textContent='Iniciar sesion'; if(btnCambiarPinAdmin) btnCambiarPinAdmin.style.display='none'; renderAll(); return; }
  var code=prompt('Ingresar PIN');
  if(code===ADMIN_PIN){ role='admin'; lockState.textContent='Modo ADMIN'; btnToggleAdmin.textContent='Cerrar sesion'; if(btnCambiarPinAdmin) btnCambiarPinAdmin.style.display='none'; renderAll(); }
  else if(code===SUPERADMIN_PIN){ role='superadmin'; lockState.textContent='SUPERADMIN'; btnToggleAdmin.textContent='Cerrar sesion'; if(btnCambiarPinAdmin) btnCambiarPinAdmin.style.display='inline-block'; renderAll(); }
  else if(code!==null){ alert('PIN incorrecto'); }
};

if(btnCambiarPinAdmin){
  btnCambiarPinAdmin.onclick=function(){
    if(role!=='superadmin') return alert('Solo superadmin');
    var np=prompt('Nueva clave de ADMIN (4-8 digitos):'); if(np==null) return;
    np=np.trim(); if(!/^\d{4,8}$/.test(np)) return alert('Debe ser de 4 a 8 digitos.');
    setAdminPin(np); showBanner('Clave de ADMIN actualizada');
  };
}

function isAdmin(){ return role==='admin' || role==='superadmin'; }
function isSuper(){ return role==='superadmin'; }

/* ===== Tabs ===== */
var tabs = $all('.tab');
var panels = $all('[data-panel]');
tabs.forEach(function(t){
  t.addEventListener('click', function(){
    tabs.forEach(x=>x.classList.remove('active'));
    t.addEventListener;
    t.classList.add('active');
    var name=t.getAttribute('data-tab');
    panels.forEach(p=>p.style.display = (p.getAttribute('data-panel')===name)?'block':'none');
    renderAll();
  });
});

/* ===== Banner ===== */
function showBanner(msg, opts){
  opts = opts || {};
  var b=$qs(null,'#banner'); if(!b) return;
  if(opts.html){ b.innerHTML = msg; } else { b.textContent = msg; }
  b.style.display='block';
  if(showBanner._t){ clearTimeout(showBanner._t); showBanner._t=null; }
  if(!opts.sticky){ showBanner._t=setTimeout(()=>{ b.style.display='none'; }, opts.timeout || 3000); }
}

/* ===== General ===== */
var snapshotOrden=null;
var editGeneral=false;
var nombreEl=$qs(null,'#nombre'), dniEl=$qs(null,'#dni'), legajoEl=$qs(null,'#legajo'), jerarquiaEl=$qs(null,'#jerarquia'), antigEl=$qs(null,'#antiguedad');

$qs(null,'#btnAgregar').onclick=function(){
  if(!isSuper()) return alert('Solo superadmin');
  if(!nombreEl.value.trim()) return alert('Nombre requerido');
  const p={ id:uid(), nombre:nombreEl.value.trim(), dni:dniEl.value.trim(), legajo:legajoEl.value.trim(), jerarquia:jerarquiaEl.value, antiguedad:parseInt(antigEl.value||'0',10), obs:{art:null, licencia:{desde:null,hasta:null}, autorizado:false}, order:Date.now(), rorder:Date.now(), debeLista:0, salteado:false };
  db.personas.push(p);
  db.cambios.push({ts:Date.now(), texto:'Agregado: '+p.nombre});
  save(); nombreEl.value=''; dniEl.value=''; legajoEl.value=''; antigEl.value=''; renderGeneral(); renderHoy(); renderCambios();
};

$qs(null,'#btnOrdenarCriterios').onclick=function(){
  if(!isSuper()) return alert('Solo superadmin');
  snapshotOrden = db.personas.map(p=>p.id);
  var rank={'AYTE MY (CG)':1,'AYTE PR (CG)':2,'AYTE 1¡ã (CG)':3,'AYTE 2¡ã (CG)':4,'AYTE 3¡ã (CG)':5,'AYTE 4¡ã (CG)':6,'AYTE 5¡ã (CG)':7,'SUBAYTE (CG)':8,'- vacio -':9};
  db.personas.sort((a,b)=> (rank[a.jerarquia]-rank[b.jerarquia]) || ((b.antiguedad||0)-(a.antiguedad||0)));
  var base=Date.now(); db.personas.forEach((p,i)=>{ p.order=base+i; });
  db.cambios.push({ts:Date.now(), texto:'Ordenado por jerarquia -> antiguedad'});
  save(); renderGeneral(); renderHoy(); renderCambios();
};

$qs(null,'#btnDeshacerOrden').onclick=function(){
  if(!isSuper()) return alert('Solo superadmin');
  if(!snapshotOrden) return alert('No hay orden anterior guardado');
  var base=Date.now(); snapshotOrden.forEach(function(id,i){ var p=getById(id); if(p){ p.order=base+i; } });
  db.cambios.push({ts:Date.now(), texto:'Deshacer orden'});
  save(); renderGeneral(); renderHoy(); renderCambios();
};

$qs(null,'#btnExportar').onclick=function(){
  var blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'}); var url=URL.createObjectURL(blob);
  var a=document.createElement('a'); a.href=url; a.download='recargapp_db.json'; a.click(); URL.revokeObjectURL(url);
};

$qs(null,'#btnImportar').onclick=function(){
  if(!isSuper()) return alert('Solo superadmin');
  var inp=document.createElement('input'); inp.type='file'; inp.accept='.json,application/json';
  inp.onchange=function(e){ var f=e.target.files[0]; if(!f) return; var fr=new FileReader(); fr.onload=function(){ try{ db=JSON.parse(fr.result); save(); renderAll(); }catch(err){ alert('Archivo invalido'); } }; fr.readAsText(f); };
  inp.click();
};

$qs(null,'#btnEditarGeneral').onclick=function(){
  if(!isAdmin()) return alert('Solo Admin');
  editGeneral=!editGeneral; $qs(null,'#btnEditarGeneral').textContent = editGeneral? 'Guardar' : 'Editar';
  renderGeneral();
};

function getById(id){ for(var i=0;i<db.personas.length;i++) if(db.personas[i].id===id) return db.personas[i]; return null; }

function renderGeneral(){
  var tbody=$qs(null,'#tablaGeneral tbody'); tbody.innerHTML='';
  var list=[].concat(db.personas).sort((a,b)=>a.order-b.order);
  list.forEach(function(p,i){
    var tr=document.createElement('tr'); tr.setAttribute('data-id', p.id);

    if(editGeneral){
      tr.setAttribute('draggable','true');
      tr.ondragstart=function(ev){ ev.dataTransfer.setData('text/plain', p.id); tr.classList.add('dragging'); };
      tr.ondragend=function(){ tr.classList.remove('dragging'); };
      tr.ondragover=function(ev){ ev.preventDefault(); tr.style.outline='1px dashed #334155'; };
      tr.ondragleave=function(){ tr.style.outline=''; };
      tr.ondrop=function(ev){
        ev.preventDefault(); tr.style.outline='';
        var fromId=ev.dataTransfer.getData('text/plain'); if(!fromId||fromId===p.id) return;
        var ordered=[].concat(db.personas).sort((a,b)=>a.order-b.order);
        var fromIdx=ordered.findIndex(x=>x.id===fromId), toIdx=ordered.findIndex(x=>x.id===p.id);
        if(fromIdx<0||toIdx<0) return;
        var moved=ordered.splice(fromIdx,1)[0]; ordered.splice(toIdx,0,moved);
        var base=Date.now(); ordered.forEach((x,idx)=>{ x.order=base+idx; });
        db.cambios.push({ts:Date.now(), texto:'Movido: '+moved.nombre+' -> posicion '+(toIdx+1)});
        save(); renderGeneral(); renderHoy(); renderCambios();
      };
    }

    function cell(txt){ return '<td>'+txt+'</td>'; }
    var cOrden = cell(i+1);
    var cNombre = cell(p.nombre);
    var cDNI = editGeneral ? '<td><input value="'+(p.dni||'')+'" onblur="setField(\''+p.id+'\',\'dni\',this.value)"></td>' : cell(p.dni||'');
    var cLegajo = editGeneral ? '<td><input value="'+(p.legajo||'')+'" onblur="setField(\''+p.id+'\',\'legajo\',this.value)"></td>' : cell(p.legajo||'');
    var jerOpts = ['AYTE MY (CG)','AYTE PR (CG)','AYTE 1¡ã (CG)','AYTE 2¡ã (CG)','AYTE 3¡ã (CG)','AYTE 4¡ã (CG)','AYTE 5¡ã (CG)','SUBAYTE (CG)','- vacio -'].map(function(j){ return '<option '+(p.jerarquia===j?'selected':'')+'>'+j+'</option>'; }).join('');
    var cJer = editGeneral ? '<td><select onchange="setField(\''+p.id+'\',\'jerarquia\',this.value)">'+jerOpts+'</select></td>' : cell(p.jerarquia);
    var cAnt = editGeneral ? '<td><input type="number" min="0" value="'+(p.antiguedad||0)+'" onblur="setField(\''+p.id+'\',\'antiguedad\',parseInt(this.value||\'0\',10))"></td>' : cell(p.antiguedad||0);
    var cDebe = editGeneral ? '<td><input type="number" min="0" value="'+(p.debeLista||0)+'" onblur="setField(\''+p.id+'\',\'debeLista\',parseInt(this.value||\'0\',10))"></td>' : cell(p.debeLista||0);

    var obsParts=[]; if(p.obs.art) obsParts.push('ART '+p.obs.art);
    if(p.obs.licencia && p.obs.licencia.desde && p.obs.licencia.hasta) obsParts.push('LIC '+p.obs.licencia.desde+'->'+p.obs.licencia.hasta);
    if(p.obs.autorizado) obsParts.push('AUTORIZADO'); if(p.salteado) obsParts.push('SALTEADO');
    var cObs = cell(obsParts.join(' | ')||'<span class="muted">-</span>');

    var cDel = editGeneral
      ? "<td style='text-align:center'><button class='danger icon-btn' title='Eliminar' onclick=\"eliminar('"+p.id+"')\">X</button></td>"
      : "<td></td>";

    tr.innerHTML = cOrden + cNombre + cDNI + cLegajo + cJer + cAnt + cDebe + cObs + cDel;

    if(!isAdmin()){
      $all('button,input,select', tr).forEach(function(el){ el.setAttribute('disabled','disabled'); el.classList.add('lock'); el.title='Solo Admin'; });
    }
    tbody.appendChild(tr);
  });
}
window.setField=function(id,key,val){
  if(!isAdmin()) return alert('Solo Admin');
  var p=getById(id); if(!p) return;
  var prev = (p[key]===undefined)?'':String(p[key]);
  p[key]=val;
  db.cambios.push({ts:Date.now(), texto:'Editado '+key+' de '+p.nombre+': "'+prev+'" -> "'+val+'"'});
  save();
};

function eliminar(id){
  if(!isAdmin()) return alert('Solo Admin');
  const p=getById(id); if(!p) return;
  if(!confirm('Eliminar a '+p.nombre+' del listado?')) return;
  db.personas=db.personas.filter(x=>x.id!==id);
  db.cambios.push({ts:Date.now(), texto:'Eliminado: '+p.nombre});
  save(); renderGeneral(); renderHoy(); renderCambios();
}

/* ===== HOY ===== */
var fechaEl=$qs(null,'#fecha'); var faltEl=$qs(null,'#faltantes'); fechaEl.value=today();
function setTitulo(){ $qs(null,'#tituloDia').textContent = 'RECARGOS '+fmtDM(fechaEl.value); }
setTitulo(); fechaEl.addEventListener('change', setTitulo);

$qs(null,'#btnReiniciar').onclick=function(){
  if(!isAdmin()) return alert('Solo Admin');
  if(confirm('Seguro? Esto reinicia la rotacion tomando el orden del listado general.')){
    var ordered=[].concat(db.personas).sort((a,b)=>a.order-b.order); var base=Date.now();
    ordered.forEach((p,i)=>{ p.rorder=base+i; });
    prioridadHoy={}; db.generalHead=0; save(); renderHoy();
  }
};
$qs(null,'#btnActualizar').onclick=function(){ renderHoy(); };

/* Agregar extra */
document.getElementById('btnAgregarExtra').onclick=function(){ if(!isAdmin()) return alert('Solo Admin'); abrirExtra(); };
document.getElementById('btnAgregarExtraDia').onclick=function(){ if(!isAdmin()) return alert('Solo Admin'); abrirExtra(); };
function abrirExtra(){ document.getElementById('backdropExtra').style.display='flex'; }
function cerrarExtra(){ document.getElementById('backdropExtra').style.display='none'; }
function confirmarExtra(){
  if(!isAdmin()) return alert('Solo Admin');
  const nombre = document.getElementById('extraNombre').value.trim();
  const jer = document.getElementById('extraJer').value.trim();
  const pab = document.getElementById('extraPab').value.trim();
  const obs = document.getElementById('extraObs').value.trim();
  extrasToday.push({ id:'extra_'+Date.now(), nombre:nombre, jerarquia:jer, pab:pab, obs:obs });
  cerrarExtra(); renderHoy(); showBanner('Extra agregado para este dia');
}

/* General / elegibles */
function generalList(){ return [].concat(db.personas).sort((a,b)=>a.order-b.order); }
function elegibles(){ return [].concat(db.personas).sort((a,b)=>(a.rorder||0)-(b.rorder||0)); }
let prioridadHoy = {}; // {id:'ART13'|'ART26'|'ART04'}

/* Plan del dia */
function getPlan(){
  var falt=Math.max(0, parseInt(faltEl.value||'0',10));
  var fecha=fechaEl.value;
  var base=elegibles();

  var prioIds=Object.keys(prioridadHoy);
  var pART = base.filter(p=> prioridadHoy[p.id]==='ART13' || prioridadHoy[p.id]==='ART26');
  var p04  = base.filter(p=> prioridadHoy[p.id]==='ART04');
  var resto= base.filter(p=> prioIds.indexOf(p.id)===-1);

  resto.sort(function(a,b){
    var da=(a.debeLista||0), dbb=(b.debeLista||0);
    if(dbb!==da) return dbb-da;
    return (a.rorder||0)-(b.rorder||0);
  });

  var mostrados=[], numerados=[];
  function pushPersona(p, forzarContar){
    var saltPorFlag = p.salteado===true;
    var saltar = !forzarContar && (p.obs.art || p.obs.autorizado || inLicencia(p,fecha) || saltPorFlag);
    mostrados.push({p:p, saltar:saltar, saltPorFlag:saltPorFlag});
    if(!saltar) numerados.push(p);
  }
  pART.forEach(p=>pushPersona(p,true));
  p04.forEach(p=>pushPersona(p,true));
  resto.forEach(p=>pushPersona(p,false));

  var asignados = numerados.slice(0,falt);
  var idxUlt=falt-1;
  var pasivos = (idxUlt>=0)? numerados.slice(idxUlt+1, idxUlt+3) : numerados.slice(0,2);

  return {mostrados:mostrados, asignados:asignados, pasivos:pasivos};
}

/* Modal acciones */
let modalId=null;
function openModal(id){
  if(!isAdmin()) return alert('Solo Admin');
  modalId=id; var p=getById(id);
  $qs(null,'#modalNombre').textContent = p? p.nombre : '';
  var L=p && p.obs? p.obs.licencia : null;
  $qs(null,'#licDesde').value = L && L.desde ? L.desde : '';
  $qs(null,'#licHasta').value = L && L.hasta ? L.hasta : '';
  $qs(null,'#backdrop').style.display='flex';
}
function closeModal(){ $qs(null,'#backdrop').style.display='none'; modalId=null; }
function modalSetArt(val){ if(!modalId) return; if(!isAdmin()) return alert('Solo Admin'); var p=getById(modalId); if(!p) return; p.obs.art = (val==='clear')? null : val; save(); renderHoy(); renderGeneral(); }
function modalSetLic(){ if(!modalId) return; if(!isAdmin()) return alert('Solo Admin'); var d=$qs(null,'#licDesde').value; var h=$qs(null,'#licHasta').value; if(!d||!h) return alert('Completar desde y hasta'); var p=getById(modalId); p.obs.licencia={desde:d,hasta:h}; save(); renderHoy(); renderGeneral(); alert('Licencia guardada'); }
function modalTogglePresente04(){ if(!modalId) return; if(!isAdmin()) return alert('Solo Admin'); var id=modalId; if(prioridadHoy[id]==='ART04') delete prioridadHoy[id]; else prioridadHoy[id]='ART04'; renderHoy(); }
function modalClearLic(){ if(!modalId) return; if(!isAdmin()) return alert('Solo Admin'); var p=getById(modalId); p.obs.licencia={desde:null,hasta:null}; save(); renderHoy(); renderGeneral(); alert('Licencia quitada'); }
function modalToggleAutorizado(){ if(!modalId) return; if(!isAdmin()) return alert('Solo Admin'); var p=getById(modalId); p.obs.autorizado=!p.obs.autorizado; save(); renderHoy(); renderGeneral(); }
function modalToggleSalteado(){ if(!modalId) return; if(!isAdmin()) return alert('Solo Admin'); var p=getById(modalId); p.salteado=!p.salteado; save(); renderHoy(); renderGeneral(); }

/* Estado pills */
function pill(text, cls, onclick){ return '<span class="pill '+(cls||'')+'" '+(onclick?('onclick="'+onclick+'" style="cursor:pointer"'):'')+'>'+text+'</span>'; }

/* Render del dia */
function renderHoy(){
  setTitulo();
  var fecha=fechaEl.value;
  var prev={};
  // conservar selecciones previas
  $all('#tablaDia tbody tr[data-id]').forEach(function(r){
    var id=r.getAttribute('data-id');
    var sel=r.querySelector('select'); var inp=r.querySelector('input[type="text"]');
    prev[id]={pab: sel?sel.value:'', obs: inp?inp.value:''};
  });

  var tb=$qs(null,'#tablaDia tbody'); tb.innerHTML=''; var n=0;

  // activar ART04 solo si es el dia posterior al fin de licencia
  db.personas.forEach(function(p){
    if(p && p.obs && p.obs.licencia && isDayAfter(p.obs.licencia.hasta, fecha)){
      if(!prioridadHoy[p.id]) prioridadHoy[p.id]='ART04';
    }
  });

  // EXTRAS (no numeran)
  extrasToday.forEach(function(ex){
    var tr=document.createElement('tr'); tr.setAttribute('data-id', ex.id);
    var numCell=document.createElement('td'); numCell.textContent='-'; tr.appendChild(numCell);
    tr.insertAdjacentHTML('beforeend', "<td>"+(ex.nombre || '')+"</td><td>"+(ex.jerarquia||'')+"</td>");
    var estadoCell=document.createElement('td'); estadoCell.innerHTML='<span class="muted">-</span>'; tr.appendChild(estadoCell);

    var pabSel=document.createElement('select');
    ['', 'Vigilancia','Pab 1','Pab 3S','Pab 3N','Pab 5S','Pab 5N','Pab 7','Pab 9','Pab 11','Pab Aisl','Cruz','Porton'].forEach(function(x){
      var opt=document.createElement('option'); opt.textContent=x; pabSel.appendChild(opt);
    });
    if(ex.pab) pabSel.value=ex.pab;
    var pabCell=document.createElement('td'); pabCell.appendChild(pabSel); tr.appendChild(pabCell);

    var obsInput=document.createElement('input'); obsInput.type='text'; obsInput.placeholder='observacion'; obsInput.value=ex.obs||''; var obsCell=document.createElement('td'); obsCell.appendChild(obsInput); tr.appendChild(obsCell);
    var acc=document.createElement('td'); acc.innerHTML="<span class='muted'>-</span>"; tr.appendChild(acc);
    tb.appendChild(tr);
  });

  var plan
